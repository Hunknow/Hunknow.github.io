<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
            .login-shadow { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
            .qa-item-user { @apply flex justify-start mb-4 animate-fadeIn; }
            .qa-content-user { @apply bg-gray-100 rounded-lg rounded-tl-none px-4 py-3 max-w-[80%] shadow-sm; }
            .qa-item-bot { @apply flex justify-end mb-4 animate-fadeIn; }
            .qa-content-bot { @apply bg-primary/10 rounded-lg rounded-tr-none px-4 py-3 max-w-[80%] shadow-sm border border-primary/20; }
            .pwd-toggle-btn { @apply absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-primary cursor-pointer z-10; }
            .clear-btn { @apply absolute inset-y-0 right-10 flex items-center text-gray-500 hover:text-red-500 cursor-pointer z-10; }
            .touchable { @apply min-h-[44px] flex items-center justify-center; }
            .loading-dot { @apply inline-block w-2 h-2 rounded-full bg-primary mx-0.5 animate-bounce; }
            .loading-dot:nth-child(2) { animation-delay: 0.2s; }
            .loading-dot:nth-child(3) { animation-delay: 0.4s; }
            .collect-btn { @apply text-gray-400 hover:text-yellow-500 transition-colors ml-2 cursor-pointer; }
            .collect-btn.active { @apply text-yellow-500; }
            .toast { @apply fixed bottom-6 left-1/2 -translate-x-1/2 bg-dark/80 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300 opacity-0 translate-y-4; }
            .toast.show { @apply opacity-100 translate-y-0; }
            .toast.error { @apply bg-red-500; }
            .admin-card { @apply bg-white rounded-xl shadow-lg p-6 mb-6; }
            .admin-table { @apply w-full text-sm text-left text-gray-700; }
            .admin-table thead { @apply text-xs text-gray-700 uppercase bg-gray-100; }
            .admin-table th { @apply px-4 py-3; }
            .admin-table td { @apply px-4 py-3 border-b border-gray-200; }
            .admin-table tr:hover { @apply bg-gray-50; }
            .user-row { @apply cursor-pointer transition-all hover:bg-blue-50; }
            .user-row.selected { @apply bg-blue-50 border-l-4 border-primary; }
            .stat-badge { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium; }
            .stat-badge.online { @apply bg-green-100 text-green-800; }
            .stat-badge.offline { @apply bg-gray-100 text-gray-800; }
            .time-cell { @apply font-mono text-xs; }
            .tab-button { @apply px-4 py-2 rounded-lg transition-colors; }
            .tab-button.active { @apply bg-primary text-white; }
            .tab-button.inactive { @apply bg-gray-200 text-gray-700 hover:bg-gray-300; }
            .detail-tab { @apply px-4 py-2 text-sm font-medium border-b-2 border-transparent cursor-pointer transition-colors; }
            .detail-tab.active { @apply text-primary border-primary; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0E7C7B',
                        secondary: '#41C9E2',
                        accent: '#A0D8B3',
                        dark: '#2C3E50',
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Microsoft YaHei', 'sans-serif'],
                    },
                    keyframes: {
                        fadeIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        },
                        shake: {
                            '0%,100%': { transform: 'translateX(0)' },
                            '20%,60%': { transform: 'translateX(-5px)' },
                            '40%,80%': { transform: 'translateX(5px)' }
                        }
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.3s ease-out',
                        'shake': 'shake 0.5s ease-in-out'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-cyan-50 to-green-50 text-dark min-h-screen">
    <!-- ç™»å½•æ³¨å†Œå¼¹çª— -->
    <div id="authPage" class="fixed inset-0 bg-dark/70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md login-shadow overflow-hidden transform transition-all duration-300">
            <div class="flex border-b border-gray-200">
                <button id="loginTab" class="flex-1 py-3 font-medium text-primary border-b-2 border-primary text-center transition-all touchable">
                    <i class="fa fa-sign-in mr-1"></i>ç™»å½•
                </button>
                <button id="registerTab" class="flex-1 py-3 font-medium text-gray-500 hover:text-primary text-center transition-all touchable">
                    <i class="fa fa-user-plus mr-1"></i>æ³¨å†Œ
                </button>
            </div>
            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm" class="p-6">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">ç”¨æˆ·ç™»å½•</h3>
                <div class="space-y-4">
                    <div>
                        <label for="loginPhone" class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æœºå·</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-phone"></i>
                            </span>
                            <input type="tel" id="loginPhone" placeholder="11ä½æ‰‹æœºå·" maxlength="11"
                                   class="pl-10 pr-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                            <i class="fa fa-times-circle clear-btn" onclick="clearInput('loginPhone')"></i>
                            <div id="loginPhoneTip" class="hidden text-red-500 text-sm mt-1">è¯·è¾“å…¥æœ‰æ•ˆ11ä½æ‰‹æœºå·</div>
                        </div>
                    </div>
                    <div>
                        <label for="loginPwd" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="loginPwd" placeholder="è‡³å°‘8ä½å¯†ç " maxlength="20"
                                   class="pl-10 pr-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                            <i class="fa fa-times-circle clear-btn" onclick="clearInput('loginPwd')"></i>
                            <span class="pwd-toggle-btn" onclick="togglePwd('loginPwd', this)">
                                <i class="fa fa-eye-slash"></i>
                            </span>
                            <div id="loginPwdTip" class="hidden text-red-500 text-sm mt-1">å¯†ç ä¸å°‘äº8ä½</div>
                        </div>
                    </div>
                    <div id="loginError" class="hidden text-red-500 text-sm text-center mt-1 py-2 bg-red-50 rounded-lg">æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯</div>
                    <button id="loginBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-colors touchable">ç™»å½•</button>
                    
                    <!-- ç®¡ç†å‘˜ç™»å½•æç¤º -->
                    <div class="text-center text-xs text-gray-500 mt-4 pt-4 border-t border-gray-200">
                        <p>ç®¡ç†å‘˜è´¦å·ï¼š18597123311 / Hm123321</p>
                    </div>
                </div>
            </div>
            <!-- æ³¨å†Œè¡¨å• -->
            <div id="registerForm" class="p-6 hidden">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">ç”¨æˆ·æ³¨å†Œ</h3>
                <div class="space-y-4">
                    <div>
                        <label for="regPhone" class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æœºå·</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-phone"></i>
                            </span>
                            <input type="tel" id="regPhone" placeholder="11ä½æ‰‹æœºå·" maxlength="11"
                                   class="pl-10 pr-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                            <i class="fa fa-times-circle clear-btn" onclick="clearInput('regPhone')"></i>
                            <div id="regPhoneTip" class="hidden text-red-500 text-sm mt-1">è¯·è¾“å…¥æœ‰æ•ˆ11ä½æ‰‹æœºå·</div>
                        </div>
                    </div>
                    <div>
                        <label for="regName" class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-user"></i>
                            </span>
                            <input type="text" id="regName" placeholder="1-20ä½ç”¨æˆ·å" maxlength="20"
                                   class="pl-10 pr-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                            <i class="fa fa-times-circle clear-btn" onclick="clearInput('regName')"></i>
                            <div id="regNameTip" class="hidden text-red-500 text-sm mt-1">ç”¨æˆ·åä¸èƒ½ä¸ºç©º</div>
                        </div>
                    </div>
                    <div>
                        <label for="regPwd" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="regPwd" placeholder="è‡³å°‘8ä½å¯†ç " maxlength="20"
                                   class="pl-10 pr-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                            <i class="fa fa-times-circle clear-btn" onclick="clearInput('regPwd')"></i>
                            <span class="pwd-toggle-btn" onclick="togglePwd('regPwd', this)">
                                <i class="fa fa-eye-slash"></i>
                            </span>
                            <div id="regPwdTip" class="hidden text-red-500 text-sm mt-1">å¯†ç ä¸å°‘äº8ä½</div>
                        </div>
                    </div>
                    <div>
                        <label for="regConfirmPwd" class="block text-sm font-medium text-gray-700 mb-1">ç¡®è®¤å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="regConfirmPwd" placeholder="å†æ¬¡è¾“å…¥å¯†ç " maxlength="20"
                                   class="pl-10 pr-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                            <i class="fa fa-times-circle clear-btn" onclick="clearInput('regConfirmPwd')"></i>
                            <span class="pwd-toggle-btn" onclick="togglePwd('regConfirmPwd', this)">
                                <i class="fa fa-eye-slash"></i>
                            </span>
                            <div id="regPwdMatchTip" class="hidden text-red-500 text-sm mt-1">ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´</div>
                        </div>
                    </div>
                    <div id="regSuccess" class="hidden text-green-500 text-sm text-center mt-1 py-2 bg-green-50 rounded-lg">æ³¨å†ŒæˆåŠŸï¼å³å°†è·³è½¬ç™»å½•</div>
                    <button id="regBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-colors touchable">æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜ç•Œé¢ -->
    <div id="adminPage" class="hidden min-h-screen">
        <!-- ç®¡ç†å‘˜é¡¶éƒ¨å¯¼èˆª -->
        <nav class="sticky top-0 bg-dark text-white z-40 shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class="fa fa-shield text-xl"></i>
                    <h1 class="text-xl font-bold">ç®¡ç†åå° - ç”¨æˆ·è¡Œä¸ºåˆ†æ</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span id="adminName" class="font-medium">ç®¡ç†å‘˜ï¼šadmin</span>
                    <button id="adminLogoutBtn" class="hover:text-accent transition-colors touchable">
                        <i class="fa fa-sign-out mr-1"></i>é€€å‡ºç®¡ç†
                    </button>
                </div>
            </div>
        </nav>

        <!-- ç®¡ç†å‘˜ä¸»å†…å®¹åŒº -->
        <div class="container mx-auto px-4 py-8">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="admin-card">
                    <div class="flex items-center">
                        <div class="bg-primary/10 p-3 rounded-lg mr-4">
                            <i class="fa fa-users text-primary text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">æ´»è·ƒç”¨æˆ·</p>
                            <p id="activeUsers" class="text-2xl font-bold text-primary">0</p>
                        </div>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="flex items-center">
                        <div class="bg-secondary/10 p-3 rounded-lg mr-4">
                            <i class="fa fa-sign-in text-secondary text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">æ€»ç™»å½•æ¬¡æ•°</p>
                            <p id="totalLogins" class="text-2xl font-bold text-secondary">0</p>
                        </div>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="flex items-center">
                        <div class="bg-accent/10 p-3 rounded-lg mr-4">
                            <i class="fa fa-clock-o text-accent text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">æ€»åœ¨çº¿æ—¶é•¿</p>
                            <p id="totalOnlineTime" class="text-2xl font-bold text-accent">0</p>
                        </div>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="flex items-center">
                        <div class="bg-purple-500/10 p-3 rounded-lg mr-4">
                            <i class="fa fa-bar-chart text-purple-500 text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">å¹³å‡æ—¶é•¿/æ¬¡</p>
                            <p id="avgSessionTime" class="text-2xl font-bold text-purple-500">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·è¡Œä¸ºåˆ†æ -->
            <div class="admin-card mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡</h2>
                    <div class="flex space-x-2">
                        <button id="viewWeekly" class="tab-button active">
                            <i class="fa fa-calendar-week mr-2"></i>æœ¬å‘¨ç»Ÿè®¡
                        </button>
                        <button id="viewMonthly" class="tab-button inactive">
                            <i class="fa fa-calendar mr-2"></i>æœ¬æœˆç»Ÿè®¡
                        </button>
                        <button id="viewAll" class="tab-button inactive">
                            <i class="fa fa-list mr-2"></i>å…¨éƒ¨æ•°æ®
                        </button>
                    </div>
                </div>
                
                <!-- å‘¨/æœˆç»Ÿè®¡è¯´æ˜ -->
                <div class="mb-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                    <i class="fa fa-info-circle mr-2"></i>
                    <span id="statsDescription">æ˜¾ç¤ºæœ¬å‘¨ï¼ˆä»æœ¬å‘¨ä¸€å¼€å§‹ï¼‰çš„ç”¨æˆ·ç™»å½•æ•°æ®</span>
                </div>
                
                <!-- ç”¨æˆ·è¡Œä¸ºè¡¨æ ¼ -->
                <div class="overflow-x-auto">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·</th>
                                <th>æ‰‹æœºå·</th>
                                <th>æ€»ç™»å½•æ¬¡æ•°</th>
                                <th>æ€»åœ¨çº¿æ—¶é•¿</th>
                                <th>å¹³å‡æ—¶é•¿/æ¬¡</th>
                                <th id="periodLoginsHeader">æœ¬å‘¨ç™»å½•</th>
                                <th id="periodAvgTimeHeader">æœ¬å‘¨å¹³å‡æ—¶é•¿</th>
                                <th>å½“å‰çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userBehaviorTable">
                            <!-- æ•°æ®é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ç”¨æˆ·è¯¦æƒ…é¢æ¿ -->
            <div id="userDetailPanel" class="admin-card hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-primary" id="detailUserName">ç”¨æˆ·è¯¦æƒ…</h2>
                        <p class="text-gray-600" id="detailUserPhone"></p>
                    </div>
                    <button id="closeDetail" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="fa fa-times mr-2"></i>å…³é—­è¯¦æƒ…
                    </button>
                </div>

                <!-- è¯¦æƒ…é¡µæ ‡ç­¾ -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="detailTabSessions" class="detail-tab active">ç™»å½•è®°å½•</button>
                    <button id="detailTabQA" class="detail-tab">é—®ç­”è®°å½•</button>
                </div>

                <!-- ç™»å½•è®°å½•é¢æ¿ -->
                <div id="detailSessionsPanel">
                    <!-- ç”¨æˆ·ç»Ÿè®¡æ¦‚è§ˆ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fa fa-sign-in text-blue-500 mr-2"></i>
                                <h3 class="font-medium">ç™»å½•ç»Ÿè®¡</h3>
                            </div>
                            <p class="text-2xl font-bold text-blue-600" id="detailTotalLogins">0</p>
                            <p class="text-sm text-gray-600">æ€»ç™»å½•æ¬¡æ•°</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fa fa-clock-o text-green-500 mr-2"></i>
                                <h3 class="font-medium">æ—¶é•¿ç»Ÿè®¡</h3>
                            </div>
                            <p class="text-2xl font-bold text-green-600" id="detailTotalTime">0</p>
                            <p class="text-sm text-gray-600">æ€»åœ¨çº¿æ—¶é•¿</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fa fa-bar-chart text-purple-500 mr-2"></i>
                                <h3 class="font-medium">å¹³å‡æ•°æ®</h3>
                            </div>
                            <p class="text-2xl font-bold text-purple-600" id="detailAvgTime">0</p>
                            <p class="text-sm text-gray-600">å¹³å‡æ¯æ¬¡æ—¶é•¿</p>
                        </div>
                    </div>

                    <!-- ç™»å½•è®°å½•è¡¨æ ¼ -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-4">è¯¦ç»†ç™»å½•è®°å½•</h3>
                        <div class="overflow-x-auto">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>åºå·</th>
                                        <th>ç™»å½•æ—¶é—´</th>
                                        <th>ç™»å‡ºæ—¶é—´</th>
                                        <th>ä¼šè¯æ—¶é•¿</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="userSessionTable">
                                    <!-- ç™»å½•è®°å½•é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- é—®ç­”è®°å½•é¢æ¿ -->
                <div id="detailQAPanel" class="hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-4">ç”¨æˆ·é—®ç­”è®°å½•</h3>
                        <div class="overflow-x-auto">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>åºå·</th>
                                        <th>æ—¶é—´</th>
                                        <th>é—®é¢˜</th>
                                        <th>å›ç­”</th>
                                    </tr>
                                </thead>
                                <tbody id="userQATable">
                                    <!-- é—®ç­”è®°å½•é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å‘¨/æœˆç»Ÿè®¡å›¾è¡¨ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="admin-card">
                    <h3 class="text-lg font-medium mb-4">æœ¬å‘¨æ´»è·ƒç”¨æˆ·è¶‹åŠ¿</h3>
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg text-sm">
                        <i class="fa fa-calendar mr-2"></i>
                        <span id="weeklyChartTitle">æœ¬å‘¨ï¼ˆä»æœ¬å‘¨ä¸€å¼€å§‹ï¼‰æ¯å¤©æ´»è·ƒç”¨æˆ·æ•°</span>
                    </div>
                    <div class="h-64">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
                <div class="admin-card">
                    <h3 class="text-lg font-medium mb-4">æœ¬æœˆç™»å½•æ¬¡æ•°ç»Ÿè®¡</h3>
                    <div class="mb-4 p-3 bg-green-50 rounded-lg text-sm">
                        <i class="fa fa-calendar mr-2"></i>
                        <span id="monthlyChartTitle">æœ¬æœˆï¼ˆä»æœ¬æœˆç¬¬ä¸€å¤©å¼€å§‹ï¼‰æ¯å‘¨ç™»å½•æ¬¡æ•°</span>
                    </div>
                    <div class="h-64">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™®é€šç”¨æˆ·ä¸»é¡µé¢ -->
    <div id="mainPage" class="hidden">
        <!-- é¡¶éƒ¨æ¨ªå¹… -->
        <header class="relative h-[40vh] min-h-[300px] bg-center bg-cover" style="background-image: url('https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80&sat=-30');">
            <div class="absolute inset-0 bg-gradient-to-t from-dark/70 to-dark/30 flex flex-col items-center justify-center text-white w-full">
                <h1 class="text-[clamp(1.8rem,4vw,3.5rem)] font-bold text-center text-shadow">ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”</h1>
                <p class="text-[clamp(1rem,2vw,1.5rem)] mt-3 text-center text-shadow">æ¢ç´¢ä¸­åæ°´å¡” Â· å®ˆæŠ¤é«˜åŸç”Ÿæ€</p>
                <div class="mt-4 text-white/80">
                    <i class="fa fa-mountain text-2xl"></i>
                    <i class="fa fa-water text-2xl mx-4"></i>
                    <i class="fa fa-leaf text-2xl"></i>
                </div>
            </div>
        </header>
        
        <!-- ç”¨æˆ·å¯¼èˆª -->
        <nav class="sticky top-0 bg-primary/90 backdrop-blur-sm text-white z-40 shadow-md">
            <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
                <div class="flex space-x-4 mb-2 md:mb-0">
                    <a href="#knowledge" class="hover:text-accent transition-colors font-medium">ç”Ÿæ€çŸ¥è¯†</a>
                    <a href="#qa" class="hover:text-accent transition-colors font-medium">æ™ºèƒ½é—®ç­”</a>
                    <a href="#collection" class="hover:text-accent transition-colors font-medium">æˆ‘çš„æ”¶è—</a>
                    <a href="#behavior" class="hover:text-accent transition-colors font-medium">æˆ‘çš„æ•°æ®</a>
                </div>
                <div class="flex items-center gap-3">
                    <!-- ç”¨æˆ·åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                    <div class="flex items-center mr-4">
                        <span class="relative flex h-3 w-3 mr-2">
                            <span id="onlinePing" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span id="onlineIndicator" class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                        <span class="text-sm" id="onlineStatus">åœ¨çº¿</span>
                    </div>
                    
                    <span id="userName" class="font-medium">æ¬¢è¿ä½ ï¼</span>
                    <button id="logoutBtn" class="hover:text-accent transition-colors touchable">
                        <i class="fa fa-sign-out"></i> é€€å‡º
                    </button>
                </div>
            </div>
        </nav>

        <!-- ç”¨æˆ·è¡Œä¸ºæ•°æ®åŒº -->
        <section id="behavior" class="py-10 bg-white/90 backdrop-blur-sm">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">æˆ‘çš„è¡Œä¸ºæ•°æ®</h2>
                
                <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 max-w-4xl mx-auto">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-sign-in text-blue-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">æ€»ç™»å½•æ¬¡æ•°</p>
                                <p id="userTotalLogins" class="text-2xl font-bold text-blue-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">ä»æ³¨å†Œè‡³ä»Šçš„ç´¯è®¡ç™»å½•æ¬¡æ•°</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-green-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-clock-o text-green-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">æ€»åœ¨çº¿æ—¶é•¿</p>
                                <p id="userTotalTime" class="text-2xl font-bold text-green-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">ç´¯è®¡åœ¨çº¿æ—¶é—´</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-purple-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-bar-chart text-purple-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">å¹³å‡æ—¶é•¿/æ¬¡</p>
                                <p id="userAvgTime" class="text-2xl font-bold text-purple-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">å¹³å‡æ¯æ¬¡ç™»å½•çš„åœ¨çº¿æ—¶é•¿</p>
                    </div>
                </div>

                <!-- å‘¨/æœˆç»Ÿè®¡ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <h3 class="font-medium text-lg mb-4 text-primary flex items-center">
                            <i class="fa fa-calendar-week mr-2"></i>æœ¬å‘¨ç»Ÿè®¡ï¼ˆä»æœ¬å‘¨ä¸€å¼€å§‹ï¼‰
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ç™»å½•æ¬¡æ•°</span>
                                <span class="font-medium" id="userWeeklyLogins">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">å¹³å‡æ—¶é•¿</span>
                                <span class="font-medium" id="userWeeklyAvgTime">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">æ´»è·ƒå¤©æ•°</span>
                                <span class="font-medium" id="userWeeklyActiveDays">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <h3 class="font-medium text-lg mb-4 text-primary flex items-center">
                            <i class="fa fa-calendar mr-2"></i>æœ¬æœˆç»Ÿè®¡ï¼ˆä»æœ¬æœˆç¬¬ä¸€å¤©å¼€å§‹ï¼‰
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ç™»å½•æ¬¡æ•°</span>
                                <span class="font-medium" id="userMonthlyLogins">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">å¹³å‡æ—¶é•¿</span>
                                <span class="font-medium" id="userMonthlyAvgTime">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">æ´»è·ƒå¤©æ•°</span>
                                <span class="font-medium" id="userMonthlyActiveDays">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘ç™»å½•è®°å½• -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 max-w-4xl mx-auto">
                    <h3 class="font-medium text-lg mb-4 text-primary flex items-center">
                        <i class="fa fa-history mr-2"></i>æœ€è¿‘ç™»å½•è®°å½•
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç™»å½•æ—¶é—´</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç™»å‡ºæ—¶é—´</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¼šè¯æ—¶é•¿</th>
                                </tr>
                            </thead>
                            <tbody id="userRecentSessions" class="divide-y divide-gray-200">
                                <!-- æœ€è¿‘ç™»å½•è®°å½•é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç”Ÿæ€çŸ¥è¯†åŒº -->
        <section id="knowledge" class="py-10 bg-white/90 backdrop-blur-sm">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">ä¸‰æ±Ÿæºå›½å®¶å…¬å›­æ ¸å¿ƒç”Ÿæ€æ•°æ®</h2>
                
                <!-- æ•°æ®æ¥æºè¯´æ˜ -->
                <div class="max-w-3xl mx-auto mb-6 p-3 bg-gray-50 rounded-lg text-xs text-gray-600">
                    <i class="fa fa-database mr-1"></i>
                    æ•°æ®æ¥æºï¼šä¸‰æ±Ÿæºå›½å®¶å…¬å›­ç®¡ç†å±€ï¼ˆ2023ï¼‰ã€ä¸­å›½ç§‘å­¦é™¢ã€é’æµ·çœç”Ÿæ€ç¯å¢ƒå…
                </div>
                
                <div class="grid md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                    
                    <!-- åŸºç¡€æ¦‚å†µ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-map-marker mr-2"></i>åœ°ç†æ¦‚å†µ
                        </h3>
                        <ul class="space-y-2 text-sm">
                            <li>ğŸ“ <strong>åœ°ç†ä½ç½®</strong>ï¼šé’æµ·çœå—éƒ¨ï¼Œé’è—é«˜åŸè…¹åœ°</li>
                            <li>ğŸ—ºï¸ <strong>æ¶µç›–èŒƒå›´</strong>ï¼šç‰æ ‘ã€æœæ´›ã€é»„å—ã€æµ·å—4å·åŠæ ¼å°”æœ¨å¸‚å”å¤æ‹‰å±±é•‡</li>
                            <li>ğŸ”ï¸ <strong>æµ·æ‹”èŒƒå›´</strong>ï¼š3335-6564ç±³ï¼ˆå¹³å‡4500ç±³ä»¥ä¸Šï¼‰</li>
                            <li>ğŸ“ <strong>ç»çº¬åº¦</strong>ï¼šä¸œç»89Â°45â€²â€”102Â°23â€²ï¼ŒåŒ—çº¬31Â°39â€²â€”36Â°12â€²</li>
                            <li>ğŸ’§ <strong>æ°´ç³»æ„æˆ</strong>ï¼šé•¿æ±Ÿæºã€é»„æ²³æºã€æ¾œæ²§æ±Ÿæº3å¤§å›­åŒº</li>
                            <li>ğŸŒ¿ <strong>æ€»é¢ç§¯</strong>ï¼š36.3ä¸‡å¹³æ–¹å…¬é‡Œï¼ˆä¿æŠ¤åŒºï¼‰<br>12.31ä¸‡å¹³æ–¹å…¬é‡Œï¼ˆå›½å®¶å…¬å›­ï¼‰</li>
                        </ul>
                    </div>
                    
                    <!-- ç”Ÿç‰©å¤šæ ·æ€§ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-paw mr-2"></i>ç”Ÿç‰©å¤šæ ·æ€§
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div><strong>ç‰©ç§æ€»æ•°</strong>ï¼šç»´ç®¡æ¤ç‰©2,238ç§ â€¢ è„Šæ¤åŠ¨ç‰©370ç§</div>
                            <div><strong>çç¨€æ¿’å±ç‰©ç§</strong>ï¼š
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>â€¢ å›½å®¶ä¸€çº§ä¿æŠ¤åŠ¨ç‰©ï¼š16ç§ï¼ˆé›ªè±¹ã€è—ç¾šç¾Šã€é‡ç‰¦ç‰›ç­‰ï¼‰</li>
                                    <li>â€¢ å›½å®¶äºŒçº§ä¿æŠ¤åŠ¨ç‰©ï¼š53ç§ï¼ˆè—åŸç¾šã€å²©ç¾Šã€è—ç‹ç­‰ï¼‰</li>
                                    <li>â€¢ ç‰¹æœ‰ç‰©ç§ï¼šé’æµ·æ¹–è£¸é²¤ç­‰37ç§</li>
                                </ul>
                            </div>
                            <div><strong>æ——èˆ°ç‰©ç§ç§ç¾¤</strong>ï¼š
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>â€¢ é›ªè±¹ï¼šï¼1,200åªï¼ˆå å…¨çƒ10%ï¼‰</li>
                                    <li>â€¢ è—ç¾šç¾Šï¼š7-8ä¸‡åªï¼ˆä»æ¿’å±åˆ°è¿‘å±ï¼‰</li>
                                    <li>â€¢ é»‘é¢ˆé¹¤ï¼šï¼2,000åªï¼ˆä¸»è¦ç¹æ®–åœ°ï¼‰</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”Ÿæ€ä»·å€¼ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-chart-line mr-2"></i>ç”Ÿæ€æœåŠ¡ä»·å€¼
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div>ğŸ’§ <strong>æ°´æºæ¶µå…»</strong>ï¼šå¹´å‡å¾„æµé‡600äº¿ç«‹æ–¹ç±³</div>
                            <div>ğŸŒŠ <strong>æ°´é‡è´¡çŒ®</strong>ï¼šé•¿æ±Ÿ25% â€¢ é»„æ²³49% â€¢ æ¾œæ²§æ±Ÿ15%</div>
                            <div>ğŸŒ³ <strong>ç¢³æ±‡åŠŸèƒ½</strong>ï¼šå¹´å›ºç¢³1200ä¸‡å¨</div>
                            <div>ğŸ›¡ï¸ <strong>æ°´åœŸä¿æŒ</strong>ï¼šå‡å°‘ä¾µèš€3.8äº¿å¨/å¹´</div>
                            <div>ğŸŒ¬ï¸ <strong>æ°”å€™è°ƒèŠ‚</strong>ï¼šå½±å“ä¸œäºšå­£é£ç³»ç»Ÿ</div>
                            <div>ğŸï¸ <strong>ç”Ÿæ€å±éšœ</strong>ï¼š"ä¸­åæ°´å¡”"å›½å®¶ç”Ÿæ€å®‰å…¨å±éšœ</div>
                        </div>
                    </div>
                    
                    <!-- ä¿æŠ¤æªæ–½ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-shield mr-2"></i>ä¿æŠ¤æªæ–½ä¸æˆæ•ˆ
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div>âœ… <strong>ç”Ÿæ€ä¿®å¤</strong>ï¼šæ²»ç†é»‘åœŸæ»©2.5ä¸‡kmÂ² â€¢ æ¢å¤æ¹¿åœ°1.6ä¸‡kmÂ²</div>
                            <div>âœ… <strong>é€€ç‰§è¿˜è‰</strong>ï¼šç¦ç‰§0.93äº¿äº© â€¢ ä¼‘ç‰§1.58äº¿äº©</div>
                            <div>âœ… <strong>ç”Ÿæ€ç§»æ°‘</strong>ï¼šç´¯è®¡æ¬è¿10.2ä¸‡äººï¼ˆ2005-2020ï¼‰</div>
                            <div>âœ… <strong>ç¤¾åŒºå…±ç®¡</strong>ï¼šè®¾ç«‹ç”Ÿæ€ç®¡æŠ¤å‘˜17,211ä¸ª</div>
                            <div>âœ… <strong>ç§‘ç ”ç›‘æµ‹</strong>ï¼šå»ºç«‹76ä¸ªç”Ÿæ€ç›‘æµ‹ç«™ç‚¹</div>
                            <div>âœ… <strong>æ³•æ²»ä¿éšœ</strong>ï¼šã€Šä¸‰æ±Ÿæºå›½å®¶å…¬å›­æ¡ä¾‹ã€‹å®æ–½</div>
                            <div>ğŸ“ˆ <strong>ä¿æŠ¤æˆæ•ˆ</strong>ï¼šè‰åœ°ç›–åº¦æé«˜11% â€¢ æ°´æºæ¶µå…»é‡å¢6%/å¹´</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- æ™ºèƒ½é—®ç­”åŒº -->
        <section id="qa" class="py-10 bg-gradient-to-b from-blue-50/50 to-transparent">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">æ™ºèƒ½é—®ç­”</h2>
                <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden backdrop-blur-sm">
                    <!-- ç®€åŒ–åçš„é—®ç­”ç•Œé¢ -->
                    <div class="bg-primary text-white p-3 flex justify-between items-center">
                        <div class="flex items-center">
                            <span>å…³äºä¸‰æ±Ÿæºï¼Œéšæ—¶æé—®</span>
                        </div>
                    </div>
                    
                    <div id="chatBox" class="p-4 h-[50vh] overflow-y-auto space-y-4">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fa fa-comment-o text-3xl mb-2"></i>
                            <p>è¾“å…¥é—®é¢˜ï¼Œè·å–ä¸“ä¸šå›ç­”</p>
                            <p class="text-xs mt-2">ä¸“æ³¨äºä¸‰æ±Ÿæºç”Ÿæ€ä¿æŠ¤ç›¸å…³é—®é¢˜</p>
                        </div>
                    </div>
                    <div class="p-3 border-t flex">
                        <input type="text" id="questionInput" placeholder="è¾“å…¥å…³äºä¸‰æ±Ÿæºç”Ÿæ€ä¿æŠ¤çš„é—®é¢˜ï¼ˆæœ€å¤š100å­—ï¼‰" maxlength="100"
                               class="flex-1 px-3 py-2 rounded-l-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        <button id="sendBtn" class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary/90 transition-colors touchable">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- é—®é¢˜å»ºè®® -->
                <div class="mt-6 max-w-2xl mx-auto">
                    <h3 class="text-sm font-medium text-gray-600 mb-2">æ‚¨å¯ä»¥æé—®ï¼š</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºæœ‰å“ªäº›çç¨€ç‰©ç§ï¼Ÿ')">çç¨€ç‰©ç§</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('å¦‚ä½•ä¿æŠ¤ä¸‰æ±Ÿæºç”Ÿæ€ç¯å¢ƒï¼Ÿ')">ä¿æŠ¤æªæ–½</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºä¸ºä»€ä¹ˆå«ä¸­åæ°´å¡”ï¼Ÿ')">ä¸­åæ°´å¡”</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºçš„æ°”å€™ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ')">æ°”å€™ç‰¹ç‚¹</button>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="collection" class="py-10 bg-gradient-to-b from-green-50/50 to-transparent">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">æˆ‘çš„æ”¶è—</h2>
                <div id="collectionBox" class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-5 min-h-[200px] backdrop-blur-sm">
                    <div class="text-center text-gray-400 py-8" id="emptyCollection">
                        <i class="fa fa-star-o text-3xl mb-2"></i>
                        <p>æš‚æ— æ”¶è—ï¼Œç‚¹å‡»å›ç­”æ—â­æ”¶è—</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- åº•éƒ¨ -->
        <footer class="bg-dark text-white py-6 mt-auto">
            <div class="container mx-auto px-4 text-center text-sm">
                <p>ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”å¹³å° | ä»…ä¾›å­¦ä¹ æ¼”ç¤º</p>
                <p class="text-gray-400 mt-1">ä¿æŠ¤ä¸­åæ°´å¡”ï¼Œäººäººæœ‰è´£</p>
            </div>
        </footer>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast" class="toast"></div>

    <script>
        // ========== å¸¸é‡å®šä¹‰ ==========
        const ADMIN_PHONE = '18597123311';
        const ADMIN_NAME = 'admin';
        const ADMIN_PASSWORD = 'Hm123321';
        
        // ========== è·¨æµè§ˆå™¨å…¼å®¹çš„æ•°æ®é”® ==========
        const STORAGE_KEYS = {
            USER_DB: 'sanjiangyuan_userDB',
            QA_DB: 'sanjiangyuan_qaDB',
            COLLECT_DB: 'sanjiangyuan_collectDB',
            BEHAVIOR_DB: 'sanjiangyuan_behaviorDB',
            CURRENT_USER: 'sanjiangyuan_currentUser',
            IS_ADMIN_MODE: 'sanjiangyuan_isAdminMode',
            CURRENT_SESSION: 'sanjiangyuan_currentSession',
            APP_VERSION: 'sanjiangyuan_appVersion'
        };
        
        // ========== æ•°æ®å­˜å‚¨ç»“æ„ ==========
        // userDB: {phone: {name, pwd, isAdmin, createTime}}
        // userBehaviorDB: {phone: {sessions: [{loginTime, logoutTime, duration}], stats: {...}}}
        // qaDB: {phone: [{question, answer, time}]}
        
        // ========== DOMç¼“å­˜ ==========
        const DOM = {
            // é¡µé¢å®¹å™¨
            authPage: document.getElementById('authPage'),
            mainPage: document.getElementById('mainPage'),
            adminPage: document.getElementById('adminPage'),
            
            // åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨
            onlinePing: document.getElementById('onlinePing'),
            onlineIndicator: document.getElementById('onlineIndicator'),
            onlineStatus: document.getElementById('onlineStatus'),
            
            // ç™»å½•æ³¨å†Œç›¸å…³
            loginTab: document.getElementById('loginTab'),
            registerTab: document.getElementById('registerTab'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            loginBtn: document.getElementById('loginBtn'),
            regBtn: document.getElementById('regBtn'),
            
            // ç”¨æˆ·ç›¸å…³
            logoutBtn: document.getElementById('logoutBtn'),
            userName: document.getElementById('userName'),
            
            // ç®¡ç†å‘˜ç›¸å…³
            adminLogoutBtn: document.getElementById('adminLogoutBtn'),
            adminName: document.getElementById('adminName'),
            closeDetail: document.getElementById('closeDetail'),
            userDetailPanel: document.getElementById('userDetailPanel'),
            
            // ç®¡ç†å‘˜è§†å›¾åˆ‡æ¢
            viewWeekly: document.getElementById('viewWeekly'),
            viewMonthly: document.getElementById('viewMonthly'),
            viewAll: document.getElementById('viewAll'),
            statsDescription: document.getElementById('statsDescription'),
            periodLoginsHeader: document.getElementById('periodLoginsHeader'),
            periodAvgTimeHeader: document.getElementById('periodAvgTimeHeader'),
            
            // ç»Ÿè®¡æ˜¾ç¤º
            activeUsers: document.getElementById('activeUsers'),
            totalLogins: document.getElementById('totalLogins'),
            totalOnlineTime: document.getElementById('totalOnlineTime'),
            avgSessionTime: document.getElementById('avgSessionTime'),
            
            // ç”¨æˆ·è¡Œä¸ºè¡¨æ ¼
            userBehaviorTable: document.getElementById('userBehaviorTable'),
            
            // ç”¨æˆ·è¯¦æƒ…é¢æ¿
            detailUserName: document.getElementById('detailUserName'),
            detailUserPhone: document.getElementById('detailUserPhone'),
            detailTotalLogins: document.getElementById('detailTotalLogins'),
            detailTotalTime: document.getElementById('detailTotalTime'),
            detailAvgTime: document.getElementById('detailAvgTime'),
            userSessionTable: document.getElementById('userSessionTable'),
            userQATable: document.getElementById('userQATable'),
            
            // è¯¦æƒ…é¡µæ ‡ç­¾
            detailTabSessions: document.getElementById('detailTabSessions'),
            detailTabQA: document.getElementById('detailTabQA'),
            detailSessionsPanel: document.getElementById('detailSessionsPanel'),
            detailQAPanel: document.getElementById('detailQAPanel'),
            
            // ç”¨æˆ·ä¸ªäººæ•°æ®
            userTotalLogins: document.getElementById('userTotalLogins'),
            userTotalTime: document.getElementById('userTotalTime'),
            userAvgTime: document.getElementById('userAvgTime'),
            userWeeklyLogins: document.getElementById('userWeeklyLogins'),
            userWeeklyAvgTime: document.getElementById('userWeeklyAvgTime'),
            userWeeklyActiveDays: document.getElementById('userWeeklyActiveDays'),
            userMonthlyLogins: document.getElementById('userMonthlyLogins'),
            userMonthlyAvgTime: document.getElementById('userMonthlyAvgTime'),
            userMonthlyActiveDays: document.getElementById('userMonthlyActiveDays'),
            userRecentSessions: document.getElementById('userRecentSessions'),
            
            // å›¾è¡¨ç›¸å…³
            weeklyChartTitle: document.getElementById('weeklyChartTitle'),
            monthlyChartTitle: document.getElementById('monthlyChartTitle'),
            weeklyChart: document.getElementById('weeklyChart'),
            monthlyChart: document.getElementById('monthlyChart'),
            
            // é—®ç­”ç›¸å…³
            questionInput: document.getElementById('questionInput'),
            sendBtn: document.getElementById('sendBtn'),
            chatBox: document.getElementById('chatBox'),
            
            // å…¶ä»–
            toast: document.getElementById('toast')
        };

        // ========== å…¨å±€å˜é‡ ==========
        let userDB = {};
        let qaDB = {};
        let collectDB = {};
        let userBehaviorDB = {};
        let currentUser = null;
        let isAdminMode = false;
        let currentSession = null;
        let currentViewMode = 'weekly'; // 'weekly', 'monthly', 'all'
        let selectedUserPhone = null;
        let userCharts = {};
        let onlineCheckInterval = null;

        // ========== è·¨æµè§ˆå™¨æ•°æ®å…¼å®¹å¤„ç† ==========
        function loadDataWithCompatibility() {
            console.log('åŠ è½½æ•°æ®ï¼ˆè·¨æµè§ˆå™¨å…¼å®¹å¤„ç†ï¼‰...');
            
            // å°è¯•ä»æ–°é”®ååŠ è½½
            try {
                userDB = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER_DB)) || {};
                qaDB = JSON.parse(localStorage.getItem(STORAGE_KEYS.QA_DB)) || {};
                collectDB = JSON.parse(localStorage.getItem(STORAGE_KEYS.COLLECT_DB)) || {};
                userBehaviorDB = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIOR_DB)) || {};
                currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER)) || null;
                isAdminMode = JSON.parse(localStorage.getItem(STORAGE_KEYS.IS_ADMIN_MODE)) || false;
                currentSession = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_SESSION)) || null;
                
                // å¦‚æœæ–°é”®åä¸ºç©ºï¼Œå°è¯•ä»æ—§é”®åè¿ç§»
                if (Object.keys(userDB).length === 0) {
                    const oldUserDB = JSON.parse(localStorage.getItem('userDB'));
                    if (oldUserDB && Object.keys(oldUserDB).length > 0) {
                        userDB = oldUserDB;
                        localStorage.setItem(STORAGE_KEYS.USER_DB, JSON.stringify(userDB));
                    }
                }
                
                if (Object.keys(qaDB).length === 0) {
                    const oldQaDB = JSON.parse(localStorage.getItem('qaDB'));
                    if (oldQaDB && Object.keys(oldQaDB).length > 0) {
                        qaDB = oldQaDB;
                        localStorage.setItem(STORAGE_KEYS.QA_DB, JSON.stringify(qaDB));
                    }
                }
                
                // è¿ç§»å…¶ä»–æ—§æ•°æ®...
                const oldKeys = ['collectDB', 'userBehaviorDB', 'currentUser', 'isAdminMode', 'currentSession'];
                oldKeys.forEach(key => {
                    const oldData = localStorage.getItem(key);
                    if (oldData) {
                        const newKey = STORAGE_KEYS[key.toUpperCase()];
                        if (newKey && !localStorage.getItem(newKey)) {
                            localStorage.setItem(newKey, oldData);
                        }
                    }
                });
                
                // æ¸…ç†æ—§é”®å
                oldKeys.forEach(key => localStorage.removeItem(key));
                
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥ï¼Œé‡ç½®ä¸ºåˆå§‹çŠ¶æ€:', error);
                userDB = {};
                qaDB = {};
                collectDB = {};
                userBehaviorDB = {};
                currentUser = null;
                isAdminMode = false;
                currentSession = null;
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEYS.USER_DB, JSON.stringify(userDB));
                localStorage.setItem(STORAGE_KEYS.QA_DB, JSON.stringify(qaDB));
                localStorage.setItem(STORAGE_KEYS.COLLECT_DB, JSON.stringify(collectDB));
                localStorage.setItem(STORAGE_KEYS.BEHAVIOR_DB, JSON.stringify(userBehaviorDB));
                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                localStorage.setItem(STORAGE_KEYS.IS_ADMIN_MODE, JSON.stringify(isAdminMode));
                localStorage.setItem(STORAGE_KEYS.CURRENT_SESSION, JSON.stringify(currentSession));
                localStorage.setItem(STORAGE_KEYS.APP_VERSION, '1.1.0');
            } catch (error) {
                console.error('æ•°æ®ä¿å­˜å¤±è´¥:', error);
                showToast('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­˜å‚¨ç©ºé—´', 'error');
            }
        }

        function saveBehaviorData() {
            localStorage.setItem(STORAGE_KEYS.BEHAVIOR_DB, JSON.stringify(userBehaviorDB));
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function formatDuration(seconds) {
            if (!seconds || seconds < 0) return '0ç§’';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†${secs}ç§’`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }

        function formatTimeShort(seconds) {
            if (!seconds || seconds < 0) return '0ç§’';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}æ—¶${minutes}åˆ†`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            return moment(timestamp).format('YYYY-MM-DD HH:mm:ss');
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            return moment(timestamp).format('MM-DD HH:mm');
        }

        // ========== æ”¹è¿›çš„æ—¶é—´èŒƒå›´è®¡ç®—å‡½æ•° ==========
        function getCurrentWeekRange() {
            const now = moment();
            const startOfWeek = now.clone().startOf('isoWeek'); // ISOæ ‡å‡†ï¼šå‘¨ä¸€å¼€å§‹
            const endOfWeek = now.clone().endOf('isoWeek');     // å‘¨æ—¥ç»“æŸ
            
            return {
                start: startOfWeek.valueOf(),
                end: endOfWeek.valueOf(),
                startDate: startOfWeek.format('YYYY-MM-DD'),
                endDate: endOfWeek.format('YYYY-MM-DD')
            };
        }

        function getCurrentMonthRange() {
            const now = moment();
            const startOfMonth = now.clone().startOf('month');
            const endOfMonth = now.clone().endOf('month');
            
            return {
                start: startOfMonth.valueOf(),
                end: endOfMonth.valueOf(),
                startDate: startOfMonth.format('YYYY-MM-DD'),
                endDate: endOfMonth.format('YYYY-MM-DD')
            };
        }

        // ========== æ”¹è¿›çš„åœ¨çº¿çŠ¶æ€ç®¡ç† ==========
        function startOnlineStatusMonitoring() {
            if (onlineCheckInterval) {
                clearInterval(onlineCheckInterval);
            }
            
            onlineCheckInterval = setInterval(() => {
                if (currentUser && !isAdminMode && currentSession) {
                    const now = Date.now();
                    const loginTime = currentSession.loginTime;
                    const elapsed = Math.floor((now - loginTime) / 1000);
                    
                    // æ›´æ–°å½“å‰ä¼šè¯æ—¶é•¿
                    currentSession.duration = elapsed;
                    localStorage.setItem(STORAGE_KEYS.CURRENT_SESSION, JSON.stringify(currentSession));
                    
                    // æ›´æ–°åœ¨çº¿æ—¶é•¿æ˜¾ç¤º
                    if (DOM.onlineStatus) {
                        DOM.onlineStatus.textContent = `åœ¨çº¿ ${formatTimeShort(elapsed)}`;
                    }
                    
                    // æ›´æ–°ç”¨æˆ·è¡Œä¸ºæ•°æ®åº“ä¸­çš„æœ€æ–°ä¼šè¯
                    if (userBehaviorDB[currentUser.phone] && userBehaviorDB[currentUser.phone].sessions.length > 0) {
                        const lastSession = userBehaviorDB[currentUser.phone].sessions[userBehaviorDB[currentUser.phone].sessions.length - 1];
                        if (!lastSession.logoutTime) {
                            lastSession.duration = elapsed;
                            saveBehaviorData();
                        }
                    }
                    
                    // æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡é¡µé¢ä¸Šçš„æ€»æ—¶é•¿
                    if (elapsed % 300 === 0) {
                        updateUserDataDisplay();
                    }
                } else if (currentUser && !isAdminMode) {
                    // ç”¨æˆ·å·²ç™»å½•ä½†æ²¡æœ‰ä¼šè¯ï¼Œè§†ä¸ºç¦»çº¿
                    setOfflineStatus();
                }
            }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        function setOfflineStatus() {
            if (DOM.onlinePing) DOM.onlinePing.classList.add('hidden');
            if (DOM.onlineIndicator) DOM.onlineIndicator.classList.remove('bg-green-500');
            if (DOM.onlineIndicator) DOM.onlineIndicator.classList.add('bg-gray-400');
            if (DOM.onlineStatus) DOM.onlineStatus.textContent = 'ç¦»çº¿';
        }

        function setOnlineStatus() {
            if (DOM.onlinePing) DOM.onlinePing.classList.remove('hidden');
            if (DOM.onlineIndicator) DOM.onlineIndicator.classList.remove('bg-gray-400');
            if (DOM.onlineIndicator) DOM.onlineIndicator.classList.add('bg-green-500');
            if (DOM.onlineStatus) DOM.onlineStatus.textContent = 'åœ¨çº¿';
        }

        // ========== ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡å‡½æ•° ==========
        function initUserBehavior(phone) {
            if (!userBehaviorDB[phone]) {
                userBehaviorDB[phone] = {
                    sessions: [],
                    stats: {
                        totalLogins: 0,
                        totalDuration: 0,
                        lastLogin: null,
                        lastLogout: null
                    }
                };
                saveBehaviorData();
            }
        }

        function recordLogin(phone) {
            initUserBehavior(phone);
            
            const loginTime = Date.now();
            currentSession = {
                phone: phone,
                loginTime: loginTime,
                logoutTime: null,
                duration: 0
            };
            
            // æ›´æ–°æ€»ç»Ÿè®¡
            userBehaviorDB[phone].stats.totalLogins++;
            userBehaviorDB[phone].stats.lastLogin = loginTime;
            
            // è®°å½•æ–°ä¼šè¯
            userBehaviorDB[phone].sessions.push({
                loginTime: loginTime,
                logoutTime: null,
                duration: 0
            });
            
            saveBehaviorData();
            localStorage.setItem(STORAGE_KEYS.CURRENT_SESSION, JSON.stringify(currentSession));
            
            // è®¾ç½®åœ¨çº¿çŠ¶æ€
            setOnlineStatus();
            
            console.log(`ç”¨æˆ· ${phone} ç™»å½•ï¼Œæ—¶é—´: ${formatDateTime(loginTime)}`);
        }

        function recordLogout(phone) {
            if (!currentSession || currentSession.phone !== phone) return;
            
            const logoutTime = Date.now();
            const loginTime = currentSession.loginTime;
            const duration = Math.floor((logoutTime - loginTime) / 1000);
            
            // æ›´æ–°å½“å‰ä¼šè¯
            currentSession.logoutTime = logoutTime;
            currentSession.duration = duration;
            
            // æ›´æ–°ç”¨æˆ·è¡Œä¸ºæ•°æ®
            const userBehavior = userBehaviorDB[phone];
            if (userBehavior && userBehavior.sessions.length > 0) {
                const lastSession = userBehavior.sessions[userBehavior.sessions.length - 1];
                lastSession.logoutTime = logoutTime;
                lastSession.duration = duration;
                
                userBehavior.stats.totalDuration += duration;
                userBehavior.stats.lastLogout = logoutTime;
            }
            
            saveBehaviorData();
            localStorage.removeItem(STORAGE_KEYS.CURRENT_SESSION);
            currentSession = null;
            
            // è®¾ç½®ç¦»çº¿çŠ¶æ€
            setOfflineStatus();
            
            console.log(`ç”¨æˆ· ${phone} ç™»å‡ºï¼Œæ—¶é•¿: ${formatDuration(duration)}`);
        }

        // ========== æ”¹è¿›çš„å‘¨æœŸç»Ÿè®¡è®¡ç®—å‡½æ•° ==========
        function calculatePeriodStats(phone, period) {
            if (!userBehaviorDB[phone] || !userBehaviorDB[phone].sessions) {
                return { logins: 0, totalDuration: 0, avgDuration: 0, activeDays: 0 };
            }
            
            const sessions = userBehaviorDB[phone].sessions;
            let periodLogins = 0;
            let periodDuration = 0;
            const activeDays = new Set();
            
            let timeRange;
            if (period === 'weekly') {
                timeRange = getCurrentWeekRange();
            } else if (period === 'monthly') {
                timeRange = getCurrentMonthRange();
            } else {
                // å…¨éƒ¨æ•°æ®æ¨¡å¼ - è¿”å›ç©ºæ—¶é—´èŒƒå›´
                timeRange = { start: 0, end: Date.now() };
            }
            
            // æ”¹è¿›çš„ä¼šè¯è¿‡æ»¤é€»è¾‘
            sessions.forEach(session => {
                // ä»…è®¡ç®—å·²å®Œæˆçš„ä¼šè¯ï¼ˆæœ‰ç™»å‡ºæ—¶é—´çš„ï¼‰
                if (!session.logoutTime || session.duration <= 0) {
                    return;
                }
                
                // åˆ¤æ–­ä¼šè¯æ˜¯å¦åœ¨å½“å‰å‘¨æœŸå†…ï¼ˆç™»å½•æˆ–ç™»å‡ºæ—¶é—´åœ¨å‘¨æœŸå†…ï¼‰
                const loginInPeriod = session.loginTime >= timeRange.start && session.loginTime <= timeRange.end;
                const logoutInPeriod = session.logoutTime >= timeRange.start && session.logoutTime <= timeRange.end;
                const sessionCrossPeriod = session.loginTime < timeRange.start && session.logoutTime > timeRange.start;
                
                if (loginInPeriod || logoutInPeriod || sessionCrossPeriod) {
                    periodLogins++;
                    
                    // è®¡ç®—åœ¨å‘¨æœŸå†…çš„å®é™…æ—¶é•¿
                    let sessionDurationInPeriod = session.duration;
                    
                    // å¦‚æœä¼šè¯è·¨å‘¨æœŸï¼Œåªè®¡ç®—åœ¨å‘¨æœŸå†…çš„éƒ¨åˆ†
                    if (sessionCrossPeriod) {
                        const periodStartTime = timeRange.start;
                        const sessionEndTime = Math.min(session.logoutTime, timeRange.end);
                        sessionDurationInPeriod = Math.max(0, Math.floor((sessionEndTime - periodStartTime) / 1000));
                    }
                    
                    periodDuration += sessionDurationInPeriod;
                    
                    // è®°å½•æ´»è·ƒå¤©æ•°ï¼ˆåŸºäºç™»å½•æ—¶é—´ï¼‰
                    const loginDate = moment(session.loginTime).format('YYYY-MM-DD');
                    activeDays.add(loginDate);
                }
            });
            
            const avgDuration = periodLogins > 0 ? Math.round(periodDuration / periodLogins) : 0;
            
            return {
                logins: periodLogins,
                totalDuration: periodDuration,
                avgDuration: avgDuration,
                activeDays: activeDays.size
            };
        }

        // ========== æ”¹è¿›çš„ç”¨æˆ·ç»Ÿè®¡å‡½æ•° ==========
        function getUserStats(phone) {
            if (!userBehaviorDB[phone]) {
                return {
                    totalLogins: 0,
                    totalDuration: 0,
                    avgDuration: 0,
                    weeklyLogins: 0,
                    weeklyAvgDuration: 0,
                    weeklyActiveDays: 0,
                    monthlyLogins: 0,
                    monthlyAvgDuration: 0,
                    monthlyActiveDays: 0,
                    isOnline: false
                };
            }
            
            const behavior = userBehaviorDB[phone];
            const sessions = behavior.sessions || [];
            
            // è®¡ç®—æ€»ç»Ÿè®¡ï¼ˆä»…è®¡ç®—å·²å®Œæˆçš„ä¼šè¯ï¼‰
            const completedSessions = sessions.filter(s => s.logoutTime && s.duration > 0);
            const totalLogins = completedSessions.length;
            const totalDuration = completedSessions.reduce((sum, session) => sum + (session.duration || 0), 0);
            const avgDuration = totalLogins > 0 ? Math.round(totalDuration / totalLogins) : 0;
            
            // è®¡ç®—å‘¨ç»Ÿè®¡
            const weeklyStats = calculatePeriodStats(phone, 'weekly');
            
            // è®¡ç®—æœˆç»Ÿè®¡
            const monthlyStats = calculatePeriodStats(phone, 'monthly');
            
            // åœ¨çº¿çŠ¶æ€
            const isOnline = !!currentSession && currentSession.phone === phone;
            
            return {
                totalLogins: totalLogins,
                totalDuration: totalDuration,
                avgDuration: avgDuration,
                weeklyLogins: weeklyStats.logins,
                weeklyAvgDuration: weeklyStats.avgDuration,
                weeklyActiveDays: weeklyStats.activeDays,
                monthlyLogins: monthlyStats.logins,
                monthlyAvgDuration: monthlyStats.avgDuration,
                monthlyActiveDays: monthlyStats.activeDays,
                isOnline: isOnline
            };
        }

        function getRecentSessions(phone, limit = 10) {
            if (!userBehaviorDB[phone] || !userBehaviorDB[phone].sessions) {
                return [];
            }
            
            return userBehaviorDB[phone].sessions
                .filter(session => session.logoutTime) // åªæ˜¾ç¤ºå·²å®Œæˆçš„ä¼šè¯
                .sort((a, b) => b.loginTime - a.loginTime)
                .slice(0, limit);
        }

        // ========== æ”¹è¿›çš„ç®¡ç†å‘˜ç»Ÿè®¡å‡½æ•° ==========
        function getAdminStats() {
            let activeUsers = 0;
            let totalLogins = 0;
            let totalDuration = 0;
            let activeUserCount = 0;
            
            Object.keys(userBehaviorDB).forEach(phone => {
                if (phone === ADMIN_PHONE) return; // æ’é™¤ç®¡ç†å‘˜
                
                const stats = getUserStats(phone);
                totalLogins += stats.totalLogins;
                totalDuration += stats.totalDuration;
                
                if (stats.totalLogins > 0) {
                    activeUserCount++;
                }
                
                if (stats.isOnline) {
                    activeUsers++;
                }
            });
            
            const avgSessionTime = totalLogins > 0 ? Math.round(totalDuration / totalLogins) : 0;
            
            return {
                activeUsers: activeUsers,
                totalLogins: totalLogins,
                totalDuration: totalDuration,
                avgSessionTime: avgSessionTime,
                activeUserCount: activeUserCount
            };
        }

        // ========== å›¾è¡¨æ•°æ®è®¡ç®—å‡½æ•° ==========
        function getWeeklyChartData() {
            const weekRange = getCurrentWeekRange();
            const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            const activeUsers = [0, 0, 0, 0, 0, 0, 0];
            
            // è®¡ç®—æ¯å¤©æ´»è·ƒç”¨æˆ·æ•°
            Object.keys(userBehaviorDB).forEach(phone => {
                if (phone === ADMIN_PHONE) return;
                
                const sessions = userBehaviorDB[phone].sessions || [];
                sessions.forEach(session => {
                    if (session.loginTime >= weekRange.start && session.loginTime <= weekRange.end) {
                        const dayIndex = moment(session.loginTime).day(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
                        const adjustedIndex = dayIndex === 0 ? 6 : dayIndex - 1; // è°ƒæ•´ä¸º0=å‘¨ä¸€, 6=å‘¨æ—¥
                        activeUsers[adjustedIndex]++;
                    }
                });
            });
            
            return { labels: days, data: activeUsers };
        }

        function getMonthlyChartData() {
            const monthRange = getCurrentMonthRange();
            const now = moment();
            const daysInMonth = now.daysInMonth(); // æœ¬æœˆæ€»å¤©æ•°
            const weeksInMonth = Math.ceil(daysInMonth / 7); // è®¡ç®—æœ¬æœˆæœ‰å‡ å‘¨ï¼ˆåŒ…å«ç¬¬5å‘¨ï¼‰
            const weekLabels = [];
            const loginsData = [];
            
            // ç¡®ä¿æœ€å¤šæœ‰5å‘¨
            const maxWeeks = Math.min(weeksInMonth, 5);
            for (let i = 1; i <= maxWeeks; i++) {
                weekLabels.push(`ç¬¬${i}å‘¨`);
                loginsData.push(0);
            }
            
            // è®¡ç®—æ¯å‘¨ç™»å½•æ¬¡æ•°
            Object.keys(userBehaviorDB).forEach(phone => {
                if (phone === ADMIN_PHONE) return;
                
                const sessions = userBehaviorDB[phone].sessions || [];
                sessions.forEach(session => {
                    if (session.loginTime >= monthRange.start && session.loginTime <= monthRange.end) {
                        const sessionDate = moment(session.loginTime);
                        const dayOfMonth = sessionDate.date(); // è·å–æ—¥æœŸï¼ˆ1-31ï¼‰
                        const weekOfMonth = Math.min(Math.ceil(dayOfMonth / 7), maxWeeks) - 1; // 0-based indexï¼Œç¡®ä¿ä¸è¶…è¿‡æœ€å¤§å‘¨æ•°
                        if (weekOfMonth >= 0 && weekOfMonth < maxWeeks) {
                            loginsData[weekOfMonth]++;
                        }
                    }
                });
            });
            
            return { labels: weekLabels.slice(0, maxWeeks), data: loginsData.slice(0, maxWeeks) };
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        function initAdminAccount() {
            if (!userDB[ADMIN_PHONE]) {
                userDB[ADMIN_PHONE] = {
                    name: ADMIN_NAME,
                    pwd: ADMIN_PASSWORD,
                    isAdmin: true,
                    createTime: Date.now()
                };
                saveData();
            }
            
            initUserBehavior(ADMIN_PHONE);
        }

        // ========== åˆå§‹åŒ–é¡µé¢æ˜¾ç¤º ==========
        async function initPageDisplay() {
            console.log('åˆå§‹åŒ–é¡µé¢æ˜¾ç¤º...');
            
            // åŠ è½½æ•°æ®ï¼ˆè·¨æµè§ˆå™¨å…¼å®¹ï¼‰
            loadDataWithCompatibility();
            
            // é¦–å…ˆç¡®ä¿æ‰€æœ‰é¡µé¢éƒ½éšè—
            if (DOM.authPage) DOM.authPage.classList.add('hidden');
            if (DOM.mainPage) DOM.mainPage.classList.add('hidden');
            if (DOM.adminPage) DOM.adminPage.classList.add('hidden');
            
            // åˆå§‹åŒ–ç®¡ç†å‘˜è´¦å·
            initAdminAccount();
            
            // æ¸…ç©ºè¡¨å•
            clearLoginForm();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å·²ç™»å½•çš„ç”¨æˆ·
            if (currentUser) {
                if (isAdminMode) {
                    // ç®¡ç†å‘˜æ¨¡å¼
                    console.log('æ£€æµ‹åˆ°ç®¡ç†å‘˜å·²ç™»å½•');
                    if (DOM.adminPage) DOM.adminPage.classList.remove('hidden');
                    if (DOM.adminName) DOM.adminName.textContent = `ç®¡ç†å‘˜ï¼š${currentUser.name}`;
                    loadAdminData();
                    setOfflineStatus(); // ç®¡ç†å‘˜ä¸æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€
                } else {
                    // æ™®é€šç”¨æˆ·æ¨¡å¼
                    console.log('æ£€æµ‹åˆ°æ™®é€šç”¨æˆ·å·²ç™»å½•');
                    if (DOM.mainPage) DOM.mainPage.classList.remove('hidden');
                    if (DOM.userName) DOM.userName.textContent = `æ¬¢è¿ï¼Œ${currentUser.name}`;
                    
                    // æ£€æŸ¥ä¼šè¯çŠ¶æ€
                    if (!currentSession || currentSession.phone !== currentUser.phone) {
                        // æ²¡æœ‰æœ‰æ•ˆçš„å½“å‰ä¼šè¯ï¼Œæ£€æŸ¥æœ€åä¼šè¯æ˜¯å¦è¿˜åœ¨åˆç†æ—¶é—´å†…
                        const userBehavior = userBehaviorDB[currentUser.phone];
                        if (userBehavior && userBehavior.sessions.length > 0) {
                            const lastSession = userBehavior.sessions[userBehavior.sessions.length - 1];
                            if (lastSession && !lastSession.logoutTime) {
                                // æœ‰æœªç»“æŸçš„ä¼šè¯ï¼Œä½†è¶…è¿‡30åˆ†é’Ÿè§†ä¸ºå·²ç¦»çº¿
                                const sessionAge = Date.now() - lastSession.loginTime;
                                if (sessionAge < 30 * 60 * 1000) { // 30åˆ†é’Ÿå†…
                                    currentSession = {
                                        phone: currentUser.phone,
                                        loginTime: lastSession.loginTime,
                                        logoutTime: null,
                                        duration: Math.floor(sessionAge / 1000)
                                    };
                                    localStorage.setItem(STORAGE_KEYS.CURRENT_SESSION, JSON.stringify(currentSession));
                                    setOnlineStatus();
                                } else {
                                    // è¶…è¿‡30åˆ†é’Ÿï¼Œè‡ªåŠ¨ç»“æŸä¼šè¯
                                    recordLogout(currentUser.phone);
                                    recordLogin(currentUser.phone);
                                }
                            } else {
                                recordLogin(currentUser.phone);
                            }
                        } else {
                            recordLogin(currentUser.phone);
                        }
                    } else {
                        setOnlineStatus();
                    }
                    
                    // å¼€å§‹åœ¨çº¿çŠ¶æ€ç›‘æ§
                    startOnlineStatusMonitoring();
                    
                    loadUserData();
                    loadQA();
                    loadCollect();
                }
            } else {
                // æ²¡æœ‰ç”¨æˆ·ç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
                console.log('æ²¡æœ‰ç”¨æˆ·ç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
                if (DOM.authPage) DOM.authPage.classList.remove('hidden');
                // ç¡®ä¿åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾
                switchTab('login');
            }
            
            // ç»‘å®šæ‰€æœ‰äº‹ä»¶
            bindEvents();
            
            // åˆå§‹åŒ–å›¾è¡¨
            loadCharts();
            
            console.log('é¡µé¢æ˜¾ç¤ºåˆå§‹åŒ–å®Œæˆ');
        }

        function clearLoginForm() {
            // æ¸…ç©ºç™»å½•è¡¨å•
            if (document.getElementById('loginPhone')) document.getElementById('loginPhone').value = '';
            if (document.getElementById('loginPwd')) document.getElementById('loginPwd').value = '';
            if (document.getElementById('loginError')) document.getElementById('loginError').classList.add('hidden');
            
            // æ¸…ç©ºæ³¨å†Œè¡¨å•
            if (document.getElementById('regPhone')) document.getElementById('regPhone').value = '';
            if (document.getElementById('regName')) document.getElementById('regName').value = '';
            if (document.getElementById('regPwd')) document.getElementById('regPwd').value = '';
            if (document.getElementById('regConfirmPwd')) document.getElementById('regConfirmPwd').value = '';
            if (document.getElementById('regSuccess')) document.getElementById('regSuccess').classList.add('hidden');
        }

        // é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–é¡µé¢...');
            
            // åˆå§‹åŒ–é¡µé¢æ˜¾ç¤º
            await initPageDisplay();
            
            // å¦‚æœæœ‰å½“å‰ä¼šè¯ï¼Œæ›´æ–°åœ¨çº¿æ—¶é—´
            if (currentSession) {
                const now = Date.now();
                const elapsed = Math.floor((now - currentSession.loginTime) / 1000);
                currentSession.duration = elapsed;
                localStorage.setItem(STORAGE_KEYS.CURRENT_SESSION, JSON.stringify(currentSession));
            }
            
            console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        // ========== äº‹ä»¶ç»‘å®š ==========
        function bindEvents() {
            console.log('ç»‘å®šäº‹ä»¶...');
            
            // ç™»å½•æ³¨å†Œæ ‡ç­¾åˆ‡æ¢
            if (DOM.loginTab) {
                DOM.loginTab.addEventListener('click', function() {
                    console.log('ç‚¹å‡»ç™»å½•æ ‡ç­¾');
                    switchTab('login');
                });
            }
            
            if (DOM.registerTab) {
                DOM.registerTab.addEventListener('click', function() {
                    console.log('ç‚¹å‡»æ³¨å†Œæ ‡ç­¾');
                    switchTab('register');
                });
            }
            
            // ç™»å½•æŒ‰é’®
            if (DOM.loginBtn) {
                console.log('ç»‘å®šç™»å½•æŒ‰é’®äº‹ä»¶');
                DOM.loginBtn.addEventListener('click', function(e) {
                    console.log('ç‚¹å‡»ç™»å½•æŒ‰é’®');
                    e.preventDefault();
                    login();
                });
            } else {
                console.error('ç™»å½•æŒ‰é’®DOMå…ƒç´ æœªæ‰¾åˆ°');
            }
            
            // æ³¨å†ŒæŒ‰é’®
            if (DOM.regBtn) {
                console.log('ç»‘å®šæ³¨å†ŒæŒ‰é’®äº‹ä»¶');
                DOM.regBtn.addEventListener('click', function(e) {
                    console.log('ç‚¹å‡»æ³¨å†ŒæŒ‰é’®');
                    e.preventDefault();
                    register();
                });
            } else {
                console.error('æ³¨å†ŒæŒ‰é’®DOMå…ƒç´ æœªæ‰¾åˆ°');
            }
            
            // ä¸ºè¾“å…¥æ¡†æ·»åŠ Enteré”®æ”¯æŒ
            document.getElementById('loginPwd')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('ç™»å½•è¡¨å•æŒ‰Enteré”®');
                    login();
                }
            });
            
            document.getElementById('regConfirmPwd')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('æ³¨å†Œè¡¨å•æŒ‰Enteré”®');
                    register();
                }
            });
            
            // é€€å‡ºæŒ‰é’®
            if (DOM.logoutBtn) {
                DOM.logoutBtn.addEventListener('click', function() {
                    console.log('ç‚¹å‡»é€€å‡ºæŒ‰é’®');
                    if (currentUser) {
                        recordLogout(currentUser.phone);
                    }
                    logout();
                });
            }
            
            // ç®¡ç†å‘˜é€€å‡ºæŒ‰é’®
            if (DOM.adminLogoutBtn) {
                DOM.adminLogoutBtn.addEventListener('click', function() {
                    console.log('ç‚¹å‡»ç®¡ç†å‘˜é€€å‡ºæŒ‰é’®');
                    adminLogout();
                });
            }
            
            // å…³é—­è¯¦æƒ…æŒ‰é’®
            if (DOM.closeDetail) {
                DOM.closeDetail.addEventListener('click', function() {
                    console.log('ç‚¹å‡»å…³é—­è¯¦æƒ…æŒ‰é’®');
                    DOM.userDetailPanel.classList.add('hidden');
                });
            }
            
            // ç®¡ç†å‘˜è§†å›¾åˆ‡æ¢
            if (DOM.viewWeekly) {
                DOM.viewWeekly.addEventListener('click', function() {
                    console.log('åˆ‡æ¢åˆ°æœ¬å‘¨ç»Ÿè®¡è§†å›¾');
                    switchAdminView('weekly');
                });
            }
            
            if (DOM.viewMonthly) {
                DOM.viewMonthly.addEventListener('click', function() {
                    console.log('åˆ‡æ¢åˆ°æœ¬æœˆç»Ÿè®¡è§†å›¾');
                    switchAdminView('monthly');
                });
            }
            
            if (DOM.viewAll) {
                DOM.viewAll.addEventListener('click', function() {
                    console.log('åˆ‡æ¢åˆ°å…¨éƒ¨æ•°æ®è§†å›¾');
                    switchAdminView('all');
                });
            }
            
            // è¯¦æƒ…é¡µæ ‡ç­¾åˆ‡æ¢
            if (DOM.detailTabSessions) {
                DOM.detailTabSessions.addEventListener('click', function() {
                    console.log('åˆ‡æ¢åˆ°ç™»å½•è®°å½•æ ‡ç­¾');
                    switchDetailTab('sessions');
                });
            }
            
            if (DOM.detailTabQA) {
                DOM.detailTabQA.addEventListener('click', function() {
                    console.log('åˆ‡æ¢åˆ°é—®ç­”è®°å½•æ ‡ç­¾');
                    switchDetailTab('qa');
                });
            }
            
            // æ™ºèƒ½é—®ç­”å‘é€æŒ‰é’®
            if (DOM.sendBtn && DOM.questionInput) {
                console.log('ç»‘å®šé—®ç­”æŒ‰é’®äº‹ä»¶');
                DOM.sendBtn.addEventListener('click', function() {
                    console.log('ç‚¹å‡»å‘é€é—®é¢˜æŒ‰é’®');
                    sendQuestion();
                });
                
                DOM.questionInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('é—®ç­”è¾“å…¥æ¡†æŒ‰Enteré”®');
                        sendQuestion();
                    }
                });
            }
            
            // é¡µé¢å¸è½½æ—¶è®°å½•ç™»å‡º
            window.addEventListener('beforeunload', function() {
                console.log('é¡µé¢å…³é—­ï¼Œè®°å½•ç™»å‡º');
                if (currentUser && !isAdminMode) {
                    recordLogout(currentUser.phone);
                }
                if (onlineCheckInterval) {
                    clearInterval(onlineCheckInterval);
                }
            });
            
            // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ›´æ–°çŠ¶æ€
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // é¡µé¢éšè—ï¼Œæš‚åœåœ¨çº¿çŠ¶æ€æ›´æ–°
                    if (onlineCheckInterval) {
                        clearInterval(onlineCheckInterval);
                    }
                } else {
                    // é¡µé¢æ¢å¤å¯è§ï¼Œé‡æ–°å¼€å§‹åœ¨çº¿çŠ¶æ€ç›‘æ§
                    if (currentUser && !isAdminMode) {
                        startOnlineStatusMonitoring();
                    }
                }
            });
            
            console.log('äº‹ä»¶ç»‘å®šå®Œæˆ');
        }

        function switchAdminView(mode) {
            currentViewMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            [DOM.viewWeekly, DOM.viewMonthly, DOM.viewAll].forEach(btn => {
                if (btn) {
                    btn.classList.remove('active');
                    btn.classList.add('inactive');
                }
            });
            
            if (mode === 'weekly') {
                if (DOM.viewWeekly) {
                    DOM.viewWeekly.classList.remove('inactive');
                    DOM.viewWeekly.classList.add('active');
                }
                if (DOM.statsDescription) {
                    DOM.statsDescription.textContent = 'æ˜¾ç¤ºæœ¬å‘¨ï¼ˆä»æœ¬å‘¨ä¸€å¼€å§‹ï¼‰çš„ç”¨æˆ·ç™»å½•æ•°æ®';
                }
                if (DOM.periodLoginsHeader) {
                    DOM.periodLoginsHeader.textContent = 'æœ¬å‘¨ç™»å½•';
                }
                if (DOM.periodAvgTimeHeader) {
                    DOM.periodAvgTimeHeader.textContent = 'æœ¬å‘¨å¹³å‡æ—¶é•¿';
                }
            } else if (mode === 'monthly') {
                if (DOM.viewMonthly) {
                    DOM.viewMonthly.classList.remove('inactive');
                    DOM.viewMonthly.classList.add('active');
                }
                if (DOM.statsDescription) {
                    DOM.statsDescription.textContent = 'æ˜¾ç¤ºæœ¬æœˆï¼ˆä»æœ¬æœˆç¬¬ä¸€å¤©å¼€å§‹ï¼‰çš„ç”¨æˆ·ç™»å½•æ•°æ®';
                }
                if (DOM.periodLoginsHeader) {
                    DOM.periodLoginsHeader.textContent = 'æœ¬æœˆç™»å½•';
                }
                if (DOM.periodAvgTimeHeader) {
                    DOM.periodAvgTimeHeader.textContent = 'æœ¬æœˆå¹³å‡æ—¶é•¿';
                }
            } else {
                if (DOM.viewAll) {
                    DOM.viewAll.classList.remove('inactive');
                    DOM.viewAll.classList.add('active');
                }
                if (DOM.statsDescription) {
                    DOM.statsDescription.textContent = 'æ˜¾ç¤ºæ‰€æœ‰å†å²ç”¨æˆ·ç™»å½•æ•°æ®';
                }
                if (DOM.periodLoginsHeader) {
                    DOM.periodLoginsHeader.textContent = 'æ€»ç™»å½•';
                }
                if (DOM.periodAvgTimeHeader) {
                    DOM.periodAvgTimeHeader.textContent = 'å¹³å‡æ—¶é•¿';
                }
            }
            
            loadAdminData();
        }

        function switchDetailTab(tab) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            if (DOM.detailTabSessions && DOM.detailTabQA) {
                [DOM.detailTabSessions, DOM.detailTabQA].forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (tab === 'sessions') {
                    DOM.detailTabSessions.classList.add('active');
                    if (DOM.detailSessionsPanel) {
                        DOM.detailSessionsPanel.classList.remove('hidden');
                    }
                    if (DOM.detailQAPanel) {
                        DOM.detailQAPanel.classList.add('hidden');
                    }
                } else {
                    DOM.detailTabQA.classList.add('active');
                    if (DOM.detailSessionsPanel) {
                        DOM.detailSessionsPanel.classList.add('hidden');
                    }
                    if (DOM.detailQAPanel) {
                        DOM.detailQAPanel.classList.remove('hidden');
                    }
                }
            }
        }

        // ========== ç”¨æˆ·æ•°æ®åŠ è½½ ==========
        function loadUserData() {
            if (!currentUser) return;
            
            const stats = getUserStats(currentUser.phone);
            
            if (DOM.userTotalLogins) DOM.userTotalLogins.textContent = stats.totalLogins;
            if (DOM.userTotalTime) DOM.userTotalTime.textContent = formatTimeShort(stats.totalDuration);
            if (DOM.userAvgTime) DOM.userAvgTime.textContent = formatTimeShort(stats.avgDuration);
            
            if (DOM.userWeeklyLogins) DOM.userWeeklyLogins.textContent = stats.weeklyLogins;
            if (DOM.userWeeklyAvgTime) DOM.userWeeklyAvgTime.textContent = formatTimeShort(stats.weeklyAvgDuration);
            if (DOM.userWeeklyActiveDays) DOM.userWeeklyActiveDays.textContent = stats.weeklyActiveDays;
            
            if (DOM.userMonthlyLogins) DOM.userMonthlyLogins.textContent = stats.monthlyLogins;
            if (DOM.userMonthlyAvgTime) DOM.userMonthlyAvgTime.textContent = formatTimeShort(stats.monthlyAvgDuration);
            if (DOM.userMonthlyActiveDays) DOM.userMonthlyActiveDays.textContent = stats.monthlyActiveDays;
            
            loadRecentSessions();
        }

        function updateUserDataDisplay() {
            if (!currentUser) return;
            
            const stats = getUserStats(currentUser.phone);
            if (DOM.userTotalTime) DOM.userTotalTime.textContent = formatTimeShort(stats.totalDuration);
            if (DOM.userAvgTime) DOM.userAvgTime.textContent = formatTimeShort(stats.avgDuration);
            
            if (stats.isOnline && DOM.onlineStatus && currentSession) {
                DOM.onlineStatus.textContent = `åœ¨çº¿ ${formatTimeShort(currentSession.duration || 0)}`;
            }
        }

        function loadRecentSessions() {
            if (!currentUser || !DOM.userRecentSessions) return;
            
            const recentSessions = getRecentSessions(currentUser.phone, 5);
            DOM.userRecentSessions.innerHTML = '';
            
            if (recentSessions.length === 0) {
                DOM.userRecentSessions.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                            <i class="fa fa-history text-2xl mb-2 block"></i>
                            <p>æš‚æ— å®Œæˆçš„ç™»å½•è®°å½•</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            recentSessions.forEach((session, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${formatDate(session.loginTime)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${session.logoutTime ? formatDate(session.logoutTime) : '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${formatDuration(session.duration)}</td>
                `;
                DOM.userRecentSessions.appendChild(row);
            });
        }

        // ========== ç®¡ç†å‘˜æ•°æ®åŠ è½½ ==========
        function loadAdminData() {
            const adminStats = getAdminStats();
            if (DOM.activeUsers) DOM.activeUsers.textContent = adminStats.activeUsers;
            if (DOM.totalLogins) DOM.totalLogins.textContent = adminStats.totalLogins;
            if (DOM.totalOnlineTime) DOM.totalOnlineTime.textContent = formatTimeShort(adminStats.totalDuration);
            if (DOM.avgSessionTime) DOM.avgSessionTime.textContent = formatTimeShort(adminStats.avgSessionTime);
            
            loadUserBehaviorTable();
            loadCharts();
        }

        function loadUserBehaviorTable() {
            if (!DOM.userBehaviorTable) return;
            
            DOM.userBehaviorTable.innerHTML = '';
            
            Object.entries(userDB).forEach(([phone, userInfo]) => {
                if (phone === ADMIN_PHONE) return;
                
                const stats = getUserStats(phone);
                
                // æ ¹æ®å½“å‰è§†å›¾æ¨¡å¼é€‰æ‹©æ˜¾ç¤ºçš„æ•°æ®
                let periodLogins, periodAvgTime;
                if (currentViewMode === 'weekly') {
                    periodLogins = stats.weeklyLogins;
                    periodAvgTime = formatTimeShort(stats.weeklyAvgDuration);
                } else if (currentViewMode === 'monthly') {
                    periodLogins = stats.monthlyLogins;
                    periodAvgTime = formatTimeShort(stats.monthlyAvgDuration);
                } else {
                    periodLogins = stats.totalLogins;
                    periodAvgTime = formatTimeShort(stats.avgDuration);
                }
                
                const row = document.createElement('tr');
                row.className = 'user-row';
                row.innerHTML = `
                    <td class="font-medium">${userInfo.name}</td>
                    <td class="font-mono text-sm">${phone}</td>
                    <td class="text-center">${stats.totalLogins}</td>
                    <td class="font-mono">${formatTimeShort(stats.totalDuration)}</td>
                    <td class="font-mono">${formatTimeShort(stats.avgDuration)}</td>
                    <td class="text-center">${periodLogins}</td>
                    <td class="font-mono">${periodAvgTime}</td>
                    <td>
                        <span class="stat-badge ${stats.isOnline ? 'online' : 'offline'}">
                            <i class="fa fa-circle mr-1 ${stats.isOnline ? 'text-green-500' : 'text-gray-500'}"></i>
                            ${stats.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                        </span>
                    </td>
                    <td>
                        <button class="px-3 py-1 bg-primary text-white text-sm rounded hover:bg-primary/90 transition-colors view-detail" data-phone="${phone}">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </td>
                `;
                
                DOM.userBehaviorTable.appendChild(row);
            });
            
            // ç»‘å®šè¯¦æƒ…æŸ¥çœ‹æŒ‰é’®
            document.querySelectorAll('.view-detail').forEach(button => {
                button.addEventListener('click', (e) => {
                    const phone = e.target.dataset.phone;
                    showUserDetail(phone);
                });
            });
            
            if (DOM.userBehaviorTable.children.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                        <i class="fa fa-users text-2xl mb-2 block"></i>
                        <p>æš‚æ— ç”¨æˆ·æ•°æ®</p>
                    </td>
                `;
                DOM.userBehaviorTable.appendChild(row);
            }
        }

        function showUserDetail(phone) {
            const userInfo = userDB[phone];
            if (!userInfo) return;
            
            selectedUserPhone = phone;
            const stats = getUserStats(phone);
            const sessions = getRecentSessions(phone, 20);
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            if (DOM.detailUserName) DOM.detailUserName.textContent = `ç”¨æˆ·è¯¦æƒ…ï¼š${userInfo.name}`;
            if (DOM.detailUserPhone) DOM.detailUserPhone.textContent = `æ‰‹æœºå·ï¼š${phone}`;
            if (DOM.detailTotalLogins) DOM.detailTotalLogins.textContent = stats.totalLogins;
            if (DOM.detailTotalTime) DOM.detailTotalTime.textContent = formatTimeShort(stats.totalDuration);
            if (DOM.detailAvgTime) DOM.detailAvgTime.textContent = formatTimeShort(stats.avgDuration);
            
            // åŠ è½½ä¼šè¯è®°å½•
            if (DOM.userSessionTable) {
                DOM.userSessionTable.innerHTML = '';
                sessions.forEach((session, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-center">${index + 1}</td>
                        <td class="time-cell">${formatDateTime(session.loginTime)}</td>
                        <td class="time-cell">${session.logoutTime ? formatDateTime(session.logoutTime) : '-'}</td>
                        <td class="font-mono">${formatDuration(session.duration)}</td>
                        <td>
                            <span class="px-2 py-1 text-xs rounded ${session.logoutTime ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${session.logoutTime ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                            </span>
                        </td>
                    `;
                    DOM.userSessionTable.appendChild(row);
                });
            }
            
            // åŠ è½½é—®ç­”è®°å½•
            loadUserQARecords(phone);
            
            // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿å¹¶åˆ‡æ¢åˆ°ç™»å½•è®°å½•æ ‡ç­¾
            if (DOM.userDetailPanel) {
                DOM.userDetailPanel.classList.remove('hidden');
            }
            switchDetailTab('sessions');
        }

        function loadUserQARecords(phone) {
            if (!DOM.userQATable) return;
            
            DOM.userQATable.innerHTML = '';
            
            if (!qaDB[phone] || qaDB[phone].length === 0) {
                DOM.userQATable.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                            <i class="fa fa-comment-o text-2xl mb-2 block"></i>
                            <p>è¯¥ç”¨æˆ·æš‚æ— é—®ç­”è®°å½•</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedQA = [...qaDB[phone]].sort((a, b) => {
                const timeA = a.time ? new Date(`1970-01-01 ${a.time}`).getTime() : 0;
                const timeB = b.time ? new Date(`1970-01-01 ${b.time}`).getTime() : 0;
                return timeB - timeA;
            });
            
            sortedQA.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td class="time-cell">${record.time || '-'}</td>
                    <td class="max-w-xs truncate">${record.question || ''}</td>
                    <td class="max-w-xs truncate">${record.answer || ''}</td>
                `;
                DOM.userQATable.appendChild(row);
            });
        }

        // ========== å›¾è¡¨åŠ è½½ ==========
        function loadCharts() {
            loadWeeklyChart();
            loadMonthlyChart();
        }

        function loadWeeklyChart() {
            const ctx = DOM.weeklyChart?.getContext('2d');
            if (!ctx) return;
            
            if (userCharts.weeklyChart) {
                userCharts.weeklyChart.destroy();
            }
            
            const weekRange = getCurrentWeekRange();
            if (DOM.weeklyChartTitle) {
                DOM.weeklyChartTitle.textContent = `æœ¬å‘¨ï¼ˆ${weekRange.startDate} è‡³ ${weekRange.endDate}ï¼‰æ¯å¤©æ´»è·ƒç”¨æˆ·æ•°`;
            }
            
            const chartData = getWeeklyChartData();
            
            userCharts.weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'æ´»è·ƒç”¨æˆ·æ•°',
                        data: chartData.data,
                        backgroundColor: '#0E7C7B',
                        borderColor: '#0E7C7B',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'ç”¨æˆ·æ•°'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ˜ŸæœŸ'
                            }
                        }
                    }
                }
            });
        }

        function loadMonthlyChart() {
            const ctx = DOM.monthlyChart?.getContext('2d');
            if (!ctx) return;
            
            if (userCharts.monthlyChart) {
                userCharts.monthlyChart.destroy();
            }
            
            const monthRange = getCurrentMonthRange();
            if (DOM.monthlyChartTitle) {
                DOM.monthlyChartTitle.textContent = `æœ¬æœˆï¼ˆ${monthRange.startDate} è‡³ ${monthRange.endDate}ï¼‰æ¯å‘¨ç™»å½•æ¬¡æ•°`;
            }
            
            const chartData = getMonthlyChartData();
            
            userCharts.monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'ç™»å½•æ¬¡æ•°',
                        data: chartData.data,
                        backgroundColor: '#41C9E2',
                        borderColor: '#41C9E2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'ç™»å½•æ¬¡æ•°'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å‘¨æ¬¡'
                            }
                        }
                    }
                }
            });
        }

        // ========== ç™»å½•åŠŸèƒ½ ==========
        function login() {
            console.log('æ‰§è¡Œç™»å½•å‡½æ•°');
            const phone = document.getElementById('loginPhone') ? document.getElementById('loginPhone').value.trim() : '';
            const pwd = document.getElementById('loginPwd') ? document.getElementById('loginPwd').value.trim() : '';
            
            console.log('ç™»å½•æ‰‹æœºå·:', phone, 'å¯†ç é•¿åº¦:', pwd.length);
            
            if (!checkPhone('loginPhone', 'loginPhoneTip') || !checkPwd('loginPwd', 'loginPwdTip')) {
                console.log('è¡¨å•éªŒè¯å¤±è´¥');
                if (DOM.loginForm) {
                    DOM.loginForm.classList.add('animate-shake');
                    setTimeout(() => {
                        if (DOM.loginForm) {
                            DOM.loginForm.classList.remove('animate-shake');
                        }
                    }, 500);
                }
                return;
            }
            
            console.log('è¡¨å•éªŒè¯é€šè¿‡');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜ç™»å½•
            if (phone === ADMIN_PHONE && pwd === ADMIN_PASSWORD) {
                console.log('ç®¡ç†å‘˜ç™»å½•');
                currentUser = { phone, name: ADMIN_NAME };
                isAdminMode = true;
                
                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                localStorage.setItem(STORAGE_KEYS.IS_ADMIN_MODE, JSON.stringify(true));
                
                if (DOM.authPage) DOM.authPage.classList.add('hidden');
                if (DOM.mainPage) DOM.mainPage.classList.add('hidden');
                if (DOM.adminPage) DOM.adminPage.classList.remove('hidden');
                if (DOM.adminName) DOM.adminName.textContent = `ç®¡ç†å‘˜ï¼š${ADMIN_NAME}`;
                loadAdminData();
                showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                return;
            }
            
            console.log('æ£€æŸ¥ç”¨æˆ·æ•°æ®åº“:', userDB);
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            if (!userDB[phone]) {
                console.log('ç”¨æˆ·ä¸å­˜åœ¨');
                if (DOM.loginError) {
                    DOM.loginError.textContent = 'ç”¨æˆ·ä¸å­˜åœ¨';
                    DOM.loginError.classList.remove('hidden');
                }
                return;
            }
            
            // æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®
            if (userDB[phone].pwd !== pwd) {
                console.log('å¯†ç é”™è¯¯');
                if (DOM.loginError) {
                    DOM.loginError.textContent = 'å¯†ç é”™è¯¯';
                    DOM.loginError.classList.remove('hidden');
                }
                return;
            }
            
            console.log('æ™®é€šç”¨æˆ·ç™»å½•æˆåŠŸ');
            currentUser = { phone, name: userDB[phone].name };
            isAdminMode = false;
            
            recordLogin(phone);
            
            localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
            localStorage.setItem(STORAGE_KEYS.IS_ADMIN_MODE, JSON.stringify(false));
            
            if (DOM.authPage) DOM.authPage.classList.add('hidden');
            if (DOM.mainPage) DOM.mainPage.classList.remove('hidden');
            if (DOM.adminPage) DOM.adminPage.classList.add('hidden');
            if (DOM.userName) DOM.userName.textContent = `æ¬¢è¿ï¼Œ${currentUser.name}`;
            
            // å¼€å§‹åœ¨çº¿çŠ¶æ€ç›‘æ§
            startOnlineStatusMonitoring();
            
            loadUserData();
            loadQA();
            loadCollect();
            
            showToast('ç™»å½•æˆåŠŸ');
        }

        // ========== æ³¨å†ŒåŠŸèƒ½ ==========
        function register() {
            console.log('æ‰§è¡Œæ³¨å†Œå‡½æ•°');
            const phone = document.getElementById('regPhone') ? document.getElementById('regPhone').value.trim() : '';
            const name = document.getElementById('regName') ? document.getElementById('regName').value.trim() : '';
            const pwd = document.getElementById('regPwd') ? document.getElementById('regPwd').value.trim() : '';
            const cpwd = document.getElementById('regConfirmPwd') ? document.getElementById('regConfirmPwd').value.trim() : '';
            
            console.log('æ³¨å†Œä¿¡æ¯:', { phone, name, pwdLength: pwd.length, cpwdLength: cpwd.length });
            
            if (phone === ADMIN_PHONE) {
                showToast('è¯¥æ‰‹æœºå·ä¸ºç®¡ç†å‘˜ä¸“ç”¨ï¼Œä¸å¯æ³¨å†Œ', 'error');
                return;
            }
            
            if (!checkPhone('regPhone', 'regPhoneTip') || 
                !checkName('regName', 'regNameTip') || 
                !checkPwd('regPwd', 'regPwdTip') || 
                !checkPwdMatch('regPwd', 'regConfirmPwd', 'regPwdMatchTip')) {
                console.log('æ³¨å†Œè¡¨å•éªŒè¯å¤±è´¥');
                if (DOM.registerForm) {
                    DOM.registerForm.classList.add('animate-shake');
                    setTimeout(() => {
                        if (DOM.registerForm) {
                            DOM.registerForm.classList.remove('animate-shake');
                        }
                    }, 500);
                }
                return;
            }
            
            if (userDB[phone]) {
                showToast('è¯¥æ‰‹æœºå·å·²æ³¨å†Œ', 'error');
                return;
            }
            
            console.log('æ³¨å†Œè¡¨å•éªŒè¯é€šè¿‡ï¼Œåˆ›å»ºç”¨æˆ·');
            
            userDB[phone] = { 
                name, 
                pwd, 
                createTime: Date.now() 
            };
            saveData();
            
            initUserBehavior(phone);
            
            if (DOM.regSuccess) {
                DOM.regSuccess.classList.remove('hidden');
            }
            showToast('æ³¨å†ŒæˆåŠŸ');
            
            setTimeout(() => {
                switchTab('login');
                if (DOM.regSuccess) DOM.regSuccess.classList.add('hidden');
                if (document.getElementById('regPhone')) document.getElementById('regPhone').value = '';
                if (document.getElementById('regName')) document.getElementById('regName').value = '';
                if (document.getElementById('regPwd')) document.getElementById('regPwd').value = '';
                if (document.getElementById('regConfirmPwd')) document.getElementById('regConfirmPwd').value = '';
            }, 1500);
        }

        // ========== é€€å‡ºåŠŸèƒ½ ==========
        function logout() {
            console.log('æ‰§è¡Œé€€å‡ºç™»å½•');
            if (currentUser && !isAdminMode) {
                recordLogout(currentUser.phone);
            }
            
            if (onlineCheckInterval) {
                clearInterval(onlineCheckInterval);
                onlineCheckInterval = null;
            }
            
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            localStorage.removeItem(STORAGE_KEYS.IS_ADMIN_MODE);
            localStorage.removeItem(STORAGE_KEYS.CURRENT_SESSION);
            
            currentUser = null;
            isAdminMode = false;
            currentSession = null;
            
            if (DOM.mainPage) DOM.mainPage.classList.add('hidden');
            if (DOM.adminPage) DOM.adminPage.classList.add('hidden');
            if (DOM.authPage) DOM.authPage.classList.remove('hidden');
            
            // æ¸…ç©ºè¡¨å•
            clearLoginForm();
            
            showToast('å·²é€€å‡ºç™»å½•');
        }

        function adminLogout() {
            console.log('æ‰§è¡Œç®¡ç†å‘˜é€€å‡º');
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            localStorage.removeItem(STORAGE_KEYS.IS_ADMIN_MODE);
            
            currentUser = null;
            isAdminMode = false;
            
            if (DOM.adminPage) DOM.adminPage.classList.add('hidden');
            if (DOM.authPage) DOM.authPage.classList.remove('hidden');
            
            // æ¸…ç©ºè¡¨å•
            clearLoginForm();
            
            showToast('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
        }

        // ========== è¡¨å•éªŒè¯å‡½æ•° ==========
        function checkPhone(id, tip) {
            const inp = document.getElementById(id);
            const tipDom = document.getElementById(tip);
            if (!inp || !tipDom) {
                console.error(`æœªæ‰¾åˆ°å…ƒç´ : ${id} æˆ– ${tip}`);
                return false;
            }
            
            const val = inp.value.trim();
            if (!/^\d{11}$/.test(val)) {
                tipDom.classList.remove('hidden');
                return false;
            }
            tipDom.classList.add('hidden');
            return true;
        }

        function checkPwd(id, tip) {
            const inp = document.getElementById(id);
            const tipDom = document.getElementById(tip);
            if (!inp || !tipDom) {
                console.error(`æœªæ‰¾åˆ°å…ƒç´ : ${id} æˆ– ${tip}`);
                return false;
            }
            
            const val = inp.value.trim();
            if (val.length < 8) {
                tipDom.classList.remove('hidden');
                return false;
            }
            tipDom.classList.add('hidden');
            return true;
        }

        function checkName(id, tip) {
            const inp = document.getElementById(id);
            const tipDom = document.getElementById(tip);
            if (!inp || !tipDom) {
                console.error(`æœªæ‰¾åˆ°å…ƒç´ : ${id} æˆ– ${tip}`);
                return false;
            }
            
            const val = inp.value.trim();
            if (val.length < 1 || val.length > 20) {
                tipDom.classList.remove('hidden');
                return false;
            }
            tipDom.classList.add('hidden');
            return true;
        }

        function checkPwdMatch(p1, p2, tip) {
            const v1 = document.getElementById(p1)?.value.trim() || '';
            const v2 = document.getElementById(p2)?.value.trim() || '';
            const tipDom = document.getElementById(tip);
            if (!tipDom) {
                console.error(`æœªæ‰¾åˆ°å…ƒç´ : ${tip}`);
                return false;
            }
            
            if (v1 !== v2) {
                tipDom.classList.remove('hidden');
                return false;
            }
            tipDom.classList.add('hidden');
            return true;
        }

        // ========== å…¶ä»–å·¥å…·å‡½æ•° ==========
        function showToast(txt, type = 'success') {
            if (!DOM.toast) return;
            
            DOM.toast.textContent = txt;
            DOM.toast.className = 'toast show';
            if (type === 'error') DOM.toast.classList.add('error');
            setTimeout(() => {
                DOM.toast.classList.remove('show');
                DOM.toast.classList.remove('error');
            }, 2000);
        }

        function clearInput(id) {
            const inp = document.getElementById(id);
            if (inp) {
                inp.value = '';
                inp.focus();
                showToast('å·²æ¸…ç©ºå†…å®¹');
            }
        }

        function togglePwd(id, btn) {
            const inp = document.getElementById(id);
            if (inp && btn) {
                const icon = btn.querySelector('i');
                inp.type = inp.type === 'password' ? 'text' : 'password';
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }
        }

        function switchTab(type) {
            console.log('åˆ‡æ¢æ ‡ç­¾åˆ°:', type);
            if (type === 'login') {
                if (DOM.loginForm) DOM.loginForm.classList.remove('hidden');
                if (DOM.registerForm) DOM.registerForm.classList.add('hidden');
                if (DOM.loginTab) {
                    DOM.loginTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                }
                if (DOM.registerTab) {
                    DOM.registerTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                }
            } else {
                if (DOM.registerForm) DOM.registerForm.classList.remove('hidden');
                if (DOM.loginForm) DOM.loginForm.classList.add('hidden');
                if (DOM.registerTab) {
                    DOM.registerTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                }
                if (DOM.loginTab) {
                    DOM.loginTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                }
            }
        }

        // ========== é—®é¢˜å»ºè®®å¡«å…… ==========
        function fillQuestion(question) {
            if (DOM.questionInput) {
                DOM.questionInput.value = question;
                DOM.questionInput.focus();
            }
        }

        // ========== æ™ºèƒ½é—®ç­”åŠŸèƒ½ ==========
        function getMockAnswer(question) {
            // æ›´å…¨é¢çš„å…³é”®è¯åŒ¹é…
            const questionLower = question.toLowerCase().trim();
            
            const mockResponses = {
                // é€šç”¨é—®å€™
                "ä½ å¥½": "ä½ å¥½ï¼æˆ‘æ˜¯ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥ä¸ºæ‚¨ä»‹ç»ä¸‰æ±Ÿæºçš„åœ°ç†ä½ç½®ã€çç¨€ç‰©ç§ã€ç”Ÿæ€ä»·å€¼ã€ä¿æŠ¤æªæ–½ç­‰ã€‚è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ",
                "æ‚¨å¥½": "æ‚¨å¥½ï¼æ¬¢è¿ä½¿ç”¨ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”å¹³å°ã€‚æˆ‘æ˜¯æ‚¨çš„ä¸“å±ç”Ÿæ€åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚",
                
                // åœ°ç†ä½ç½®ç›¸å…³
                "ä¸‰æ±Ÿæºåœ¨å“ªé‡Œ": "ä¸‰æ±Ÿæºä½äºä¸­å›½é’æµ·çœå—éƒ¨ï¼Œé’è—é«˜åŸè…¹åœ°ï¼Œæ˜¯é•¿æ±Ÿã€é»„æ²³ã€æ¾œæ²§æ±Ÿï¼ˆæ¹„å…¬æ²³ä¸Šæ¸¸ï¼‰ä¸‰å¤§æ±Ÿæ²³çš„å‘æºåœ°ã€‚åœ°ç†åæ ‡ä¸ºä¸œç»89Â°45â€²â€”102Â°23â€²ï¼ŒåŒ—çº¬31Â°39â€²â€”36Â°12â€²ã€‚",
                "åœ°ç†ä½ç½®": "ä¸‰æ±Ÿæºåœ°åŒºè¡Œæ”¿èŒƒå›´æ¶‰åŠç‰æ ‘ã€æœæ´›ã€é»„å—ã€æµ·å—4ä¸ªè—æ—è‡ªæ²»å·çš„16ä¸ªå¿å’Œæ ¼å°”æœ¨å¸‚çš„å”å¤æ‹‰å±±é•‡ï¼Œæ€»é¢ç§¯çº¦36.3ä¸‡å¹³æ–¹å…¬é‡Œã€‚",
                
                // ç‰©ç§ç›¸å…³
                "çç¨€ç‰©ç§": "ä¸‰æ±Ÿæºçš„çç¨€ç‰©ç§åŒ…æ‹¬ï¼šå›½å®¶ä¸€çº§ä¿æŠ¤åŠ¨ç‰©é›ªè±¹ã€è—ç¾šç¾Šã€é‡ç‰¦ç‰›ã€é»‘é¢ˆé¹¤ç­‰16ç§ï¼›äºŒçº§ä¿æŠ¤åŠ¨ç‰©è—åŸç¾šã€å²©ç¾Šã€è—ç‹ç­‰53ç§ã€‚ç‰¹æœ‰ç‰©ç§å¦‚é’æµ·æ¹–è£¸é²¤ç­‰37ç§ã€‚",
                "é›ªè±¹": "é›ªè±¹æ˜¯ä¸‰æ±Ÿæºçš„æ——èˆ°ç‰©ç§ï¼Œä¸»è¦æ –æ¯åœ¨æµ·æ‹”3500-5500ç±³çš„é«˜å±±è£¸å²©åœ°å¸¦ï¼Œä»¥å²©ç¾Šã€æ—±ç­ç­‰ä¸ºé£Ÿï¼Œè¢«èª‰ä¸º'é›ªå±±ä¹‹ç‹'ã€‚ç›®å‰ä¸‰æ±Ÿæºé›ªè±¹ç§ç¾¤æ•°é‡è¶…è¿‡1200åªï¼Œçº¦å å…¨çƒæ€»é‡çš„10%ã€‚",
                "è—ç¾šç¾Š": "è—ç¾šç¾Šåˆç§°'é«˜åŸç²¾çµ'ï¼Œä»¥å…¶ä¼˜ç¾çš„é•¿è§’å’Œæ¯å¹´å¤§è§„æ¨¡è¿å¾™è€Œé—»åã€‚ä¸»è¦æ –æ¯åœ¨æµ·æ‹”4000-5500ç±³çš„é«˜å¯’è‰åŸï¼Œç§ç¾¤æ•°é‡å·²ä»æ¿’å±æ¢å¤è‡³7-8ä¸‡åªã€‚",
                
                // ç”Ÿæ€ä»·å€¼
                "ç”Ÿæ€ä»·å€¼": "ä¸‰æ±Ÿæºçš„ç”Ÿæ€ä»·å€¼åŒ…æ‹¬ï¼š1.æ°´æºæ¶µå…»ï¼ˆå¹´å‡å¾„æµé‡600äº¿ç«‹æ–¹ç±³ï¼‰ï¼›2.ç”Ÿç‰©å¤šæ ·æ€§ä¿æŠ¤ï¼ˆ370ç§è„Šæ¤åŠ¨ç‰©ï¼‰ï¼›3.ç¢³æ±‡åŠŸèƒ½ï¼ˆå¹´å›ºç¢³1200ä¸‡å¨ï¼‰ï¼›4.æ°”å€™è°ƒèŠ‚ï¼›5.ç”Ÿæ€å®‰å…¨å±éšœã€‚",
                "ä¸­åæ°´å¡”": "ä¸‰æ±Ÿæºè¢«ç§°ä¸º'ä¸­åæ°´å¡”'ï¼Œå› ä¸ºè¿™é‡Œæ˜¯é•¿æ±Ÿã€é»„æ²³ã€æ¾œæ²§æ±Ÿä¸‰å¤§æ±Ÿæ²³çš„å‘æºåœ°ï¼Œæ¯å¹´å‘ä¸‹æ¸¸è¾“é€çº¦600äº¿ç«‹æ–¹ç±³çš„æ¸…æ´æ°´æºï¼Œæ»‹å…»äº†ä¸­å›½è¿‘åŠæ•°çš„ç»æµæ€»é‡å’Œäººå£ã€‚",
                
                // ä¿æŠ¤æªæ–½
                "ä¿æŠ¤æªæ–½": "ä¸‰æ±Ÿæºä¿æŠ¤æªæ–½åŒ…æ‹¬ï¼š1.ç”Ÿæ€ä¿®å¤å·¥ç¨‹ï¼ˆæ²»ç†é»‘åœŸæ»©2.5ä¸‡kmÂ²ï¼‰ï¼›2.å›½å®¶å…¬å›­ä½“åˆ¶ï¼›3.ç¤¾åŒºå…±ç®¡ï¼ˆè®¾ç«‹ç”Ÿæ€ç®¡æŠ¤å‘˜17211ä¸ªï¼‰ï¼›4.ç”Ÿæ€ç§»æ°‘ï¼ˆç´¯è®¡æ¬è¿10.2ä¸‡äººï¼‰ï¼›5.ç§‘ç ”ç›‘æµ‹ï¼ˆ76ä¸ªç›‘æµ‹ç«™ç‚¹ï¼‰ã€‚",
                "å¦‚ä½•ä¿æŠ¤": "ä¿æŠ¤ä¸‰æ±Ÿæºéœ€è¦ï¼š1.å‡å°‘äººç±»æ´»åŠ¨å¹²æ‰°ï¼›2.æ”¯æŒç”Ÿæ€ç§»æ°‘ï¼›3.å‚ä¸ç¯ä¿å¿—æ„¿æœåŠ¡ï¼›4.æ¨å¹¿ç”Ÿæ€æ—…æ¸¸ï¼›5.æ”¯æŒç§‘ç ”ç›‘æµ‹ï¼›6.æé«˜å…¬ä¼—ç¯ä¿æ„è¯†ã€‚",
                
                // æ°”å€™ç‰¹ç‚¹
                "æ°”å€™": "ä¸‰æ±Ÿæºå±äºé«˜åŸå¤§é™†æ€§æ°”å€™ï¼šå¹´å‡æ°”æ¸©-5.6â„ƒ~3.8â„ƒï¼Œå¹´é™æ°´é‡250-500æ¯«ç±³ï¼Œ80%é›†ä¸­åœ¨6-9æœˆï¼Œæ—¥ç…§å¼ºçƒˆï¼Œæ˜¼å¤œæ¸©å·®å¤§ï¼Œæ— éœœæœŸçŸ­ã€‚",
                "æµ·æ‹”": "ä¸‰æ±Ÿæºå¹³å‡æµ·æ‹”4000ç±³ä»¥ä¸Šï¼Œæœ€é«˜ç‚¹ä¸ºæ˜†ä»‘å±±è„‰çš„å¸ƒå–€è¾¾å‚å³°ï¼ˆæµ·æ‹”6860ç±³ï¼‰ï¼Œæœ€ä½ç‚¹ä½äºæ¾œæ²§æ±Ÿå‡ºå¢ƒå¤„ï¼ˆçº¦3500ç±³ï¼‰ã€‚",
                
                // å›½å®¶å…¬å›­
                "å›½å®¶å…¬å›­": "ä¸‰æ±Ÿæºå›½å®¶å…¬å›­æ˜¯ä¸­å›½ç¬¬ä¸€ä¸ªå›½å®¶å…¬å›­ä½“åˆ¶è¯•ç‚¹ï¼Œæ€»é¢ç§¯12.31ä¸‡å¹³æ–¹å…¬é‡Œï¼Œæ•´åˆäº†åŸæœ‰ä¿æŠ¤åŒºï¼Œå®è¡Œæœ€ä¸¥æ ¼çš„ç”Ÿæ€ä¿æŠ¤ï¼Œæ˜¯ç”Ÿæ€æ–‡æ˜å»ºè®¾çš„å…¸èŒƒã€‚",
                
                // ç”Ÿæ€æ—…æ¸¸
                "æ—…æ¸¸": "ä¸‰æ±Ÿæºç”Ÿæ€æ—…æ¸¸ä»¥'ç”Ÿæ€ä¼˜å…ˆã€ç»¿è‰²å‘å±•'ä¸ºåŸåˆ™ï¼Œå¼€å±•ç¯å¢ƒå‹å¥½å‹æ—…æ¸¸æ´»åŠ¨ï¼Œä¸¥æ ¼æ§åˆ¶æ¸¸å®¢æ•°é‡ï¼Œæ³¨é‡ç”Ÿæ€æ•™è‚²å’Œç¤¾åŒºå‚ä¸ã€‚",
            };
            
            // å…³é”®è¯åŒ¹é…
            for (let key in mockResponses) {
                if (questionLower.includes(key.toLowerCase())) {
                    return mockResponses[key];
                }
            }
            
            // æ›´æ™ºèƒ½çš„å…³é”®è¯æ£€æµ‹
            const keywords = {
                "é¢ç§¯": "ä¸‰æ±Ÿæºæ€»é¢ç§¯çº¦36.3ä¸‡å¹³æ–¹å…¬é‡Œï¼Œå…¶ä¸­æ ¸å¿ƒä¿æŠ¤åŒºé¢ç§¯12.31ä¸‡å¹³æ–¹å…¬é‡Œã€‚",
                "æ°´ç³»": "ä¸‰æ±Ÿæºä¸»è¦æ°´ç³»åŒ…æ‹¬é•¿æ±Ÿæºã€é»„æ²³æºã€æ¾œæ²§æ±Ÿæºä¸‰å¤§æ°´ç³»ï¼Œæ¶µç›–äº†å¤§å°æ²³æµ180å¤šæ¡ï¼Œæ¹–æ³Š16000å¤šä¸ªã€‚",
                "å†°å·": "ä¸‰æ±Ÿæºå†°å·é¢ç§¯çº¦2400å¹³æ–¹å…¬é‡Œï¼Œæ˜¯é‡è¦çš„å›ºä½“æ°´åº“ã€‚å—æ°”å€™å˜åŒ–å½±å“ï¼Œå†°å·å‘ˆç°é€€ç¼©è¶‹åŠ¿ã€‚",
                "æ¹¿åœ°": "ä¸‰æ±Ÿæºæ¹¿åœ°é¢ç§¯çº¦7.33ä¸‡å¹³æ–¹å…¬é‡Œï¼ŒåŒ…æ‹¬æ²³æµã€æ¹–æ³Šã€æ²¼æ³½ç­‰å¤šç§ç±»å‹ï¼Œæ˜¯é‡è¦çš„æ°´æºæ¶µå…»åŒºã€‚",
                "é»‘é¢ˆé¹¤": "é»‘é¢ˆé¹¤æ˜¯å”¯ä¸€åœ¨é«˜åŸç¹æ®–çš„é¹¤ç±»ï¼Œä¸»è¦æ –æ¯åœ¨æµ·æ‹”2500-5000ç±³çš„æ¹¿åœ°å’Œæ²¼æ³½åœ°å¸¦ï¼Œæ˜¯å›½å®¶ä¸€çº§ä¿æŠ¤é¸Ÿç±»ã€‚",
                "é‡ç‰¦ç‰›": "é‡ç‰¦ç‰›æ˜¯é’è—é«˜åŸç‰¹æœ‰ç‰©ç§ï¼Œä½“å‹å·¨å¤§ï¼Œé€‚åº”é«˜å¯’ç¯å¢ƒï¼Œä¸»è¦åˆ†å¸ƒåœ¨æµ·æ‹”4000-6000ç±³çš„é«˜å±±è‰ç”¸ã€‚",
            };
            
            for (let keyword in keywords) {
                if (questionLower.includes(keyword.toLowerCase())) {
                    return keywords[keyword];
                }
            }
            
            // é»˜è®¤å›ç­”
            return "ä¸‰æ±Ÿæºä½äºé’æµ·çœå—éƒ¨ï¼Œæ˜¯é•¿æ±Ÿã€é»„æ²³ã€æ¾œæ²§æ±Ÿçš„å‘æºåœ°ï¼Œè¢«ç§°ä¸º'ä¸­åæ°´å¡”'ã€‚è¿™é‡Œå¹³å‡æµ·æ‹”4000ç±³ä»¥ä¸Šï¼Œæ‹¥æœ‰ä¸°å¯Œçš„çç¨€åŠ¨æ¤ç‰©èµ„æºï¼Œæ˜¯æˆ‘å›½é‡è¦çš„ç”Ÿæ€å®‰å…¨å±éšœã€‚æ‚¨å¯ä»¥å…·ä½“è¯¢é—®ï¼šä¸‰æ±Ÿæºçš„åœ°ç†ä½ç½®ã€çç¨€ç‰©ç§ã€ç”Ÿæ€ä»·å€¼ã€ä¿æŠ¤æªæ–½ç­‰ã€‚";
        }

        async function sendQuestion() {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const question = DOM.questionInput ? DOM.questionInput.value.trim() : '';
            
            if (!question || question.length > 100) {
                showToast('è¯·è¾“å…¥1-100å­—çš„é—®é¢˜', 'error');
                return;
            }
            
            if (DOM.questionInput) DOM.questionInput.value = '';
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            const userHtml = `<div class="qa-item-user"><div class="qa-content-user"><div class="text-sm text-gray-500">æˆ‘ ${time}</div><div class="mt-1">${question}</div></div></div>`;
            if (DOM.chatBox) DOM.chatBox.insertAdjacentHTML('beforeend', userHtml);
            
            const loadingHtml = `<div class="qa-item-bot" id="loading"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1 flex items-center"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span><span class="ml-2">æ€è€ƒä¸­...</span></div></div></div>`;
            if (DOM.chatBox) DOM.chatBox.insertAdjacentHTML('beforeend', loadingHtml);
            if (DOM.chatBox) DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
            
            try {
                // ä½¿ç”¨æ¨¡æ‹Ÿå›ç­”
                const answer = getMockAnswer(question);
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.remove();
                
                const safeQuestion = question.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeAnswer = answer.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
                const isCollected = collectDB[currentUser.phone] && collectDB[currentUser.phone].some(c => c.question === question);
                const collectClass = isCollected ? 'collect-btn active' : 'collect-btn';
                
                const answerHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1">${answer}</div><i class="fa fa-star ${collectClass}" onclick="toggleCollect(this,'${safeQuestion}','${safeAnswer}')"></i></div></div>`;
                if (DOM.chatBox) DOM.chatBox.insertAdjacentHTML('beforeend', answerHtml);
                if (DOM.chatBox) DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
                
                if (!qaDB[currentUser.phone]) qaDB[currentUser.phone] = [];
                qaDB[currentUser.phone].push({ question, answer, time });
                saveData();
                
            } catch (error) {
                console.error('è·å–ç­”æ¡ˆå¤±è´¥:', error);
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.remove();
                
                const errorHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1 text-red-500">æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚</div></div></div>`;
                if (DOM.chatBox) DOM.chatBox.insertAdjacentHTML('beforeend', errorHtml);
                if (DOM.chatBox) DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
            }
        }

        function loadQA() {
            const chatBox = DOM.chatBox;
            if (!currentUser || !qaDB[currentUser.phone]) {
                if (chatBox) {
                    chatBox.innerHTML = `<div class="text-center text-gray-400 py-8"><i class="fa fa-comment-o text-3xl mb-2"></i><p>è¾“å…¥é—®é¢˜ï¼Œè·å–ä¸“ä¸šå›ç­”</p></div>`;
                }
                return;
            }
            
            if (!chatBox) return;
            
            chatBox.innerHTML = '';
            qaDB[currentUser.phone].forEach(item => {
                const userHtml = `<div class="qa-item-user"><div class="qa-content-user"><div class="text-sm text-gray-500">æˆ‘ ${item.time}</div><div class="mt-1">${item.question}</div></div></div>`;
                chatBox.insertAdjacentHTML('beforeend', userHtml);
                
                // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
                const isCollected = collectDB[currentUser.phone] && collectDB[currentUser.phone].some(c => c.question === item.question);
                const collectClass = isCollected ? 'collect-btn active' : 'collect-btn';
                const safeQuestion = item.question.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeAnswer = item.answer.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                const answerHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${item.time}</div><div class="mt-1">${item.answer}</div><i class="fa fa-star ${collectClass}" onclick="toggleCollect(this,'${safeQuestion}','${safeAnswer}')"></i></div></div>`;
                chatBox.insertAdjacentHTML('beforeend', answerHtml);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function toggleCollect(el, question, answer) {
            console.log('toggleCollect called:', question);
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            if (!collectDB[currentUser.phone]) collectDB[currentUser.phone] = [];
            
            // è§£ç HTMLå®ä½“
            const decodedQuestion = question.replace(/\\'/g, "'").replace(/&quot;/g, '"');
            const decodedAnswer = answer.replace(/\\'/g, "'").replace(/&quot;/g, '"');
            
            console.log('Searching for:', decodedQuestion);
            console.log('Current collectDB:', collectDB[currentUser.phone]);
            
            const index = collectDB[currentUser.phone].findIndex(c => c.question === decodedQuestion);
            console.log('Found index:', index);
            
            if (index === -1) {
                // æ·»åŠ æ”¶è—
                collectDB[currentUser.phone].push({ 
                    question: decodedQuestion, 
                    answer: decodedAnswer, 
                    time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }) 
                });
                el.classList.add('active');
                showToast('æ”¶è—æˆåŠŸ');
                console.log('Added to collection:', decodedQuestion);
            } else {
                // ç§»é™¤æ”¶è—
                collectDB[currentUser.phone].splice(index, 1);
                el.classList.remove('active');
                showToast('å–æ¶ˆæ”¶è—');
                console.log('Removed from collection:', decodedQuestion);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveData();
            
            // ç«‹å³æ›´æ–°æ”¶è—åˆ—è¡¨æ˜¾ç¤º
            loadCollect();
            
            // ä¹Ÿæ›´æ–°é—®ç­”ç•Œé¢çš„æ”¶è—çŠ¶æ€
            loadQA();
        }

        function loadCollect() {
            const collectionBox = document.getElementById('collectionBox');
            if (!collectionBox) return;
            
            if (!currentUser || !collectDB[currentUser.phone] || collectDB[currentUser.phone].length === 0) {
                collectionBox.innerHTML = `<div class="text-center text-gray-400 py-8" id="emptyCollection"><i class="fa fa-star-o text-3xl mb-2"></i><p>æš‚æ— æ”¶è—ï¼Œç‚¹å‡»å›ç­”æ—â­æ”¶è—</p></div>`;
                return;
            }
            
            collectionBox.innerHTML = '';
            collectDB[currentUser.phone].forEach(item => {
                const safeQuestion = item.question.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const html = `<div class="p-3 border-b border-gray-100 last:border-0"><div class="font-medium text-primary">${item.question}</div><div class="mt-1 text-gray-600 text-sm">${item.answer}</div><button class="mt-2 text-xs text-red-500" onclick="deleteCollect('${safeQuestion}')">åˆ é™¤</button></div>`;
                collectionBox.insertAdjacentHTML('beforeend', html);
            });
        }

        function deleteCollect(question) {
            console.log('deleteCollect called:', question);
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            // è§£ç HTMLå®ä½“
            const decodedQuestion = question.replace(/\\'/g, "'").replace(/&quot;/g, '"');
            
            console.log('Deleting:', decodedQuestion);
            console.log('Before delete:', collectDB[currentUser.phone]);
            
            // è¿‡æ»¤æ‰è¦åˆ é™¤çš„æ”¶è—
            collectDB[currentUser.phone] = collectDB[currentUser.phone].filter(c => c.question !== decodedQuestion);
            
            console.log('After delete:', collectDB[currentUser.phone]);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveData();
            
            // é‡æ–°åŠ è½½æ”¶è—åˆ—è¡¨
            loadCollect();
            
            // æ›´æ–°é—®ç­”ç•Œé¢çš„æ”¶è—çŠ¶æ€
            loadQA();
            
            showToast('å·²åˆ é™¤æ”¶è—');
        }
    </script>
</body>
</html>

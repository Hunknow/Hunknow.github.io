<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三江源生态智能问答平台</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0E7C7B',
                        secondary: '#41C9E2',
                        accent: '#A0D8B3',
                        dark: '#2C3E50',
                    }
                }
            }
        }
    </script>
    
    <!-- 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-cyan-50 to-green-50 text-dark min-h-screen">
    
    <!-- 认证页面 -->
    <div id="authPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8">
            <h1 class="text-3xl font-bold text-center text-primary mb-8">三江源生态智能问答平台</h1>
            
            <div class="flex mb-6">
                <button id="loginTab" class="flex-1 py-2 font-semibold border-b-2 border-primary text-primary" onclick="switchTab('login')">登录</button>
                <button id="registerTab" class="flex-1 py-2 font-semibold border-b-2 border-gray-200 text-gray-500" onclick="switchTab('register')">注册</button>
            </div>
            
            <!-- 登录表单 -->
            <div id="loginForm">
                <h2 class="text-xl font-bold text-center mb-4">用户登录</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">手机号</label>
                    <input type="tel" id="loginPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入11位手机号">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">密码</label>
                    <input type="password" id="loginPwd" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入密码（≥8位）">
                </div>
                <button onclick="loginUser()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary/90 transition">登录</button>
                <p class="mt-4 text-center text-sm text-gray-500">管理员：18597123311 / Hm123321</p>
            </div>
            
            <!-- 注册表单 -->
            <div id="registerForm" class="hidden">
                <h2 class="text-xl font-bold text-center mb-4">用户注册</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">手机号</label>
                    <input type="tel" id="regPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入11位手机号">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">用户名</label>
                    <input type="text" id="regName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入用户名">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">密码</label>
                    <input type="password" id="regPwd" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入密码（≥8位）">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">确认密码</label>
                    <input type="password" id="regConfirmPwd" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请再次输入密码">
                </div>
                <button onclick="registerUser()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary/90 transition">注册</button>
            </div>
            
            <div id="authMessage" class="mt-4 text-center"></div>
        </div>
    </div>

    <!-- 主应用页面 -->
    <div id="mainPage" class="hidden min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- 顶部导航 -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-primary">三江源生态智能问答平台</h1>
                    <div class="flex items-center gap-4">
                        <span id="userNameDisplay" class="text-lg font-medium"></span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">退出</button>
                    </div>
                </div>
            </div>

            <!-- 统计卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
                    <h3 class="text-lg font-semibold text-primary mb-2">生态监测点</h3>
                    <p id="statsEcological" class="text-3xl font-bold text-secondary">0</p>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
                    <h3 class="text-lg font-semibold text-primary mb-2">物种记录</h3>
                    <p id="statsSpecies" class="text-3xl font-bold text-secondary">0</p>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
                    <h3 class="text-lg font-semibold text-primary mb-2">用户问答</h3>
                    <p id="statsQA" class="text-3xl font-bold text-secondary">0</p>
                </div>
            </div>

            <!-- 数据可视化 -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4">生态数据趋势</h2>
                <canvas id="ecologicalChart" width="400" height="200"></canvas>
            </div>

            <!-- 数据面板 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- 生态数据 -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-primary mb-4">生态监测数据</h2>
                    <div id="ecologicalDataList" class="space-y-4"></div>
                </div>

                <!-- 物种记录 -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-primary mb-4">物种记录</h2>
                    <div id="speciesDataList" class="space-y-4"></div>
                </div>
            </div>

            <!-- 智能问答 -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4">智能问答</h2>
                <textarea id="questionInput" class="w-full h-32 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入关于三江源生态的问题..."></textarea>
                <button onclick="askQuestion()" class="mt-4 bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary/90 transition">提问</button>
                <div id="qaHistory" class="mt-6 space-y-4"></div>
            </div>

            <!-- 收藏管理 -->
            <div id="collectionsSection" class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-primary mb-4">我的收藏</h2>
                <div id="collectionsList"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== Supabase配置 ==========
        const SUPABASE_URL = 'https://pnakeholshmrtwctzqcb.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_tVf76wqdUIvhiNUymxKHEA_FAMmDvf3';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========== AI配置（百度文心一言）==========
        const AI_CONFIG = {
            apiKey: 'your-baidu-api-key',
            secretKey: 'your-baidu-secret-key',
            endpoint: 'https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions'
        };
        
        // 模拟AI回答
        async function getAIAnswer(question) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const knowledgeBase = {
                '珍稀物种': '三江源国家公园内分布有雪豹、藏羚羊、野牦牛、黑颈鹤等国家一级保护动物16种，国家二级保护动物41种。',
                '保护措施': '三江源实施生态修复、退牧还草、生态移民、社区共管、自然教育等保护措施，累计投入超过200亿元。',
                '中华水塔': '三江源是长江、黄河、澜沧江的发源地，年均向下游供水600亿立方米，被誉为“中华水塔”。',
                '植被覆盖': '三江源植被覆盖率达68.5%，其中高覆盖度草地占42.3%，是亚洲最重要的水源涵养区。',
                '气候变化': '近20年三江源气温上升1.2℃，年降水增加50mm，需加强气候适应性管理。'
            };
            
            for (const [key, answer] of Object.entries(knowledgeBase)) {
                if (question.includes(key)) return answer;
            }
            
            return '三江源位于青海省南部，是长江、黄河、澜沧江的发源地，被称为“中华水塔”，是中国重要的生态安全屏障。';
        }
        
        // ========== 图表配置 ==========
        let ecologicalChart = null;
        
        function initChart() {
            const ctx = document.getElementById('ecologicalChart').getContext('2d');
            ecologicalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '植被覆盖度 (%)',
                        data: [],
                        borderColor: '#0E7C7B',
                        backgroundColor: 'rgba(14, 124, 123, 0.1)',
                        tension: 0.4
                    }, {
                        label: '水质PH值',
                        data: [],
                        borderColor: '#41C9E2',
                        backgroundColor: 'rgba(65, 201, 226, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        
        async function loadChartData() {
            const { data, error } = await supabase
                .from('ecological_data')
                .select('record_date, data_type, value')
                .order('record_date', { ascending: true })
                .limit(30);
            
            if (error) return;
            
            const dates = [...new Set(data.map(item => item.record_date))];
            const vegetationData = data.filter(item => item.data_type === '植被覆盖度').map(item => item.value);
            const phData = data.filter(item => item.data_type === '水质PH值').map(item => item.value);
            
            ecologicalChart.data.labels = dates;
            ecologicalChart.data.datasets[0].data = vegetationData;
            ecologicalChart.data.datasets[1].data = phData;
            ecologicalChart.update();
        }
        
        // ========== 全局变量 ==========
        let currentUser = null;
        let currentSession = null;
        let dataCache = { ecological: null, species: null, collections: null };

        // ========== 标签切换 ==========
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.classList.add('border-primary', 'text-primary');
                loginTab.classList.remove('border-gray-200', 'text-gray-500');
                registerTab.classList.remove('border-primary', 'text-primary');
                registerTab.classList.add('border-gray-200', 'text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('border-primary', 'text-primary');
                registerTab.classList.remove('border-gray-200', 'text-gray-500');
                loginTab.classList.remove('border-primary', 'text-primary');
                loginTab.classList.add('border-gray-200', 'text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        // ========== 登录 ==========
        async function loginUser() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPwd').value.trim();
            const messageDiv = document.getElementById('authMessage');
            
            // 管理员登录
            if (phone === '18597123311' && password === 'Hm123321') {
                currentUser = { id: 'admin', phone: '18597123311', name: '管理员', is_admin: true };
                currentSession = { id: 'session-admin', user_id: 'admin' };
                showMainApp();
                return;
            }
            
            // 普通用户登录
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .eq('password_hash', password)
                    .single();
                
                if (error || !data) {
                    messageDiv.innerHTML = '<p class="text-red text-center">手机号或密码错误</p>';
                    return;
                }
                
                currentUser = data;
                showMainApp();
                messageDiv.innerHTML = '<p class="text-green text-center">登录成功！</p>';
                
            } catch (err) {
                messageDiv.innerHTML = `<p class="text-red text-center">登录失败: ${err.message}</p>`;
            }
        }

        // ========== 注册 ==========
        async function registerUser() {
            const phone = document.getElementById('regPhone').value.trim();
            const name = document.getElementById('regName').value.trim();
            const password = document.getElementById('regPwd').value.trim();
            const confirm = document.getElementById('regConfirmPwd').value.trim();
            const messageDiv = document.getElementById('authMessage');
            
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                messageDiv.innerHTML = '<p class="text-red text-center">请输入有效的手机号</p>';
                return;
            }
            
            if (password !== confirm) {
                messageDiv.innerHTML = '<p class="text-red text-center">两次密码不一致</p>';
                return;
            }
            
            try {
                const { data: existing } = await supabase
                    .from('users')
                    .select('phone')
                    .eq('phone', phone);
                
                if (existing && existing.length > 0) {
                    messageDiv.innerHTML = '<p class="text-red text-center">该手机号已注册</p>';
                    return;
                }
                
                const { data } = await supabase
                    .from('users')
                    .insert({
                        phone: phone,
                        name: name,
                        password_hash: password,
                        is_admin: false,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                messageDiv.innerHTML = '<p class="text-green text-center">注册成功！正在跳转登录...</p>';
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('regPhone').value = '';
                    document.getElementById('regName').value = '';
                    document.getElementById('regPwd').value = '';
                    document.getElementById('regConfirmPwd').value = '';
                }, 1500);
                
            } catch (err) {
                messageDiv.innerHTML = `<p class="text-red text-center">注册失败: ${err.message}</p>`;
            }
        }

        // ========== 显示主应用 ==========
        async function showMainApp() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            
            // 管理员不显示收藏功能
            if (currentUser.is_admin) {
                document.getElementById('collectionsSection').classList.add('hidden');
            } else {
                document.getElementById('collectionsSection').classList.remove('hidden');
            }
            
            await Promise.all([
                loadStats(),
                loadEcologicalData(),
                loadSpeciesData(),
                currentUser.is_admin ? Promise.resolve() : loadCollections(),
                loadChartData()
            ]);
        }

        // ========== 加载统计 ==========
        async function loadStats() {
            const { count: ecoCount } = await supabase.from('ecological_data').select('*', { count: 'exact', head: true });
            const { count: speciesCount } = await supabase.from('species_records').select('*', { count: 'exact', head: true });
            const { count: qaCount } = await supabase.from('qa_logs').select('*', { count: 'exact', head: true });
            
            document.getElementById('statsEcological').textContent = ecoCount;
            document.getElementById('statsSpecies').textContent = speciesCount;
            document.getElementById('statsQA').textContent = qaCount;
        }

        // ========== 加载生态数据 ==========
        async function loadEcologicalData() {
            if (dataCache.ecological) {
                renderEcologicalData(dataCache.ecological);
                return;
            }
            
            const { data, error } = await supabase.from('ecological_data').select('*').limit(10);
            
            if (error) {
                document.getElementById('ecologicalDataList').innerHTML = `<p class="text-red">加载失败: ${error.message}</p>`;
                return;
            }
            
            dataCache.ecological = data;
            renderEcologicalData(data);
        }
        
        function renderEcologicalData(data) {
            const div = document.getElementById('ecologicalDataList');
            div.innerHTML = data.map(item => `
                <div class="data-item border-b pb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-primary">${item.data_type}</h4>
                            <p class="text-sm text-gray-600">位置: ${item.location}</p>
                            <p class="text-sm text-gray-600">数值: ${item.value} ${item.unit}</p>
                            <p class="text-xs text-gray-400">日期: ${item.record_date}</p>
                        </div>
                        ${currentUser && !currentUser.is_admin ? `<button onclick="collectItem('生态数据', '${item.data_type}', '${item.location}')" class="text-yellow-500 hover:text-yellow-600">★ 收藏</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ========== 加载物种数据 ==========
        async function loadSpeciesData() {
            if (dataCache.species) {
                renderSpeciesData(dataCache.species);
                return;
            }
            
            const { data, error } = await supabase.from('species_records').select('*').limit(10);
            
            if (error) {
                document.getElementById('speciesDataList').innerHTML = `<p class="text-red">加载失败: ${error.message}</p>`;
                return;
            }
            
            dataCache.species = data;
            renderSpeciesData(data);
        }
        
        function renderSpeciesData(data) {
            const div = document.getElementById('speciesDataList');
            div.innerHTML = data.map(item => `
                <div class="data-item border-b pb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-primary">${item.species_name}</h4>
                            <p class="text-sm text-gray-600">数量: ${item.count}</p>
                            <p class="text-sm text-gray-600">位置: ${item.location}</p>
                            <p class="text-xs text-gray-400">日期: ${item.observation_date}</p>
                        </div>
                        ${currentUser && !currentUser.is_admin ? `<button onclick="collectItem('物种', '${item.species_name}', '数量: ${item.count}')" class="text-yellow-500 hover:text-yellow-600">★ 收藏</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ========== 智能问答 ==========
        async function askQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question) return;
            
            const qaHistory = document.getElementById('qaHistory');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'data-item text-center text-gray-500';
            loadingDiv.innerHTML = 'AI思考中...';
            qaHistory.insertBefore(loadingDiv, qaHistory.firstChild);
            
            const answer = await getAIAnswer(question);
            qaHistory.removeChild(loadingDiv);
            
            const qaItem = document.createElement('div');
            qaItem.className = 'data-item border-b pb-3';
            qaItem.innerHTML = `
                <p><strong>问:</strong> ${question}</p>
                <p><strong>答:</strong> ${answer}</p>
                <div class="text-right mt-2">
                    ${currentUser && !currentUser.is_admin ? `<button onclick="collectQA('${question}', '${answer}')" class="text-yellow-500 hover:text-yellow-600">★ 收藏</button>` : ''}
                </div>
            `;
            qaHistory.insertBefore(qaItem, qaHistory.firstChild);
            
            if (currentUser && !currentUser.is_admin) {
                await supabase.from('qa_logs').insert({
                    user_id: currentUser.id,
                    question: question,
                    answer: answer,
                    created_at: new Date().toISOString()
                });
            }
            
            input.value = '';
        }

        // ========== 收藏功能 ==========
        async function collectItem(type, title, content) {
            if (!currentUser || currentUser.is_admin) return;
            
            try {
                await supabase.from('collections').insert({
                    user_id: currentUser.id,
                    type: type,
                    title: title,
                    content: content,
                    created_at: new Date().toISOString()
                });
                
                alert('收藏成功！');
                loadCollections();
                dataCache.collections = null;
            } catch (err) {
                alert('收藏失败: ' + err.message);
            }
        }
        
        async function collectQA(question, answer) {
            await collectItem('问答', question.substring(0, 50) + '...', answer);
        }

        // ========== 加载收藏 ==========
        async function loadCollections() {
            if (!currentUser || currentUser.is_admin) {
                document.getElementById('collectionsList').innerHTML = '<p class="text-center text-gray-500">管理员无收藏功能</p>';
                return;
            }
            
            if (dataCache.collections) {
                renderCollections(dataCache.collections);
                return;
            }
            
            const { data, error } = await supabase
                .from('collections')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(20);
            
            if (error) {
                document.getElementById('collectionsList').innerHTML = `<p class="text-red">加载失败: ${error.message}</p>`;
                return;
            }
            
            dataCache.collections = data;
            renderCollections(data);
        }
        
        function renderCollections(data) {
            const div = document.getElementById('collectionsList');
            
            if (data.length === 0) {
                div.innerHTML = '<p class="text-center text-gray-500">暂无收藏</p>';
                return;
            }
            
            div.innerHTML = data.map(item => `
                <div class="data-item border-b pb-3">
                    <h4 class="font-bold">${item.title}</h4>
                    <p class="text-sm text-gray-600">${item.content}</p>
                    <p class="text-xs text-gray-400 mt-1">${item.created_at}</p>
                </div>
            `).join('');
        }

        // ========== 退出 ==========
        async function logout() {
            currentUser = null;
            currentSession = null;
            dataCache = { ecological: null, species: null, collections: null };
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
        }

        // ========== 页面加载 ==========
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”å¹³å°</title>
    
    <!-- åŸæœ‰CDNèµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

    <!-- Tailwindè‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
            .login-shadow { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
            .qa-item-user { @apply flex justify-start mb-4 animate-fadeIn; }
            .qa-content-user { @apply bg-gray-100 rounded-lg rounded-tl-none px-4 py-3 max-w-[80%] shadow-sm; }
            .qa-item-bot { @apply flex justify-end mb-4 animate-fadeIn; }
            .qa-content-bot { @apply bg-primary/10 rounded-lg rounded-tr-none px-4 py-3 max-w-[80%] shadow-sm border border-primary/20; }
            .loading-dot { @apply inline-block w-2 h-2 rounded-full bg-primary mx-0.5 animate-bounce; }
            .loading-dot:nth-child(2) { animation-delay: 0.2s; }
            .loading-dot:nth-child(3) { animation-delay: 0.4s; }
            .collect-btn { @apply text-gray-400 hover:text-yellow-500 transition-colors ml-2 cursor-pointer; }
            .collect-btn.active { @apply text-yellow-500; }
            .toast { @apply fixed bottom-6 left-1/2 -translate-x-1/2 bg-dark/80 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300 opacity-0 translate-y-4; }
            .toast.show { @apply opacity-100 translate-y-0; }
            .toast.error { @apply bg-red-500; }
            .admin-card { @apply bg-white rounded-xl shadow-lg p-6 mb-6; }
            .touchable { @apply min-h-[44px] flex items-center justify-center; }
            .admin-table { @apply w-full text-sm text-left text-gray-700; }
            .admin-table thead { @apply text-xs text-gray-700 uppercase bg-gray-100; }
            .admin-table th { @apply px-4 py-3; }
            .admin-table td { @apply px-4 py-3 border-b border-gray-200; }
            .tab-button { @apply px-4 py-2 rounded-lg transition-colors; }
            .tab-button.active { @apply bg-primary text-white; }
            .tab-button.inactive { @apply bg-gray-200 text-gray-700 hover:bg-gray-300; }
        }
    </style>

    <script>
        // Tailwindé…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0E7C7B',
                        secondary: '#41C9E2',
                        accent: '#A0D8B3',
                        dark: '#2C3E50',
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Microsoft YaHei', 'sans-serif'],
                    },
                    keyframes: {
                        fadeIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        },
                        shake: {
                            '0%,100%': { transform: 'translateX(0)' },
                            '20%,60%': { transform: 'translateX(-5px)' },
                            '40%,80%': { transform: 'translateX(5px)' }
                        }
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.3s ease-out',
                        'shake': 'shake 0.5s ease-in-out'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-cyan-50 to-green-50 text-dark min-h-screen">
    <!-- ç™»å½•æ³¨å†Œå¼¹çª— -->
    <div id="authPage" class="fixed inset-0 bg-dark/70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md login-shadow overflow-hidden transform transition-all duration-300">
            <div class="flex border-b border-gray-200">
                <button id="loginTab" class="flex-1 py-3 font-medium text-primary border-b-2 border-primary text-center transition-all touchable">
                    <i class="fa fa-sign-in mr-1"></i>ç™»å½•
                </button>
                <button id="registerTab" class="flex-1 py-3 font-medium text-gray-500 hover:text-primary text-center transition-all touchable">
                    <i class="fa fa-user-plus mr-1"></i>æ³¨å†Œ
                </button>
            </div>
            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm" class="p-6">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">ç”¨æˆ·ç™»å½•</h3>
                <div class="space-y-4">
                    <div>
                        <label for="loginPhone" class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æœºå·</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-phone"></i>
                            </span>
                            <input type="tel" id="loginPhone" placeholder="11ä½æ‰‹æœºå·" maxlength="11"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div>
                        <label for="loginPwd" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="loginPwd" placeholder="è‡³å°‘8ä½å¯†ç " maxlength="20"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div id="loginError" class="hidden text-red-500 text-sm text-center mt-1 py-2 bg-red-50 rounded-lg">æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯</div>
                    <button id="loginBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-colors touchable">ç™»å½•</button>
                    
                    <!-- ç®¡ç†å‘˜ç™»å½•æç¤º -->
                    <div class="text-center text-xs text-gray-500 mt-4 pt-4 border-t border-gray-200">
                        <p>ç®¡ç†å‘˜è´¦å·ï¼š18597123311 / Hm123321</p>
                    </div>
                </div>
            </div>
            <!-- æ³¨å†Œè¡¨å• -->
            <div id="registerForm" class="p-6 hidden">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">ç”¨æˆ·æ³¨å†Œ</h3>
                <div class="space-y-4">
                    <div>
                        <label for="regPhone" class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æœºå·</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-phone"></i>
                            </span>
                            <input type="tel" id="regPhone" placeholder="11ä½æ‰‹æœºå·" maxlength="11"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div>
                        <label for="regName" class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-user"></i>
                            </span>
                            <input type="text" id="regName" placeholder="1-20ä½ç”¨æˆ·å" maxlength="20"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div>
                        <label for="regPwd" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="regPwd" placeholder="è‡³å°‘8ä½å¯†ç " maxlength="20"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div>
                        <label for="regConfirmPwd" class="block text-sm font-medium text-gray-700 mb-1">ç¡®è®¤å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="regConfirmPwd" placeholder="å†æ¬¡è¾“å…¥å¯†ç " maxlength="20"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div id="regSuccess" class="hidden text-green-500 text-sm text-center mt-1 py-2 bg-green-50 rounded-lg">æ³¨å†ŒæˆåŠŸï¼å³å°†è·³è½¬ç™»å½•</div>
                    <button id="regBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-colors touchable">æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜ç•Œé¢ -->
    <div id="adminPage" class="hidden min-h-screen">
        <!-- ç®¡ç†å‘˜é¡¶éƒ¨å¯¼èˆª -->
        <nav class="sticky top-0 bg-dark text-white z-40 shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class="fa fa-shield text-xl"></i>
                    <h1 class="text-xl font-bold">ç®¡ç†åå°</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span id="adminName" class="font-medium">ç®¡ç†å‘˜ï¼šadmin</span>
                    <button onclick="adminLogout()" class="hover:text-accent transition-colors touchable">
                        <i class="fa fa-sign-out mr-1"></i>é€€å‡ºç®¡ç†
                    </button>
                </div>
            </div>
        </nav>

        <!-- ç®¡ç†å‘˜ä¸»å†…å®¹åŒº -->
        <div class="container mx-auto px-4 py-8">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="admin-card">
                    <div class="flex items-center">
                        <div class="bg-primary/10 p-3 rounded-lg mr-4">
                            <i class="fa fa-users text-primary text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">æ´»è·ƒç”¨æˆ·</p>
                            <p id="activeUsers" class="text-2xl font-bold text-primary">0</p>
                        </div>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="flex items-center">
                        <div class="bg-secondary/10 p-3 rounded-lg mr-4">
                            <i class="fa fa-sign-in text-secondary text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">æ€»ç™»å½•æ¬¡æ•°</p>
                            <p id="totalLogins" class="text-2xl font-bold text-secondary">0</p>
                        </div>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="flex items-center">
                        <div class="bg-accent/10 p-3 rounded-lg mr-4">
                            <i class="fa fa-clock-o text-accent text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">æ€»åœ¨çº¿æ—¶é•¿</p>
                            <p id="totalOnlineTime" class="text-2xl font-bold text-accent">0</p>
                        </div>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="flex items-center">
                        <div class="bg-purple-500/10 p-3 rounded-lg mr-4">
                            <i class="fa fa-bar-chart text-purple-500 text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">å¹³å‡æ—¶é•¿/æ¬¡</p>
                            <p id="avgSessionTime" class="text-2xl font-bold text-purple-500">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç† -->
            <div class="admin-card mb-6">
                <h2 class="text-xl font-bold text-primary mb-6">ç”¨æˆ·è´¦æˆ·ç®¡ç†</h2>
                
                <div class="overflow-x-auto">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>æ‰‹æœºå·</th>
                                <th>æ³¨å†Œæ—¶é—´</th>
                                <th>æœ€åç™»å½•</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userManagementTable">
                            <!-- æ•°æ®é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ç”¨æˆ·è¡Œä¸ºåˆ†æ -->
            <div class="admin-card mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-primary">ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡</h2>
                    <div class="flex space-x-2">
                        <button id="viewWeekly" class="tab-button active">
                            <i class="fa fa-calendar-week mr-2"></i>æœ¬å‘¨ç»Ÿè®¡
                        </button>
                        <button id="viewMonthly" class="tab-button inactive">
                            <i class="fa fa-calendar mr-2"></i>æœ¬æœˆç»Ÿè®¡
                        </button>
                    </div>
                </div>
                
                <!-- ç”¨æˆ·è¡Œä¸ºè¡¨æ ¼ -->
                <div class="overflow-x-auto">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·</th>
                                <th>æ‰‹æœºå·</th>
                                <th>æ€»ç™»å½•æ¬¡æ•°</th>
                                <th>æ€»åœ¨çº¿æ—¶é•¿</th>
                                <th>å¹³å‡æ—¶é•¿/æ¬¡</th>
                                <th id="periodLoginsHeader">æœ¬å‘¨ç™»å½•</th>
                                <th id="periodAvgTimeHeader">æœ¬å‘¨å¹³å‡æ—¶é•¿</th>
                                <th>å½“å‰çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="userBehaviorTable">
                            <!-- æ•°æ®é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å‘¨ç»Ÿè®¡å›¾è¡¨ -->
            <div class="admin-card">
                <h3 class="text-lg font-medium mb-4">æœ¬å‘¨æ´»è·ƒç”¨æˆ·è¶‹åŠ¿</h3>
                <div class="h-64">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™®é€šç”¨æˆ·ä¸»é¡µé¢ -->
    <div id="mainPage" class="hidden">
        <!-- é¡¶éƒ¨æ¨ªå¹… -->
        <header class="relative h-[40vh] min-h-[300px] bg-center bg-cover" style="background-image: url('https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80&sat=-30');">
            <div class="absolute inset-0 bg-gradient-to-t from-dark/70 to-dark/30 flex flex-col items-center justify-center text-white w-full">
                <h1 class="text-[clamp(1.8rem,4vw,3.5rem)] font-bold text-center text-shadow">ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”</h1>
                <p class="text-[clamp(1rem,2vw,1.5rem)] mt-3 text-center text-shadow">æ¢ç´¢ä¸­åæ°´å¡” Â· å®ˆæŠ¤é«˜åŸç”Ÿæ€</p>
                <div class="mt-4 text-white/80">
                    <i class="fa fa-mountain text-2xl"></i>
                    <i class="fa fa-water text-2xl mx-4"></i>
                    <i class="fa fa-leaf text-2xl"></i>
                </div>
            </div>
        </header>
        
        <!-- ç”¨æˆ·å¯¼èˆª -->
        <nav class="sticky top-0 bg-primary/90 backdrop-blur-sm text-white z-40 shadow-md">
            <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
                <div class="flex space-x-4 mb-2 md:mb-0">
                    <a href="#knowledge" class="hover:text-accent transition-colors font-medium">ç”Ÿæ€çŸ¥è¯†</a>
                    <a href="#qa" class="hover:text-accent transition-colors font-medium">æ™ºèƒ½é—®ç­”</a>
                    <a href="#collection" class="hover:text-accent transition-colors font-medium">æˆ‘çš„æ”¶è—</a>
                    <a href="#data" class="hover:text-accent transition-colors font-medium">ç”Ÿæ€æ•°æ®</a>
                </div>
                <div class="flex items-center gap-3">
                    <span id="userName" class="font-medium">æ¬¢è¿ä½ ï¼</span>
                    <button onclick="logout()" class="hover:text-accent transition-colors touchable">
                        <i class="fa fa-sign-out"></i> é€€å‡º
                    </button>
                </div>
            </div>
        </nav>

        <!-- ç”Ÿæ€çŸ¥è¯†åŒº -->
        <section id="knowledge" class="py-10 bg-white/90 backdrop-blur-sm">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">ä¸‰æ±Ÿæºå›½å®¶å…¬å›­æ ¸å¿ƒç”Ÿæ€æ•°æ®</h2>
                
                <div class="grid md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                    <!-- åŸºç¡€æ¦‚å†µ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-map-marker mr-2"></i>åœ°ç†æ¦‚å†µ
                        </h3>
                        <ul class="space-y-2 text-sm">
                            <li>ğŸ“ <strong>åœ°ç†ä½ç½®</strong>ï¼šé’æµ·çœå—éƒ¨ï¼Œé’è—é«˜åŸè…¹åœ°</li>
                            <li>ğŸ—ºï¸ <strong>æ¶µç›–èŒƒå›´</strong>ï¼šç‰æ ‘ã€æœæ´›ã€é»„å—ã€æµ·å—4å·åŠæ ¼å°”æœ¨å¸‚å”å¤æ‹‰å±±é•‡</li>
                            <li>ğŸ”ï¸ <strong>æµ·æ‹”èŒƒå›´</strong>ï¼š3335-6564ç±³ï¼ˆå¹³å‡4500ç±³ä»¥ä¸Šï¼‰</li>
                            <li>ğŸ’§ <strong>æ°´ç³»æ„æˆ</strong>ï¼šé•¿æ±Ÿæºã€é»„æ²³æºã€æ¾œæ²§æ±Ÿæº3å¤§å›­åŒº</li>
                            <li>ğŸŒ¿ <strong>æ€»é¢ç§¯</strong>ï¼š36.3ä¸‡å¹³æ–¹å…¬é‡Œï¼ˆä¿æŠ¤åŒºï¼‰<br>12.31ä¸‡å¹³æ–¹å…¬é‡Œï¼ˆå›½å®¶å…¬å›­ï¼‰</li>
                        </ul>
                    </div>
                    
                    <!-- ç”Ÿç‰©å¤šæ ·æ€§ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-paw mr-2"></i>ç”Ÿç‰©å¤šæ ·æ€§
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div><strong>ç‰©ç§æ€»æ•°</strong>ï¼šç»´ç®¡æ¤ç‰©2,238ç§ â€¢ è„Šæ¤åŠ¨ç‰©370ç§</div>
                            <div><strong>çç¨€æ¿’å±ç‰©ç§</strong>ï¼š
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>â€¢ å›½å®¶ä¸€çº§ä¿æŠ¤åŠ¨ç‰©ï¼š16ç§ï¼ˆé›ªè±¹ã€è—ç¾šç¾Šã€é‡ç‰¦ç‰›ç­‰ï¼‰</li>
                                    <li>â€¢ å›½å®¶äºŒçº§ä¿æŠ¤åŠ¨ç‰©ï¼š53ç§ï¼ˆè—åŸç¾šã€å²©ç¾Šã€è—ç‹ç­‰ï¼‰</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”Ÿæ€ä»·å€¼ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-chart-line mr-2"></i>ç”Ÿæ€æœåŠ¡ä»·å€¼
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div>ğŸ’§ <strong>æ°´æºæ¶µå…»</strong>ï¼šå¹´å‡å¾„æµé‡600äº¿ç«‹æ–¹ç±³</div>
                            <div>ğŸŒŠ <strong>æ°´é‡è´¡çŒ®</strong>ï¼šé•¿æ±Ÿ25% â€¢ é»„æ²³49% â€¢ æ¾œæ²§æ±Ÿ15%</div>
                            <div>ğŸŒ³ <strong>ç¢³æ±‡åŠŸèƒ½</strong>ï¼šå¹´å›ºç¢³1200ä¸‡å¨</div>
                            <div>ğŸ›¡ï¸ <strong>æ°´åœŸä¿æŒ</strong>ï¼šå‡å°‘ä¾µèš€3.8äº¿å¨/å¹´</div>
                        </div>
                    </div>
                    
                    <!-- ä¿æŠ¤æªæ–½ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-shield mr-2"></i>ä¿æŠ¤æªæ–½ä¸æˆæ•ˆ
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div>âœ… <strong>ç”Ÿæ€ä¿®å¤</strong>ï¼šæ²»ç†é»‘åœŸæ»©2.5ä¸‡kmÂ² â€¢ æ¢å¤æ¹¿åœ°1.6ä¸‡kmÂ²</div>
                            <div>âœ… <strong>é€€ç‰§è¿˜è‰</strong>ï¼šç¦ç‰§0.93äº¿äº© â€¢ ä¼‘ç‰§1.58äº¿äº©</div>
                            <div>âœ… <strong>ç¤¾åŒºå…±ç®¡</strong>ï¼šè®¾ç«‹ç”Ÿæ€ç®¡æŠ¤å‘˜17,211ä¸ª</div>
                            <div>ğŸ“ˆ <strong>ä¿æŠ¤æˆæ•ˆ</strong>ï¼šè‰åœ°ç›–åº¦æé«˜11% â€¢ æ°´æºæ¶µå…»é‡å¢6%/å¹´</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- æ™ºèƒ½é—®ç­”åŒº -->
        <section id="qa" class="py-10 bg-gradient-to-b from-blue-50/50 to-transparent">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">æ™ºèƒ½é—®ç­”</h2>
                <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden backdrop-blur-sm">
                    <div class="bg-primary text-white p-3 flex justify-between items-center">
                        <div class="flex items-center">
                            <span>å…³äºä¸‰æ±Ÿæºï¼Œéšæ—¶æé—®</span>
                        </div>
                    </div>
                    
                    <div id="chatBox" class="p-4 h-[50vh] overflow-y-auto space-y-4">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fa fa-comment-o text-3xl mb-2"></i>
                            <p>è¾“å…¥é—®é¢˜ï¼Œè·å–ä¸“ä¸šå›ç­”</p>
                            <p class="text-xs mt-2">ä¸“æ³¨äºä¸‰æ±Ÿæºç”Ÿæ€ä¿æŠ¤ç›¸å…³é—®é¢˜</p>
                        </div>
                    </div>
                    <div class="p-3 border-t flex">
                        <input type="text" id="questionInput" placeholder="è¾“å…¥å…³äºä¸‰æ±Ÿæºç”Ÿæ€ä¿æŠ¤çš„é—®é¢˜ï¼ˆæœ€å¤š100å­—ï¼‰" maxlength="100"
                               class="flex-1 px-3 py-2 rounded-l-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        <button onclick="askQuestion()" class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary/90 transition-colors touchable">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- é—®é¢˜å»ºè®® -->
                <div class="mt-6 max-w-2xl mx-auto">
                    <h3 class="text-sm font-medium text-gray-600 mb-2">æ‚¨å¯ä»¥æé—®ï¼š</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºæœ‰å“ªäº›çç¨€ç‰©ç§ï¼Ÿ')">çç¨€ç‰©ç§</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('å¦‚ä½•ä¿æŠ¤ä¸‰æ±Ÿæºç”Ÿæ€ç¯å¢ƒï¼Ÿ')">ä¿æŠ¤æªæ–½</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºä¸ºä»€ä¹ˆå«ä¸­åæ°´å¡”ï¼Ÿ')">ä¸­åæ°´å¡”</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºçš„æ°”å€™ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ')">æ°”å€™ç‰¹ç‚¹</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- æˆ‘çš„æ”¶è— -->
        <section id="collection" class="py-10 bg-gradient-to-b from-green-50/50 to-transparent">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">æˆ‘çš„æ”¶è—</h2>
                <div id="collectionBox" class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-5 min-h-[200px] backdrop-blur-sm">
                    <div class="text-center text-gray-400 py-8" id="emptyCollection">
                        <i class="fa fa-star-o text-3xl mb-2"></i>
                        <p>æš‚æ— æ”¶è—ï¼Œç‚¹å‡»å›ç­”æ—â­æ”¶è—</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç”Ÿæ€æ•°æ®åŒº -->
        <section id="data" class="py-10 bg-white/90 backdrop-blur-sm">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">ç”Ÿæ€ç›‘æµ‹æ•°æ®</h2>
                
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 max-w-4xl mx-auto">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-tree text-blue-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">ç”Ÿæ€ç›‘æµ‹ç‚¹</p>
                                <p id="statsEcological" class="text-2xl font-bold text-blue-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">å®æ—¶ç›‘æµ‹ç‚¹ä½</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-green-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-paw text-green-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">ç‰©ç§è®°å½•</p>
                                <p id="statsSpecies" class="text-2xl font-bold text-green-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">å·²è®°å½•ç‰©ç§æ•°é‡</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-purple-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-comments text-purple-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">ç”¨æˆ·é—®ç­”</p>
                                <p id="statsQA" class="text-2xl font-bold text-purple-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">å†å²é—®ç­”æ€»æ•°</p>
                    </div>
                </div>

                <!-- æ•°æ®é¢æ¿ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-4xl mx-auto">
                    <!-- ç”Ÿæ€æ•°æ® -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-medium mb-4 text-primary flex items-center">
                            <i class="fa fa-tree mr-2"></i>ç”Ÿæ€ç›‘æµ‹æ•°æ®
                        </h3>
                        <div id="ecologicalDataList" class="space-y-4"></div>
                    </div>

                    <!-- ç‰©ç§è®°å½• -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-medium mb-4 text-primary flex items-center">
                            <i class="fa fa-paw mr-2"></i>ç‰©ç§è®°å½•
                        </h3>
                        <div id="speciesDataList" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- åº•éƒ¨ -->
        <footer class="bg-dark text-white py-6 mt-auto">
            <div class="container mx-auto px-4 text-center text-sm">
                <p>ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”å¹³å° | ä»…ä¾›å­¦ä¹ æ¼”ç¤º</p>
                <p class="text-gray-400 mt-1">ä¿æŠ¤ä¸­åæ°´å¡”ï¼Œäººäººæœ‰è´£</p>
            </div>
        </footer>
    </div>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div id="changePasswordModal" class="fixed inset-0 bg-dark/70 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl w-full max-w-md login-shadow overflow-hidden">
            <div class="p-6">
                <h3 class="text-xl font-bold text-primary mb-4">ä¿®æ”¹ç”¨æˆ·å¯†ç </h3>
                <div id="changePasswordUserInfo" class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <!-- ç”¨æˆ·ä¿¡æ¯åŠ¨æ€å¡«å…… -->
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">æ–°å¯†ç </label>
                        <input type="password" id="newPassword" placeholder="è‡³å°‘8ä½å¯†ç "
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç "
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                    </div>
                    <div id="passwordChangeError" class="hidden text-red-500 text-sm text-center mt-1 py-2 bg-red-50 rounded-lg"></div>
                    <div class="flex gap-3">
                        <button onclick="confirmChangePassword()" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-colors">ç¡®è®¤ä¿®æ”¹</button>
                        <button onclick="closeChangePasswordModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteUserModal" class="fixed inset-0 bg-dark/70 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl w-full max-w-md login-shadow overflow-hidden">
            <div class="p-6">
                <h3 class="text-xl font-bold text-red-600 mb-4">åˆ é™¤ç”¨æˆ·</h3>
                <div id="deleteUserInfo" class="mb-6 p-3 bg-red-50 rounded-lg text-red-700">
                    <!-- ç”¨æˆ·ä¿¡æ¯åŠ¨æ€å¡«å…… -->
                </div>
                <p class="mb-4 text-gray-600">æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ç”¨æˆ·åŠå…¶æ‰€æœ‰æ•°æ®ï¼ˆä¼šè¯è®°å½•ã€é—®ç­”è®°å½•ã€æ”¶è—ï¼‰ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</p>
                <div class="flex gap-3">
                    <button onclick="confirmDeleteUser()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">ç¡®è®¤åˆ é™¤</button>
                    <button onclick="closeDeleteUserModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast" class="toast"></div>

    <script>
        // ========== Supabaseé…ç½® ==========
        const SUPABASE_URL = 'https://pnakeholshmrtwctzqcb.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_tVf76wqdUIvhiNUymxKHEA_FAMmDvf3';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========== ç®¡ç†å‘˜é…ç½® ==========
        const ADMIN_PHONE = '18597123311';
        const ADMIN_PASSWORD = 'Hm123321';
        
        // ========== å…¨å±€å˜é‡ ==========
        let currentUser = null;
        let isAdminMode = false;
        let dataCache = { ecological: null, species: null, collections: null };
        let currentEditingUserId = null;
        let currentDeletingUserId = null;
        let currentDeletingUserInfo = null;
        let userCharts = {};
        let currentViewMode = 'weekly';
        
        // ========== DOMç¼“å­˜ ==========
        const DOM = {
            authPage: document.getElementById('authPage'),
            mainPage: document.getElementById('mainPage'),
            adminPage: document.getElementById('adminPage'),
            loginTab: document.getElementById('loginTab'),
            registerTab: document.getElementById('registerTab'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            loginBtn: document.getElementById('loginBtn'),
            regBtn: document.getElementById('regBtn'),
            userName: document.getElementById('userName'),
            adminName: document.getElementById('adminName'),
            chatBox: document.getElementById('chatBox'),
            questionInput: document.getElementById('questionInput'),
            collectionBox: document.getElementById('collectionBox'),
            toast: document.getElementById('toast'),
            // ç®¡ç†å‘˜ç»Ÿè®¡
            activeUsers: document.getElementById('activeUsers'),
            totalLogins: document.getElementById('totalLogins'),
            totalOnlineTime: document.getElementById('totalOnlineTime'),
            avgSessionTime: document.getElementById('avgSessionTime'),
            // ç®¡ç†å‘˜è¡¨æ ¼
            userManagementTable: document.getElementById('userManagementTable'),
            userBehaviorTable: document.getElementById('userBehaviorTable'),
            periodLoginsHeader: document.getElementById('periodLoginsHeader'),
            periodAvgTimeHeader: document.getElementById('periodAvgTimeHeader'),
            // å›¾è¡¨
            weeklyChart: document.getElementById('weeklyChart'),
            // è§†å›¾åˆ‡æ¢
            viewWeekly: document.getElementById('viewWeekly'),
            viewMonthly: document.getElementById('viewMonthly'),
            // ç”¨æˆ·æ•°æ®
            statsEcological: document.getElementById('statsEcological'),
            statsSpecies: document.getElementById('statsSpecies'),
            statsQA: document.getElementById('statsQA')
        };

        // ========== å·¥å…·å‡½æ•° ==========
        function showToast(txt, type = 'success') {
            if (!DOM.toast) return;
            
            DOM.toast.textContent = txt;
            DOM.toast.className = 'toast show';
            if (type === 'error') DOM.toast.classList.add('error');
            setTimeout(() => {
                DOM.toast.classList.remove('show');
                DOM.toast.classList.remove('error');
            }, 2000);
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        function formatTimeShort(seconds) {
            if (!seconds || seconds < 0) return '0ç§’';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}æ—¶${minutes}åˆ†`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }

        // ========== ç™»å½•æ³¨å†Œç›¸å…³ ==========
        function switchTab(tab) {
            if (tab === 'login') {
                DOM.loginForm.classList.remove('hidden');
                DOM.registerForm.classList.add('hidden');
                DOM.loginTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                DOM.loginTab.classList.remove('text-gray-500');
                DOM.registerTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                DOM.registerTab.classList.add('text-gray-500');
            } else {
                DOM.registerForm.classList.remove('hidden');
                DOM.loginForm.classList.add('hidden');
                DOM.registerTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                DOM.registerTab.classList.remove('text-gray-500');
                DOM.loginTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                DOM.loginTab.classList.add('text-gray-500');
            }
        }

        async function login() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPwd').value.trim();
            
            if (!phone || !password) {
                showToast('è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ', 'error');
                return;
            }
            
            // ç®¡ç†å‘˜ç™»å½•
            if (phone === ADMIN_PHONE && password === ADMIN_PASSWORD) {
                currentUser = { id: 'admin', phone: ADMIN_PHONE, name: 'ç®¡ç†å‘˜', is_admin: true };
                isAdminMode = true;
                showAdminApp();
                showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                return;
            }
            
            // æ™®é€šç”¨æˆ·ç™»å½•
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .eq('password_hash', password)
                    .single();
                
                if (error || !data) {
                    document.getElementById('loginError').classList.remove('hidden');
                    showToast('æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯', 'error');
                    return;
                }
                
                currentUser = data;
                isAdminMode = false;
                showMainApp();
                showToast('ç™»å½•æˆåŠŸ');
                
                // è®°å½•ç™»å½•ä¼šè¯
                await supabase
                    .from('user_sessions')
                    .insert({
                        user_id: currentUser.id,
                        login_time: new Date().toISOString()
                    });
                
            } catch (err) {
                showToast(`ç™»å½•å¤±è´¥: ${err.message}`, 'error');
            }
        }

        async function register() {
            const phone = document.getElementById('regPhone').value.trim();
            const name = document.getElementById('regName').value.trim();
            const password = document.getElementById('regPwd').value.trim();
            const confirm = document.getElementById('regConfirmPwd').value.trim();
            
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·', 'error');
                return;
            }
            
            if (password.length < 8) {
                showToast('å¯†ç è‡³å°‘éœ€è¦8ä½', 'error');
                return;
            }
            
            if (password !== confirm) {
                showToast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            try {
                const { data: existing } = await supabase
                    .from('users')
                    .select('phone')
                    .eq('phone', phone);
                
                if (existing && existing.length > 0) {
                    showToast('è¯¥æ‰‹æœºå·å·²æ³¨å†Œ', 'error');
                    return;
                }
                
                const { data } = await supabase
                    .from('users')
                    .insert({
                        phone: phone,
                        name: name,
                        password_hash: password,
                        is_admin: false,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                document.getElementById('regSuccess').classList.remove('hidden');
                showToast('æ³¨å†ŒæˆåŠŸï¼');
                
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('regPhone').value = '';
                    document.getElementById('regName').value = '';
                    document.getElementById('regPwd').value = '';
                    document.getElementById('regConfirmPwd').value = '';
                    document.getElementById('regSuccess').classList.add('hidden');
                }, 1500);
                
            } catch (err) {
                showToast(`æ³¨å†Œå¤±è´¥: ${err.message}`, 'error');
            }
        }

        function logout() {
            if (currentUser && !isAdminMode) {
                // æ›´æ–°ä¼šè¯è®°å½•
                supabase
                    .from('user_sessions')
                    .update({
                        logout_time: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id)
                    .is('logout_time', null);
            }
            
            currentUser = null;
            isAdminMode = false;
            dataCache = { ecological: null, species: null, collections: null };
            DOM.authPage.classList.remove('hidden');
            DOM.mainPage.classList.add('hidden');
            showToast('å·²é€€å‡ºç™»å½•');
        }

        function adminLogout() {
            currentUser = null;
            isAdminMode = false;
            DOM.adminPage.classList.add('hidden');
            DOM.authPage.classList.remove('hidden');
            showToast('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
        }

        // ========== ä¸»åº”ç”¨æ˜¾ç¤º ==========
        async function showMainApp() {
            DOM.authPage.classList.add('hidden');
            DOM.mainPage.classList.remove('hidden');
            DOM.userName.textContent = `æ¬¢è¿ï¼Œ${currentUser.name}`;
            
            // åŠ è½½æ‰€æœ‰æ•°æ®
            await Promise.all([
                loadStats(),
                loadEcologicalData(),
                loadSpeciesData(),
                loadCollections(),
                loadQAHistory()
            ]);
        }

        async function showAdminApp() {
            DOM.authPage.classList.add('hidden');
            DOM.adminPage.classList.remove('hidden');
            DOM.adminName.textContent = `ç®¡ç†å‘˜ï¼š${currentUser.name}`;
            
            // åŠ è½½ç®¡ç†å‘˜æ•°æ®
            await Promise.all([
                loadAdminStats(),
                loadUserManagementTable(),
                loadUserBehaviorTable(),
                loadWeeklyChart()
            ]);
        }

        // ========== æ™®é€šç”¨æˆ·åŠŸèƒ½ ==========
        async function loadStats() {
            try {
                const { count: ecoCount } = await supabase.from('ecological_data').select('*', { count: 'exact', head: true });
                const { count: speciesCount } = await supabase.from('species_records').select('*', { count: 'exact', head: true });
                const { count: qaCount } = await supabase.from('qa_logs').select('*', { count: 'exact', head: true });
                
                if (DOM.statsEcological) DOM.statsEcological.textContent = ecoCount;
                if (DOM.statsSpecies) DOM.statsSpecies.textContent = speciesCount;
                if (DOM.statsQA) DOM.statsQA.textContent = qaCount;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        async function loadEcologicalData() {
            if (dataCache.ecological) {
                renderEcologicalData(dataCache.ecological);
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('ecological_data')
                    .select('*')
                    .order('record_date', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                dataCache.ecological = data;
                renderEcologicalData(data);
            } catch (error) {
                console.error('åŠ è½½ç”Ÿæ€æ•°æ®å¤±è´¥:', error);
                const div = document.getElementById('ecologicalDataList');
                if (div) div.innerHTML = `<p class="text-red-500 text-center">åŠ è½½å¤±è´¥</p>`;
            }
        }
        
        function renderEcologicalData(data) {
            const div = document.getElementById('ecologicalDataList');
            if (!div) return;
            
            if (!data || data.length === 0) {
                div.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— æ•°æ®</p>';
                return;
            }
            
            div.innerHTML = data.map(item => `
                <div class="data-item border-b pb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-primary">${item.data_type}</h4>
                            <p class="text-sm text-gray-600">ä½ç½®: ${item.location}</p>
                            <p class="text-sm text-gray-600">æ•°å€¼: ${item.value} ${item.unit}</p>
                            <p class="text-xs text-gray-400">æ—¥æœŸ: ${item.record_date}</p>
                        </div>
                        ${currentUser && !currentUser.is_admin ? 
                            `<button onclick="collectItem('ç”Ÿæ€æ•°æ®', '${item.data_type}', '${item.location}')" 
                                class="text-yellow-500 hover:text-yellow-600">
                                <i class="fa fa-star"></i>
                            </button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadSpeciesData() {
            if (dataCache.species) {
                renderSpeciesData(dataCache.species);
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('species_records')
                    .select('*')
                    .order('observation_date', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                dataCache.species = data;
                renderSpeciesData(data);
            } catch (error) {
                console.error('åŠ è½½ç‰©ç§æ•°æ®å¤±è´¥:', error);
                const div = document.getElementById('speciesDataList');
                if (div) div.innerHTML = `<p class="text-red-500 text-center">åŠ è½½å¤±è´¥</p>`;
            }
        }
        
        function renderSpeciesData(data) {
            const div = document.getElementById('speciesDataList');
            if (!div) return;
            
            if (!data || data.length === 0) {
                div.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— æ•°æ®</p>';
                return;
            }
            
            div.innerHTML = data.map(item => `
                <div class="data-item border-b pb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-primary">${item.species_name}</h4>
                            <p class="text-sm text-gray-600">æ•°é‡: ${item.count}</p>
                            <p class="text-sm text-gray-600">ä½ç½®: ${item.location}</p>
                            <p class="text-xs text-gray-400">æ—¥æœŸ: ${item.observation_date}</p>
                        </div>
                        ${currentUser && !currentUser.is_admin ? 
                            `<button onclick="collectItem('ç‰©ç§', '${item.species_name}', 'æ•°é‡: ${item.count}')" 
                                class="text-yellow-500 hover:text-yellow-600">
                                <i class="fa fa-star"></i>
                            </button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function fillQuestion(question) {
            if (DOM.questionInput) {
                DOM.questionInput.value = question;
                DOM.questionInput.focus();
            }
        }

        // æ¨¡æ‹ŸAIå›ç­”
        async function getAIAnswer(question) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const knowledgeBase = {
                'çç¨€ç‰©ç§': 'ä¸‰æ±Ÿæºå›½å®¶å…¬å›­å†…åˆ†å¸ƒæœ‰é›ªè±¹ã€è—ç¾šç¾Šã€é‡ç‰¦ç‰›ã€é»‘é¢ˆé¹¤ç­‰å›½å®¶ä¸€çº§ä¿æŠ¤åŠ¨ç‰©16ç§ï¼Œå›½å®¶äºŒçº§ä¿æŠ¤åŠ¨ç‰©41ç§ã€‚',
                'ä¿æŠ¤æªæ–½': 'ä¸‰æ±Ÿæºå®æ–½ç”Ÿæ€ä¿®å¤ã€é€€ç‰§è¿˜è‰ã€ç”Ÿæ€ç§»æ°‘ã€ç¤¾åŒºå…±ç®¡ã€è‡ªç„¶æ•™è‚²ç­‰ä¿æŠ¤æªæ–½ï¼Œç´¯è®¡æŠ•å…¥è¶…è¿‡200äº¿å…ƒã€‚',
                'ä¸­åæ°´å¡”': 'ä¸‰æ±Ÿæºæ˜¯é•¿æ±Ÿã€é»„æ²³ã€æ¾œæ²§æ±Ÿçš„å‘æºåœ°ï¼Œå¹´å‡å‘ä¸‹æ¸¸ä¾›æ°´600äº¿ç«‹æ–¹ç±³ï¼Œè¢«èª‰ä¸º"ä¸­åæ°´å¡”"ã€‚',
                'æ¤è¢«è¦†ç›–': 'ä¸‰æ±Ÿæºæ¤è¢«è¦†ç›–ç‡è¾¾68.5%ï¼Œå…¶ä¸­é«˜è¦†ç›–åº¦è‰åœ°å 42.3%ï¼Œæ˜¯äºšæ´²æœ€é‡è¦çš„æ°´æºæ¶µå…»åŒºã€‚',
                'æ°”å€™å˜åŒ–': 'è¿‘20å¹´ä¸‰æ±Ÿæºæ°”æ¸©ä¸Šå‡1.2â„ƒï¼Œå¹´é™æ°´å¢åŠ 50mmï¼Œéœ€åŠ å¼ºæ°”å€™é€‚åº”æ€§ç®¡ç†ã€‚',
                'åœ°ç†ä½ç½®': 'ä¸‰æ±Ÿæºä½äºé’æµ·çœå—éƒ¨ï¼Œé’è—é«˜åŸè…¹åœ°ï¼Œåœ°ç†åæ ‡ä¸ºä¸œç»89Â°45â€²â€”102Â°23â€²ï¼ŒåŒ—çº¬31Â°39â€²â€”36Â°12â€²ã€‚',
                'ç”Ÿæ€ä»·å€¼': 'ä¸‰æ±Ÿæºçš„ç”Ÿæ€ä»·å€¼åŒ…æ‹¬æ°´æºæ¶µå…»ã€ç”Ÿç‰©å¤šæ ·æ€§ä¿æŠ¤ã€ç¢³æ±‡åŠŸèƒ½ã€æ°”å€™è°ƒèŠ‚å’Œç”Ÿæ€å®‰å…¨å±éšœä½œç”¨ã€‚'
            };
            
            const questionLower = question.toLowerCase();
            
            for (const [key, answer] of Object.entries(knowledgeBase)) {
                if (questionLower.includes(key.toLowerCase())) {
                    return answer;
                }
            }
            
            return 'ä¸‰æ±Ÿæºä½äºé’æµ·çœå—éƒ¨ï¼Œæ˜¯é•¿æ±Ÿã€é»„æ²³ã€æ¾œæ²§æ±Ÿçš„å‘æºåœ°ï¼Œè¢«ç§°ä¸º"ä¸­åæ°´å¡”"ï¼Œæ˜¯ä¸­å›½é‡è¦çš„ç”Ÿæ€å®‰å…¨å±éšœã€‚';
        }

        async function askQuestion() {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const question = DOM.questionInput.value.trim();
            if (!question || question.length > 100) {
                showToast('è¯·è¾“å…¥1-100å­—çš„é—®é¢˜', 'error');
                return;
            }
            
            DOM.questionInput.value = '';
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            // æ·»åŠ ç”¨æˆ·é—®é¢˜
            const userHtml = `<div class="qa-item-user"><div class="qa-content-user"><div class="text-sm text-gray-500">æˆ‘ ${time}</div><div class="mt-1">${question}</div></div></div>`;
            DOM.chatBox.insertAdjacentHTML('beforeend', userHtml);
            
            // æ·»åŠ åŠ è½½åŠ¨ç”»
            const loadingHtml = `<div class="qa-item-bot" id="loading"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1 flex items-center"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span><span class="ml-2">æ€è€ƒä¸­...</span></div></div></div>`;
            DOM.chatBox.insertAdjacentHTML('beforeend', loadingHtml);
            DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
            
            try {
                const answer = await getAIAnswer(question);
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.remove();
                
                // æ·»åŠ AIå›ç­”
                const safeQuestion = question.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeAnswer = answer.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                const answerHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1">${answer}</div><i class="fa fa-star collect-btn" onclick="toggleCollect(this,'${safeQuestion}','${safeAnswer}')"></i></div></div>`;
                DOM.chatBox.insertAdjacentHTML('beforeend', answerHtml);
                DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
                
                // ä¿å­˜é—®ç­”è®°å½•
                await supabase.from('qa_logs').insert({
                    user_id: currentUser.id,
                    question: question,
                    answer: answer,
                    created_at: new Date().toISOString()
                });
                
                // æ›´æ–°ç»Ÿè®¡
                loadStats();
                
            } catch (error) {
                console.error('è·å–ç­”æ¡ˆå¤±è´¥:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.remove();
                
                const errorHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1 text-red-500">æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚</div></div></div>`;
                DOM.chatBox.insertAdjacentHTML('beforeend', errorHtml);
                DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
            }
        }

        // ========== æ”¶è—åŠŸèƒ½ ==========
        async function collectItem(type, title, content) {
            if (!currentUser || currentUser.is_admin) {
                showToast('ç®¡ç†å‘˜æ— æ”¶è—åŠŸèƒ½', 'error');
                return;
            }
            
            try {
                await supabase.from('collections').insert({
                    user_id: currentUser.id,
                    type: type,
                    title: title,
                    content: content,
                    created_at: new Date().toISOString()
                });
                
                showToast('æ”¶è—æˆåŠŸï¼');
                loadCollections();
                dataCache.collections = null;
            } catch (err) {
                showToast('æ”¶è—å¤±è´¥: ' + err.message, 'error');
            }
        }

        async function toggleCollect(el, question, answer) {
            if (!currentUser || currentUser.is_admin) {
                showToast('ç®¡ç†å‘˜æ— æ”¶è—åŠŸèƒ½', 'error');
                return;
            }
            
            const decodedQuestion = question.replace(/\\'/g, "'").replace(/&quot;/g, '"');
            const decodedAnswer = answer.replace(/\\'/g, "'").replace(/&quot;/g, '"');
            
            // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
            const { data: existing } = await supabase
                .from('collections')
                .select('id')
                .eq('user_id', currentUser.id)
                .eq('question', decodedQuestion)
                .single();
            
            if (existing) {
                // å–æ¶ˆæ”¶è—
                await supabase.from('collections').delete().eq('id', existing.id);
                el.classList.remove('active');
                showToast('å–æ¶ˆæ”¶è—');
            } else {
                // æ·»åŠ æ”¶è—
                await supabase.from('collections').insert({
                    user_id: currentUser.id,
                    question: decodedQuestion,
                    answer: decodedAnswer,
                    created_at: new Date().toISOString()
                });
                el.classList.add('active');
                showToast('æ”¶è—æˆåŠŸï¼');
            }
            
            loadCollections();
            dataCache.collections = null;
        }

        async function loadCollections() {
            if (!currentUser || currentUser.is_admin) return;
            
            if (dataCache.collections) {
                renderCollections(dataCache.collections);
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('collections')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                dataCache.collections = data;
                renderCollections(data);
            } catch (error) {
                console.error('åŠ è½½æ”¶è—å¤±è´¥:', error);
            }
        }

        function renderCollections(data) {
            const div = document.getElementById('collectionBox');
            if (!div) return;
            
            if (!data || data.length === 0) {
                div.innerHTML = `<div class="text-center text-gray-400 py-8" id="emptyCollection"><i class="fa fa-star-o text-3xl mb-2"></i><p>æš‚æ— æ”¶è—ï¼Œç‚¹å‡»å›ç­”æ—â­æ”¶è—</p></div>`;
                return;
            }
            
            div.innerHTML = data.map(item => `
                <div class="p-3 border-b border-gray-100 last:border-0">
                    <div class="font-medium text-primary">${item.question.substring(0, 50)}${item.question.length > 50 ? '...' : ''}</div>
                    <div class="mt-1 text-gray-600 text-sm">${item.answer.substring(0, 100)}${item.answer.length > 100 ? '...' : ''}</div>
                    <button class="mt-2 text-xs text-red-500" onclick="deleteCollect('${item.id}')">åˆ é™¤</button>
                </div>
            `).join('');
        }

        async function deleteCollect(id) {
            try {
                await supabase.from('collections').delete().eq('id', id);
                showToast('å·²åˆ é™¤æ”¶è—');
                loadCollections();
                dataCache.collections = null;
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== åŠ è½½é—®ç­”å†å² ==========
        async function loadQAHistory() {
            if (!currentUser || currentUser.is_admin) return;
            
            try {
                const { data, error } = await supabase
                    .from('qa_logs')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                DOM.chatBox.innerHTML = '';
                
                if (!data || data.length === 0) {
                    DOM.chatBox.innerHTML = `<div class="text-center text-gray-400 py-8"><i class="fa fa-comment-o text-3xl mb-2"></i><p>è¾“å…¥é—®é¢˜ï¼Œè·å–ä¸“ä¸šå›ç­”</p><p class="text-xs mt-2">ä¸“æ³¨äºä¸‰æ±Ÿæºç”Ÿæ€ä¿æŠ¤ç›¸å…³é—®é¢˜</p></div>`;
                    return;
                }
                
                data.reverse().forEach(item => {
                    const time = new Date(item.created_at).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    
                    const userHtml = `<div class="qa-item-user"><div class="qa-content-user"><div class="text-sm text-gray-500">æˆ‘ ${time}</div><div class="mt-1">${item.question}</div></div></div>`;
                    DOM.chatBox.insertAdjacentHTML('beforeend', userHtml);
                    
                    // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
                    supabase
                        .from('collections')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('question', item.question)
                        .single()
                        .then(({ data: existing }) => {
                            const collectClass = existing ? 'collect-btn active' : 'collect-btn';
                            const safeQuestion = item.question.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            const safeAnswer = item.answer.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            
                            const answerHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1">${item.answer}</div><i class="fa fa-star ${collectClass}" onclick="toggleCollect(this,'${safeQuestion}','${safeAnswer}')"></i></div></div>`;
                            DOM.chatBox.insertAdjacentHTML('beforeend', answerHtml);
                            DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
                        });
                });
                
            } catch (error) {
                console.error('åŠ è½½é—®ç­”å†å²å¤±è´¥:', error);
            }
        }

        // ========== ç®¡ç†å‘˜åŠŸèƒ½ ==========
        async function loadAdminStats() {
            try {
                // ä½¿ç”¨è§†å›¾è·å–ç®¡ç†å‘˜ç»Ÿè®¡
                const { data, error } = await supabase
                    .from('admin_stats')
                    .select('*')
                    .single();
                
                if (error) throw error;
                
                if (DOM.activeUsers) DOM.activeUsers.textContent = data.active_users_30d || 0;
                if (DOM.totalLogins) DOM.totalLogins.textContent = data.total_logins || 0;
                if (DOM.totalOnlineTime) DOM.totalOnlineTime.textContent = formatTimeShort(data.total_duration || 0);
                if (DOM.avgSessionTime) DOM.avgSessionTime.textContent = formatTimeShort(data.avg_session_duration || 0);
                
            } catch (error) {
                console.error('åŠ è½½ç®¡ç†å‘˜ç»Ÿè®¡å¤±è´¥:', error);
                showToast('åŠ è½½ç»Ÿè®¡å¤±è´¥', 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·ç®¡ç†è¡¨æ ¼
        async function loadUserManagementTable() {
            if (!DOM.userManagementTable) return;
            
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, phone, name, is_admin, created_at')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const table = DOM.userManagementTable;
                table.innerHTML = '';
                
                // æ’é™¤ç®¡ç†å‘˜è‡ªå·±
                const filteredUsers = users.filter(user => 
                    user.phone !== ADMIN_PHONE && !user.is_admin
                );
                
                if (filteredUsers.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                <i class="fa fa-users text-2xl mb-2 block"></i>
                                <p>æš‚æ— æ™®é€šç”¨æˆ·</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                for (const user of filteredUsers) {
                    const row = document.createElement('tr');
                    const createdAt = formatDate(user.created_at);
                    
                    // è·å–æœ€åç™»å½•æ—¶é—´
                    const { data: lastSession } = await supabase
                        .from('user_sessions')
                        .select('login_time')
                        .eq('user_id', user.id)
                        .order('login_time', { ascending: false })
                        .limit(1)
                        .single();
                    
                    const lastLogin = lastSession ? new Date(lastSession.login_time).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }) : 'ä»æœªç™»å½•';
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨çº¿
                    const { data: activeSession } = await supabase
                        .from('user_sessions')
                        .select('id')
                        .eq('user_id', user.id)
                        .is('logout_time', null)
                        .limit(1)
                        .single();
                    
                    const status = activeSession ? 
                        '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">åœ¨çº¿</span>' : 
                        '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded">ç¦»çº¿</span>';
                    
                    row.innerHTML = `
                        <td class="font-medium">${user.name}</td>
                        <td class="font-mono text-sm">${user.phone}</td>
                        <td class="text-sm">${createdAt}</td>
                        <td class="text-sm">${lastLogin}</td>
                        <td>${status}</td>
                        <td>
                            <div class="flex gap-2">
                                <button onclick="showChangePasswordModal('${user.id}', '${user.name}', '${user.phone}')" 
                                        class="px-3 py-1 bg-yellow-500 text-white text-sm rounded hover:bg-yellow-600 transition-colors">
                                    æ”¹å¯†ç 
                                </button>
                                <button onclick="showDeleteUserModal('${user.id}', '${user.name}', '${user.phone}')" 
                                        class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors">
                                    åˆ é™¤
                                </button>
                            </div>
                        </td>
                    `;
                    table.appendChild(row);
                }
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ç®¡ç†è¡¨æ ¼å¤±è´¥:', error);
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-red-500">
                            <i class="fa fa-exclamation-triangle text-2xl mb-2 block"></i>
                            <p>åŠ è½½å¤±è´¥</p>
                        </td>
                    </tr>
                `;
            }
        }

        // åŠ è½½ç”¨æˆ·è¡Œä¸ºè¡¨æ ¼
        async function loadUserBehaviorTable() {
            if (!DOM.userBehaviorTable) return;
            
            try {
                // ä½¿ç”¨è§†å›¾è·å–ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡
                const { data: users, error } = await supabase
                    .from('user_behavior_stats')
                    .select('*')
                    .eq('is_admin', false)
                    .order('total_logins', { ascending: false });
                
                if (error) throw error;
                
                const table = DOM.userBehaviorTable;
                table.innerHTML = '';
                
                if (!users || users.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                <i class="fa fa-users text-2xl mb-2 block"></i>
                                <p>æš‚æ— ç”¨æˆ·æ•°æ®</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                users.forEach(user => {
                    // æ ¹æ®å½“å‰è§†å›¾æ¨¡å¼é€‰æ‹©æ˜¾ç¤ºçš„æ•°æ®
                    let periodLogins, periodAvgTime;
                    if (currentViewMode === 'weekly') {
                        periodLogins = user.weekly_logins;
                        periodAvgTime = formatTimeShort(user.weekly_avg_duration);
                    } else {
                        periodLogins = user.monthly_logins;
                        periodAvgTime = formatTimeShort(user.monthly_avg_duration);
                    }
                    
                    const status = user.is_online ? 
                        '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">åœ¨çº¿</span>' : 
                        '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded">ç¦»çº¿</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${user.name}</td>
                        <td class="font-mono text-sm">${user.phone}</td>
                        <td class="text-center">${user.total_logins}</td>
                        <td class="font-mono">${formatTimeShort(user.total_duration)}</td>
                        <td class="font-mono">${formatTimeShort(user.avg_duration)}</td>
                        <td class="text-center">${periodLogins}</td>
                        <td class="font-mono">${periodAvgTime}</td>
                        <td>${status}</td>
                    `;
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·è¡Œä¸ºè¡¨æ ¼å¤±è´¥:', error);
            }
        }

        // è§†å›¾åˆ‡æ¢
        function switchAdminView(mode) {
            currentViewMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (DOM.viewWeekly && DOM.viewMonthly) {
                if (mode === 'weekly') {
                    DOM.viewWeekly.classList.remove('inactive');
                    DOM.viewWeekly.classList.add('active');
                    DOM.viewMonthly.classList.remove('active');
                    DOM.viewMonthly.classList.add('inactive');
                    
                    if (DOM.periodLoginsHeader) DOM.periodLoginsHeader.textContent = 'æœ¬å‘¨ç™»å½•';
                    if (DOM.periodAvgTimeHeader) DOM.periodAvgTimeHeader.textContent = 'æœ¬å‘¨å¹³å‡æ—¶é•¿';
                } else {
                    DOM.viewMonthly.classList.remove('inactive');
                    DOM.viewMonthly.classList.add('active');
                    DOM.viewWeekly.classList.remove('active');
                    DOM.viewWeekly.classList.add('inactive');
                    
                    if (DOM.periodLoginsHeader) DOM.periodLoginsHeader.textContent = 'æœ¬æœˆç™»å½•';
                    if (DOM.periodAvgTimeHeader) DOM.periodAvgTimeHeader.textContent = 'æœ¬æœˆå¹³å‡æ—¶é•¿';
                }
            }
            
            loadUserBehaviorTable();
        }

        // åŠ è½½å‘¨ç»Ÿè®¡å›¾è¡¨
        async function loadWeeklyChart() {
            const ctx = DOM.weeklyChart?.getContext('2d');
            if (!ctx) return;
            
            try {
                // è·å–å‘¨æ´»è·ƒæ•°æ®
                const { data, error } = await supabase
                    .from('weekly_activity')
                    .select('*')
                    .order('activity_date', { ascending: true });
                
                if (error) throw error;
                
                // å‡†å¤‡å›¾è¡¨æ•°æ®
                const labels = data.map(item => item.day_of_week);
                const activeUsers = data.map(item => item.active_users);
                
                // é”€æ¯æ—§å›¾è¡¨
                if (userCharts.weeklyChart) {
                    userCharts.weeklyChart.destroy();
                }
                
                userCharts.weeklyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ´»è·ƒç”¨æˆ·æ•°',
                            data: activeUsers,
                            backgroundColor: '#0E7C7B',
                            borderColor: '#0E7C7B',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    precision: 0
                                },
                                title: {
                                    display: true,
                                    text: 'ç”¨æˆ·æ•°'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ˜ŸæœŸ'
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('åŠ è½½å‘¨ç»Ÿè®¡å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // ========== ç”¨æˆ·ç®¡ç†åŠŸèƒ½ ==========
        function showChangePasswordModal(userId, userName, userPhone) {
            currentEditingUserId = userId;
            
            const userInfoDiv = document.getElementById('changePasswordUserInfo');
            userInfoDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="bg-primary/10 p-2 rounded-lg mr-3">
                        <i class="fa fa-user text-primary"></i>
                    </div>
                    <div>
                        <p class="font-medium">${userName}</p>
                        <p class="text-sm text-gray-600">æ‰‹æœºå·: ${userPhone}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            const errorDiv = document.getElementById('passwordChangeError');
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
            
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            currentEditingUserId = null;
        }

        async function confirmChangePassword() {
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            const errorDiv = document.getElementById('passwordChangeError');
            
            // éªŒè¯
            if (newPassword.length < 8) {
                errorDiv.textContent = 'å¯†ç è‡³å°‘éœ€è¦8ä½';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ password_hash: newPassword })
                    .eq('id', currentEditingUserId);
                
                if (error) throw error;
                
                showToast('å¯†ç ä¿®æ”¹æˆåŠŸ');
                closeChangePasswordModal();
                
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                errorDiv.textContent = 'ä¿®æ”¹å¤±è´¥: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        function showDeleteUserModal(userId, userName, userPhone) {
            currentDeletingUserId = userId;
            currentDeletingUserInfo = { name: userName, phone: userPhone };
            
            const userInfoDiv = document.getElementById('deleteUserInfo');
            userInfoDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="bg-red-100 p-2 rounded-lg mr-3">
                        <i class="fa fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <div>
                        <p class="font-medium">${userName}</p>
                        <p class="text-sm">æ‰‹æœºå·: ${userPhone}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('deleteUserModal').classList.remove('hidden');
        }

        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.add('hidden');
            currentDeletingUserId = null;
            currentDeletingUserInfo = null;
        }

        async function confirmDeleteUser() {
            if (!currentDeletingUserId || !currentDeletingUserInfo) return;
            
            try {
                // åˆ é™¤ç”¨æˆ·ï¼ˆæ•°æ®åº“è®¾ç½®äº†çº§è”åˆ é™¤ï¼Œä¼šè‡ªåŠ¨åˆ é™¤ç›¸å…³è®°å½•ï¼‰
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', currentDeletingUserId);
                
                if (error) throw error;
                
                showToast(`ç”¨æˆ· ${currentDeletingUserInfo.name} å·²åˆ é™¤`);
                closeDeleteUserModal();
                
                // é‡æ–°åŠ è½½è¡¨æ ¼
                await loadUserManagementTable();
                await loadUserBehaviorTable();
                await loadAdminStats();
                
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== åˆå§‹åŒ– ==========
        async function initApp() {
            // ç»‘å®šäº‹ä»¶
            DOM.loginTab?.addEventListener('click', () => switchTab('login'));
            DOM.registerTab?.addEventListener('click', () => switchTab('register'));
            DOM.loginBtn?.addEventListener('click', login);
            DOM.regBtn?.addEventListener('click', register);
            
            // ä¸ºè¾“å…¥æ¡†æ·»åŠ Enteré”®æ”¯æŒ
            document.getElementById('loginPwd')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('regConfirmPwd')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
            
            DOM.questionInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') askQuestion();
            });
            
            // ç®¡ç†å‘˜è§†å›¾åˆ‡æ¢
            DOM.viewWeekly?.addEventListener('click', () => switchAdminView('weekly'));
            DOM.viewMonthly?.addEventListener('click', () => switchAdminView('monthly'));
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆå¯ä»¥ä»localStorageæ¢å¤ï¼‰
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    currentUser = userData.user;
                    isAdminMode = userData.isAdminMode || false;
                    
                    if (isAdminMode) {
                        await showAdminApp();
                    } else {
                        await showMainApp();
                    }
                } catch (error) {
                    console.error('æ¢å¤ç”¨æˆ·ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                    localStorage.removeItem('currentUser');
                }
            }
            
            // é¡µé¢å¸è½½æ—¶ä¿å­˜ç™»å½•çŠ¶æ€
            window.addEventListener('beforeunload', function() {
                if (currentUser) {
                    localStorage.setItem('currentUser', JSON.stringify({
                        user: currentUser,
                        isAdminMode: isAdminMode
                    }));
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

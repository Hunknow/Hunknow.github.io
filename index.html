<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三江源生态智能问答平台</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 50%, #c8e6c9 100%); min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 10px; padding: 30px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { padding: 12px 24px; background: #0E7C7B; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #0b6a69; }
        .input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .tab { display: inline-block; padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #0E7C7B; color: #0E7C7B; }
        .hidden { display: none; }
        .text-center { text-align: center; }
        .text-red { color: #e53e3e; }
        .text-green { color: #38a169; }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }
        .flex { display: flex; gap: 10px; }
        .small-text { font-size: 14px; color: #666; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 认证区域 -->
        <div id="authSection" class="card">
            <h1 class="text-center mb-4">三江源生态智能问答平台</h1>
            
            <!-- 标签切换 -->
            <div class="text-center mb-4">
                <span class="tab active" onclick="switchTab('login')">登录</span>
                <span class="tab" onclick="switchTab('register')">注册</span>
            </div>
            
            <!-- 登录表单 -->
            <div id="loginForm">
                <h2 class="text-center mb-4">用户登录</h2>
                <div class="mb-4">
                    <label>手机号</label>
                    <input type="tel" id="loginPhone" class="input" placeholder="请输入11位手机号">
                </div>
                <div class="mb-4">
                    <label>密码</label>
                    <input type="password" id="loginPwd" class="input" placeholder="请输入密码（≥8位）">
                </div>
                <button class="btn" style="width: 100%;" onclick="loginUser()">登录</button>
                <p class="small-text mt-4 text-center">管理员手机号：18597123311，密码：Hm123321</p>
            </div>
            
            <!-- 注册表单 -->
            <div id="registerForm" class="hidden">
                <h2 class="text-center mb-4">用户注册</h2>
                <div class="mb-4">
                    <label>手机号</label>
                    <input type="tel" id="regPhone" class="input" placeholder="请输入11位手机号">
                </div>
                <div class="mb-4">
                    <label>用户名</label>
                    <input type="text" id="regName" class="input" placeholder="请输入用户名（1-20字）">
                </div>
                <div class="mb-4">
                    <label>密码</label>
                    <input type="password" id="regPwd" class="input" placeholder="请输入密码（≥8位）">
                </div>
                <div class="mb-4">
                    <label>确认密码</label>
                    <input type="password" id="regConfirmPwd" class="input" placeholder="请再次输入密码">
                </div>
                <button class="btn" style="width: 100%;" onclick="registerUser()">注册</button>
            </div>
            
            <div id="authMessage" class="mt-4 text-center"></div>
        </div>

        <!-- 主应用区域（登录后显示） -->
        <div id="appSection" class="card hidden">
            <h2 class="text-center mb-4">三江源生态数据平台</h2>
            <div class="flex mb-4">
                <div style="flex: 1;">
                    <h3>欢迎 <span id="userNameDisplay"></span></h3>
                </div>
                <div>
                    <button class="btn" onclick="logout()">退出</button>
                </div>
            </div>
            
            <!-- 数据展示 -->
            <div id="dataDisplay">
                <h3 class="mb-4">生态监测数据</h3>
                <div id="ecologicalDataList"></div>
                
                <h3 class="mt-4 mb-4">物种记录</h3>
                <div id="speciesDataList"></div>
            </div>
            
            <!-- 问答功能 -->
            <div class="mt-4">
                <h3 class="mb-4">智能问答</h3>
                <textarea id="questionInput" class="input" rows="3" placeholder="请输入您关于三江源生态的问题..."></textarea>
                <button class="btn mt-4" onclick="askQuestion()">提问</button>
                <div id="qaHistory" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== Supabase配置 ==========
        const SUPABASE_URL = 'https://pnakeholshmrtwctzqcb.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_tVf76wqdUIvhiNUymxKHEA_FAMmDvf3';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========== 全局变量 ==========
        let currentUser = null; // 当前登录用户
        
        // ========== 标签切换 ==========
        function switchTab(tab) {
            const loginTab = document.querySelector('.tab');
            const registerTab = document.querySelectorAll('.tab')[1];
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }
        
        // ========== 用户登录 ==========
        async function loginUser() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPwd').value.trim();
            const messageDiv = document.getElementById('authMessage');
            
            // 表单验证
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                messageDiv.innerHTML = '<p class="text-red">请输入有效的手机号</p>';
                return;
            }
            
            if (password.length < 8) {
                messageDiv.innerHTML = '<p class="text-red">密码不少于8位</p>';
                return;
            }
            
            try {
                console.log('开始登录:', phone);
                
                // 管理员登录检查
                if (phone === '18597123311' && password === 'Hm123321') {
                    currentUser = { phone, name: '管理员', is_admin: true, id: 'admin-001' };
                    showMainApp();
                    messageDiv.innerHTML = '<p class="text-green">管理员登录成功</p>';
                    return;
                }
                
                // 普通用户登录
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .eq('password_hash', password) // 注意：生产环境应使用加密密码
                    .single();
                
                if (error || !data) {
                    messageDiv.innerHTML = '<p class="text-red">手机号或密码错误</p>';
                    return;
                }
                
                currentUser = data;
                showMainApp();
                messageDiv.innerHTML = '<p class="text-green">登录成功！</p>';
                
            } catch (err) {
                console.error('登录异常:', err);
                messageDiv.innerHTML = `<p class="text-red">登录失败: ${err.message}</p>`;
            }
        }
        
        // ========== 用户注册 ==========
        async function registerUser() {
            const phone = document.getElementById('regPhone').value.trim();
            const name = document.getElementById('regName').value.trim();
            const password = document.getElementById('regPwd').value.trim();
            const confirmPassword = document.getElementById('regConfirmPwd').value.trim();
            const messageDiv = document.getElementById('authMessage');
            
            // 表单验证
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                messageDiv.innerHTML = '<p class="text-red">请输入有效的手机号</p>';
                return;
            }
            
            if (name.length < 1 || name.length > 20) {
                messageDiv.innerHTML = '<p class="text-red">用户名1-20位</p>';
                return;
            }
            
            if (password.length < 8) {
                messageDiv.innerHTML = '<p class="text-red">密码不少于8位</p>';
                return;
            }
            
            if (password !== confirmPassword) {
                messageDiv.innerHTML = '<p class="text-red">两次密码不一致</p>';
                return;
            }
            
            try {
                // 检查手机号是否已存在
                const { data: existing, error: checkError } = await supabase
                    .from('users')
                    .select('phone')
                    .eq('phone', phone)
                    .single();
                
                if (existing) {
                    messageDiv.innerHTML = '<p class="text-red">该手机号已注册</p>';
                    return;
                }
                
                // 创建用户（生产环境应加密密码）
                const { data, error } = await supabase
                    .from('users')
                    .insert({
                        phone: phone,
                        name: name,
                        password_hash: password, // ⚠️ 注意：生产环境应使用bcrypt等加密
                        is_admin: false,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) {
                    messageDiv.innerHTML = `<p class="text-red">注册失败: ${error.message}</p>`;
                    return;
                }
                
                messageDiv.innerHTML = '<p class="text-green">注册成功！请登录</p>';
                setTimeout(() => {
                    switchTab('login');
                    // 清空表单
                    document.getElementById('regPhone').value = '';
                    document.getElementById('regName').value = '';
                    document.getElementById('regPwd').value = '';
                    document.getElementById('regConfirmPwd').value = '';
                }, 1500);
                
            } catch (err) {
                messageDiv.innerHTML = `<p class="text-red">注册失败: ${err.message}</p>`;
            }
        }
        
        // ========== 显示主应用 ==========
        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            
            // 加载数据
            loadEcologicalData();
            loadSpeciesData();
        }
        
        // ========== 加载生态数据 ==========
        async function loadEcologicalData() {
            const dataList = document.getElementById('ecologicalDataList');
            
            try {
                const { data, error } = await supabase
                    .from('ecological_data')
                    .select('*')
                    .order('record_date', { ascending: false })
                    .limit(10);
                
                if (error) {
                    dataList.innerHTML = `<p class="text-red">加载失败: ${error.message}</p>`;
                    return;
                }
                
                dataList.innerHTML = data.map(item => `
                    <div class="card" style="margin:10px 0;">
                        <h4>${item.data_type}</h4>
                        <p><strong>位置:</strong> ${item.location}</p>
                        <p><strong>数值:</strong> ${item.value} ${item.unit}</p>
                        <p><strong>日期:</strong> ${item.record_date}</p>
                    </div>
                `).join('');
                
            } catch (err) {
                dataList.innerHTML = `<p class="text-red">加载异常: ${err.message}</p>`;
            }
        }
        
        // ========== 加载物种数据 ==========
        async function loadSpeciesData() {
            const dataList = document.getElementById('speciesDataList');
            
            try {
                const { data, error } = await supabase
                    .from('species_records')
                    .select('*')
                    .order('observation_date', { ascending: false })
                    .limit(10);
                
                if (error) {
                    dataList.innerHTML = `<p class="text-red">加载失败: ${error.message}</p>`;
                    return;
                }
                
                dataList.innerHTML = data.map(item => `
                    <div class="card" style="margin:10px 0;">
                        <h4>${item.species_name}</h4>
                        <p><strong>数量:</strong> ${item.count}</p>
                        <p><strong>位置:</strong> ${item.location}</p>
                        <p><strong>日期:</strong> ${item.observation_date}</p>
                    </div>
                `).join('');
                
            } catch (err) {
                dataList.innerHTML = `<p class="text-red">加载异常: ${err.message}</p>`;
            }
        }
        
        // ========== 智能问答 ==========
        async function askQuestion() {
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) {
                alert('请输入问题');
                return;
            }
            
            // 模拟回答（后续可接入AI API）
            const answer = getMockAnswer(question);
            
            // 显示问答记录
            const qaHistory = document.getElementById('qaHistory');
            const qaItem = document.createElement('div');
            qaItem.className = 'card';
            qaItem.style.margin = '10px 0';
            qaItem.innerHTML = `
                <p><strong>问:</strong> ${question}</p>
                <p><strong>答:</strong> ${answer}</p>
            `;
            qaHistory.insertBefore(qaItem, qaHistory.firstChild);
            
            // 保存到数据库
            try {
                await supabase.from('qa_logs').insert({
                    user_id: currentUser.id,
                    question: question,
                    answer: answer,
                    created_at: new Date().toISOString()
                });
            } catch (err) {
                console.error('保存问答失败:', err);
            }
            
            input.value = '';
        }
        
        // ========== 模拟回答 ==========
        function getMockAnswer(question) {
            const q = question.toLowerCase();
            if (q.includes('珍稀物种')) return "三江源的珍稀物种包括雪豹、藏羚羊、野牦牛、黑颈鹤等国家一级保护动物16种。";
            if (q.includes('保护措施')) return "三江源保护措施包括生态修复、退牧还草、生态移民、社区共管等。";
            if (q.includes('中华水塔')) return "三江源被称为'中华水塔'，是长江、黄河、澜沧江的发源地。";
            return "三江源位于青海省南部，是长江、黄河、澜沧江的发源地，被称为'中华水塔'。";
        }
        
        // ========== 退出登录 ==========
        function logout() {
            currentUser = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
            // 清空表单
            document.getElementById('loginPhone').value = '';
            document.getElementById('loginPwd').value = '';
            document.getElementById('authMessage').innerHTML = '';
        }
    </script>
</body>
</html>

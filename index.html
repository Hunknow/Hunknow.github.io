<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>三江源生态智能问答平台</title>
    
    <!-- CDN资源（无需本地文件） -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    
    <style type="text/tailwindcss">
        <!-- 原有的CSS样式保持不变 -->
        @layer utilities {
            .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
            .login-shadow { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
            <!-- ... 其他样式 ... -->
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0E7C7B',
                        secondary: '#41C9E2',
                        accent: '#A0D8B3',
                        dark: '#2C3E50',
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Microsoft YaHei', 'sans-serif'],
                    },
                    keyframes: {
                        fadeIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        },
                        shake: {
                            '0%,100%': { transform: 'translateX(0)' },
                            '20%,60%': { transform: 'translateX(-5px)' },
                            '40%,80%': { transform: 'translateX(5px)' }
                        }
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.3s ease-out',
                        'shake': 'shake 0.5s ease-in-out'
                    }
                }
            }
        }
        
        // ========== 常量定义 ==========
        const APP_CONFIG = {
            SUPABASE_URL: 'https://your-project-id.supabase.co',
            SUPABASE_ANON_KEY: 'your-anon-key',
            ADMIN_PHONE: '18597123311',
            ADMIN_PASSWORD: 'Hm123321',
            APP_NAME: '三江源生态智能问答平台'
        };
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-cyan-50 to-green-50 text-dark min-h-screen">
    <!-- 页面HTML结构（保持不变） -->
    
    <script>
        // ========== Supabase初始化 ==========
        const supabase = window.supabase.createClient(
            APP_CONFIG.SUPABASE_URL,
            APP_CONFIG.SUPABASE_ANON_KEY
        );
        
        // ========== API函数 ==========
        const API = {
            // 用户注册
            async registerUser(phone, name, password) {
                try {
                    console.log('开始用户注册:', { phone, name });
                    
                    // 检查手机号是否已存在
                    const { data: existingUser, error: checkError } = await supabase
                        .from('users')
                        .select('phone')
                        .eq('phone', phone)
                        .single();
                    
                    if (existingUser) {
                        return { success: false, error: '该手机号已注册' };
                    }
                    
                    // 创建用户记录
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .insert({
                            phone: phone,
                            name: name,
                            password_hash: password,
                            is_admin: false,
                            created_at: new Date().toISOString()
                        })
                        .select()
                        .single();
                    
                    if (userError) {
                        return { success: false, error: `注册失败: ${userError.message}` };
                    }
                    
                    return { success: true, data: userData };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // 用户登录
            async loginUser(phone, password) {
                try {
                    console.log('开始用户登录:', phone);
                    
                    // 查询用户
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('phone', phone)
                        .eq('password_hash', password)
                        .single();
                    
                    if (userError || !userData) {
                        return { success: false, error: '手机号或密码错误' };
                    }
                    
                    return { success: true, data: userData };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            // 其他API函数...
        };
        
        // ========== 主应用逻辑 ==========
        let currentUser = null;
        let currentSession = null;
        let isAdminMode = false;
        
        // 页面加载完成时初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成');
            
            // 初始显示登录页面
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            // 绑定事件
            bindEvents();
        });
        
        function bindEvents() {
            // 登录按钮
            document.getElementById('loginBtn')?.addEventListener('click', async function() {
                const phone = document.getElementById('loginPhone').value.trim();
                const password = document.getElementById('loginPwd').value.trim();
                
                // 表单验证
                if (!/^1[3-9]\d{9}$/.test(phone)) {
                    showToast('请输入有效的11位手机号', 'error');
                    return;
                }
                
                if (password.length < 8) {
                    showToast('密码不少于8位', 'error');
                    return;
                }
                
                // 管理员登录检查
                if (phone === APP_CONFIG.ADMIN_PHONE && password === APP_CONFIG.ADMIN_PASSWORD) {
                    isAdminMode = true;
                    currentUser = { phone, name: 'admin', is_admin: true };
                    showAdminPage();
                    showToast('管理员登录成功');
                    return;
                }
                
                // 普通用户登录
                const result = await API.loginUser(phone, password);
                
                if (result.success) {
                    currentUser = result.data;
                    isAdminMode = false;
                    showMainPage();
                    showToast('登录成功');
                    
                    // 开始会话
                    await startUserSession();
                    
                    // 加载用户数据
                    await loadUserData();
                } else {
                    showToast(result.error, 'error');
                }
            });
            
            // 注册按钮
            document.getElementById('regBtn')?.addEventListener('click', async function() {
                const phone = document.getElementById('regPhone').value.trim();
                const name = document.getElementById('regName').value.trim();
                const password = document.getElementById('regPwd').value.trim();
                const confirmPassword = document.getElementById('regConfirmPwd').value.trim();
                
                // 表单验证
                if (!/^1[3-9]\d{9}$/.test(phone)) {
                    showToast('请输入有效的11位手机号', 'error');
                    return;
                }
                
                if (name.length < 1 || name.length > 20) {
                    showToast('用户名1-20位', 'error');
                    return;
                }
                
                if (password.length < 8) {
                    showToast('密码不少于8位', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showToast('两次密码不一致', 'error');
                    return;
                }
                
                if (phone === APP_CONFIG.ADMIN_PHONE) {
                    showToast('该手机号为管理员专用，不可注册', 'error');
                    return;
                }
                
                const result = await API.registerUser(phone, name, password);
                
                if (result.success) {
                    showToast('注册成功！即将跳转登录');
                    setTimeout(() => {
                        switchTab('login');
                        // 清空注册表单
                        document.getElementById('regPhone').value = '';
                        document.getElementById('regName').value = '';
                        document.getElementById('regPwd').value = '';
                        document.getElementById('regConfirmPwd').value = '';
                    }, 1500);
                } else {
                    showToast(result.error, 'error');
                }
            });
            
            // 发送问题按钮
            document.getElementById('sendBtn')?.addEventListener('click', sendQuestion);
            
            // 退出按钮
            document.getElementById('logoutBtn')?.addEventListener('click', logout);
            
            // 管理员退出按钮
            document.getElementById('adminLogoutBtn')?.addEventListener('click', adminLogout);
        }
        
        // ========== 页面显示函数 ==========
        function showMainPage() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            if (currentUser && document.getElementById('userName')) {
                document.getElementById('userName').textContent = `欢迎，${currentUser.name}`;
            }
        }
        
        function showAdminPage() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            
            if (currentUser && document.getElementById('adminName')) {
                document.getElementById('adminName').textContent = `管理员：${currentUser.name}`;
            }
            
            // 加载管理员数据
            loadAdminData();
        }
        
        // ========== 其他功能函数 ==========
        async function startUserSession() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('user_sessions')
                    .insert({
                        user_id: currentUser.id,
                        login_time: new Date().toISOString(),
                        ip_address: await getClientIP(),
                        user_agent: navigator.userAgent
                    })
                    .select()
                    .single();
                
                if (!error) {
                    currentSession = data;
                }
            } catch (error) {
                console.error('开始会话失败:', error);
            }
        }
        
        async function loadUserData() {
            if (!currentUser) return;
            
            // 这里可以加载用户统计数据
            // 示例：获取用户问答记录
            try {
                const { data, error } = await supabase
                    .from('qa_records')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (!error && data) {
                    // 更新页面显示
                    updateQADisplay(data);
                }
            } catch (error) {
                console.error('加载用户数据失败:', error);
            }
        }
        
        async function loadAdminData() {
            // 加载管理员统计数据
            // 这里可以添加管理员数据加载逻辑
        }
        
        async function sendQuestion() {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            const questionInput = document.getElementById('questionInput');
            const question = questionInput?.value.trim() || '';
            
            if (!question || question.length > 100) {
                showToast('请输入1-100字的问题', 'error');
                return;
            }
            
            // 清空输入框
            if (questionInput) questionInput.value = '';
            
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            // 显示用户问题
            const userHtml = `<div class="qa-item-user"><div class="qa-content-user"><div class="text-sm text-gray-500">我 ${time}</div><div class="mt-1">${question}</div></div></div>`;
            document.getElementById('chatBox').insertAdjacentHTML('beforeend', userHtml);
            
            // 获取模拟回答
            const answer = getMockAnswer(question);
            
            // 显示回答
            const answerHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">智能助手 ${time}</div><div class="mt-1">${answer}</div><i class="fa fa-star collect-btn" onclick="toggleCollect('${question.replace(/'/g, "\\'")}', '${answer.replace(/'/g, "\\'")}')"></i></div></div>`;
            document.getElementById('chatBox').insertAdjacentHTML('beforeend', answerHtml);
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            
            // 保存问答记录
            try {
                await supabase
                    .from('qa_records')
                    .insert({
                        user_id: currentUser.id,
                        question: question,
                        answer: answer
                    });
            } catch (error) {
                console.error('保存问答记录失败:', error);
            }
        }
        
        function getMockAnswer(question) {
            // 简化的模拟回答
            const questionLower = question.toLowerCase();
            
            if (questionLower.includes('珍稀物种')) {
                return "三江源的珍稀物种包括雪豹、藏羚羊、野牦牛、黑颈鹤等国家一级保护动物16种。";
            } else if (questionLower.includes('保护措施')) {
                return "三江源保护措施包括生态修复、退牧还草、生态移民、社区共管等。";
            } else if (questionLower.includes('中华水塔')) {
                return "三江源被称为'中华水塔'，因为这里是长江、黄河、澜沧江三大江河的发源地。";
            } else {
                return "三江源位于青海省南部，是长江、黄河、澜沧江的发源地，被称为'中华水塔'。";
            }
        }
        
        async function logout() {
            if (currentUser && currentSession) {
                try {
                    await supabase
                        .from('user_sessions')
                        .update({ logout_time: new Date().toISOString() })
                        .eq('id', currentSession.id);
                } catch (error) {
                    console.error('结束会话失败:', error);
                }
            }
            
            currentUser = null;
            currentSession = null;
            isAdminMode = false;
            
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            showToast('已退出登录');
        }
        
        function adminLogout() {
            currentUser = null;
            currentSession = null;
            isAdminMode = false;
            
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            showToast('已退出管理员模式');
        }
        
        // ========== 工具函数 ==========
        function showToast(message, type = 'success') {
            // 原有的showToast函数实现
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.className = 'toast show';
            if (type === 'error') toast.classList.add('error');
            
            setTimeout(() => {
                toast.classList.remove('show', 'error');
            }, 2000);
        }
        
        function switchTab(tab) {
            // 原有的switchTab函数实现
            if (tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginTab').classList.add('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('registerTab').classList.remove('text-primary', 'border-b-2', 'border-primary');
            } else {
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerTab').classList.add('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('loginTab').classList.remove('text-primary', 'border-b-2', 'border-primary');
            }
        }
        
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || '未知';
            } catch (error) {
                return '未知';
            }
        }
        
        // ========== 全局函数供HTML调用 ==========
        window.fillQuestion = function(question) {
            const input = document.getElementById('questionInput');
            if (input) {
                input.value = question;
                input.focus();
            }
        };
        
        window.toggleCollect = async function(question, answer) {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            try {
                // 检查是否已收藏
                const { data: existing, error: checkError } = await supabase
                    .from('collections')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('question', question)
                    .single();
                
                if (existing) {
                    // 已收藏，删除
                    await supabase
                        .from('collections')
                        .delete()
                        .eq('id', existing.id);
                    showToast('取消收藏');
                } else {
                    // 未收藏，添加
                    await supabase
                        .from('collections')
                        .insert({
                            user_id: currentUser.id,
                            question: question,
                            answer: answer
                        });
                    showToast('收藏成功');
                }
            } catch (error) {
                console.error('收藏操作失败:', error);
            }
        };
    </script>
</body>
</html>
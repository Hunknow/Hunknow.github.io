<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”å¹³å°</title>
    
    <!-- åŸæœ‰CDNèµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

    <!-- Tailwindè‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
            .login-shadow { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
            .qa-item-user { @apply flex justify-start mb-4 animate-fadeIn; }
            .qa-content-user { @apply bg-gray-100 rounded-lg rounded-tl-none px-4 py-3 max-w-[80%] shadow-sm; }
            .qa-item-bot { @apply flex justify-end mb-4 animate-fadeIn; }
            .qa-content-bot { @apply bg-primary/10 rounded-lg rounded-tr-none px-4 py-3 max-w-[80%] shadow-sm border border-primary/20; }
            .loading-dot { @apply inline-block w-2 h-2 rounded-full bg-primary mx-0.5 animate-bounce; }
            .loading-dot:nth-child(2) { animation-delay: 0.2s; }
            .loading-dot:nth-child(3) { animation-delay: 0.4s; }
            .collect-btn { @apply text-gray-400 hover:text-yellow-500 transition-colors ml-2 cursor-pointer; }
            .collect-btn.active { @apply text-yellow-500; }
            .toast { @apply fixed bottom-6 left-1/2 -translate-x-1/2 bg-dark/80 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300 opacity-0 translate-y-4; }
            .toast.show { @apply opacity-100 translate-y-0; }
            .toast.error { @apply bg-red-500; }
            .admin-card { @apply bg-white rounded-xl shadow-lg p-6 mb-6; }
            .touchable { @apply min-h-[44px] flex items-center justify-center; }
        }
    </style>

    <script>
        // Tailwindé…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0E7C7B',
                        secondary: '#41C9E2',
                        accent: '#A0D8B3',
                        dark: '#2C3E50',
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Microsoft YaHei', 'sans-serif'],
                    },
                    keyframes: {
                        fadeIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        },
                        shake: {
                            '0%,100%': { transform: 'translateX(0)' },
                            '20%,60%': { transform: 'translateX(-5px)' },
                            '40%,80%': { transform: 'translateX(5px)' }
                        }
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.3s ease-out',
                        'shake': 'shake 0.5s ease-in-out'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-cyan-50 to-green-50 text-dark min-h-screen">
    <!-- ç™»å½•æ³¨å†Œå¼¹çª— -->
    <div id="authPage" class="fixed inset-0 bg-dark/70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md login-shadow overflow-hidden transform transition-all duration-300">
            <div class="flex border-b border-gray-200">
                <button id="loginTab" class="flex-1 py-3 font-medium text-primary border-b-2 border-primary text-center transition-all touchable">
                    <i class="fa fa-sign-in mr-1"></i>ç™»å½•
                </button>
                <button id="registerTab" class="flex-1 py-3 font-medium text-gray-500 hover:text-primary text-center transition-all touchable">
                    <i class="fa fa-user-plus mr-1"></i>æ³¨å†Œ
                </button>
            </div>
            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm" class="p-6">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">ç”¨æˆ·ç™»å½•</h3>
                <div class="space-y-4">
                    <div>
                        <label for="loginPhone" class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æœºå·</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-phone"></i>
                            </span>
                            <input type="tel" id="loginPhone" placeholder="11ä½æ‰‹æœºå·" maxlength="11"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div>
                        <label for="loginPwd" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="loginPwd" placeholder="è‡³å°‘8ä½å¯†ç " maxlength="20"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div id="loginError" class="hidden text-red-500 text-sm text-center mt-1 py-2 bg-red-50 rounded-lg">æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯</div>
                    <button id="loginBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-colors touchable">ç™»å½•</button>
                    
                    <!-- ç®¡ç†å‘˜ç™»å½•æç¤º -->
                    <div class="text-center text-xs text-gray-500 mt-4 pt-4 border-t border-gray-200">
                        <p>ç®¡ç†å‘˜è´¦å·ï¼š18597123311 / Hm123321</p>
                    </div>
                </div>
            </div>
            <!-- æ³¨å†Œè¡¨å• -->
            <div id="registerForm" class="p-6 hidden">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">ç”¨æˆ·æ³¨å†Œ</h3>
                <div class="space-y-4">
                    <div>
                        <label for="regPhone" class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æœºå·</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-phone"></i>
                            </span>
                            <input type="tel" id="regPhone" placeholder="11ä½æ‰‹æœºå·" maxlength="11"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div>
                        <label for="regName" class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-user"></i>
                            </span>
                            <input type="text" id="regName" placeholder="1-20ä½ç”¨æˆ·å" maxlength="20"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div>
                        <label for="regPwd" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="regPwd" placeholder="è‡³å°‘8ä½å¯†ç " maxlength="20"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div>
                        <label for="regConfirmPwd" class="block text-sm font-medium text-gray-700 mb-1">ç¡®è®¤å¯†ç </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="regConfirmPwd" placeholder="å†æ¬¡è¾“å…¥å¯†ç " maxlength="20"
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>
                    </div>
                    <div id="regSuccess" class="hidden text-green-500 text-sm text-center mt-1 py-2 bg-green-50 rounded-lg">æ³¨å†ŒæˆåŠŸï¼å³å°†è·³è½¬ç™»å½•</div>
                    <button id="regBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-colors touchable">æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™®é€šç”¨æˆ·ä¸»é¡µé¢ -->
    <div id="mainPage" class="hidden min-h-screen">
        <!-- é¡¶éƒ¨æ¨ªå¹… -->
        <header class="relative h-[40vh] min-h-[300px] bg-center bg-cover" style="background-image: url('https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80&sat=-30');">
            <div class="absolute inset-0 bg-gradient-to-t from-dark/70 to-dark/30 flex flex-col items-center justify-center text-white w-full">
                <h1 class="text-[clamp(1.8rem,4vw,3.5rem)] font-bold text-center text-shadow">ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”</h1>
                <p class="text-[clamp(1rem,2vw,1.5rem)] mt-3 text-center text-shadow">æ¢ç´¢ä¸­åæ°´å¡” Â· å®ˆæŠ¤é«˜åŸç”Ÿæ€</p>
                <div class="mt-4 text-white/80">
                    <i class="fa fa-mountain text-2xl"></i>
                    <i class="fa fa-water text-2xl mx-4"></i>
                    <i class="fa fa-leaf text-2xl"></i>
                </div>
            </div>
        </header>
        
        <!-- ç”¨æˆ·å¯¼èˆª -->
        <nav class="sticky top-0 bg-primary/90 backdrop-blur-sm text-white z-40 shadow-md">
            <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
                <div class="flex space-x-4 mb-2 md:mb-0">
                    <a href="#knowledge" class="hover:text-accent transition-colors font-medium">ç”Ÿæ€çŸ¥è¯†</a>
                    <a href="#qa" class="hover:text-accent transition-colors font-medium">æ™ºèƒ½é—®ç­”</a>
                    <a href="#collection" class="hover:text-accent transition-colors font-medium">æˆ‘çš„æ”¶è—</a>
                    <a href="#data" class="hover:text-accent transition-colors font-medium">ç”Ÿæ€æ•°æ®</a>
                </div>
                <div class="flex items-center gap-3">
                    <span id="userName" class="font-medium">æ¬¢è¿ä½ ï¼</span>
                    <button onclick="logout()" class="hover:text-accent transition-colors touchable">
                        <i class="fa fa-sign-out"></i> é€€å‡º
                    </button>
                </div>
            </div>
        </nav>

        <!-- ç”Ÿæ€çŸ¥è¯†åŒº -->
        <section id="knowledge" class="py-10 bg-white/90 backdrop-blur-sm">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">ä¸‰æ±Ÿæºå›½å®¶å…¬å›­æ ¸å¿ƒç”Ÿæ€æ•°æ®</h2>
                
                <div class="grid md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                    <!-- åŸºç¡€æ¦‚å†µ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-map-marker mr-2"></i>åœ°ç†æ¦‚å†µ
                        </h3>
                        <ul class="space-y-2 text-sm">
                            <li>ğŸ“ <strong>åœ°ç†ä½ç½®</strong>ï¼šé’æµ·çœå—éƒ¨ï¼Œé’è—é«˜åŸè…¹åœ°</li>
                            <li>ğŸ—ºï¸ <strong>æ¶µç›–èŒƒå›´</strong>ï¼šç‰æ ‘ã€æœæ´›ã€é»„å—ã€æµ·å—4å·åŠæ ¼å°”æœ¨å¸‚å”å¤æ‹‰å±±é•‡</li>
                            <li>ğŸ”ï¸ <strong>æµ·æ‹”èŒƒå›´</strong>ï¼š3335-6564ç±³ï¼ˆå¹³å‡4500ç±³ä»¥ä¸Šï¼‰</li>
                            <li>ğŸ’§ <strong>æ°´ç³»æ„æˆ</strong>ï¼šé•¿æ±Ÿæºã€é»„æ²³æºã€æ¾œæ²§æ±Ÿæº3å¤§å›­åŒº</li>
                            <li>ğŸŒ¿ <strong>æ€»é¢ç§¯</strong>ï¼š36.3ä¸‡å¹³æ–¹å…¬é‡Œï¼ˆä¿æŠ¤åŒºï¼‰<br>12.31ä¸‡å¹³æ–¹å…¬é‡Œï¼ˆå›½å®¶å…¬å›­ï¼‰</li>
                        </ul>
                    </div>
                    
                    <!-- ç”Ÿç‰©å¤šæ ·æ€§ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-paw mr-2"></i>ç”Ÿç‰©å¤šæ ·æ€§
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div><strong>ç‰©ç§æ€»æ•°</strong>ï¼šç»´ç®¡æ¤ç‰©2,238ç§ â€¢ è„Šæ¤åŠ¨ç‰©370ç§</div>
                            <div><strong>çç¨€æ¿’å±ç‰©ç§</strong>ï¼š
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>â€¢ å›½å®¶ä¸€çº§ä¿æŠ¤åŠ¨ç‰©ï¼š16ç§ï¼ˆé›ªè±¹ã€è—ç¾šç¾Šã€é‡ç‰¦ç‰›ç­‰ï¼‰</li>
                                    <li>â€¢ å›½å®¶äºŒçº§ä¿æŠ¤åŠ¨ç‰©ï¼š53ç§ï¼ˆè—åŸç¾šã€å²©ç¾Šã€è—ç‹ç­‰ï¼‰</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”Ÿæ€ä»·å€¼ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-chart-line mr-2"></i>ç”Ÿæ€æœåŠ¡ä»·å€¼
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div>ğŸ’§ <strong>æ°´æºæ¶µå…»</strong>ï¼šå¹´å‡å¾„æµé‡600äº¿ç«‹æ–¹ç±³</div>
                            <div>ğŸŒŠ <strong>æ°´é‡è´¡çŒ®</strong>ï¼šé•¿æ±Ÿ25% â€¢ é»„æ²³49% â€¢ æ¾œæ²§æ±Ÿ15%</div>
                            <div>ğŸŒ³ <strong>ç¢³æ±‡åŠŸèƒ½</strong>ï¼šå¹´å›ºç¢³1200ä¸‡å¨</div>
                            <div>ğŸ›¡ï¸ <strong>æ°´åœŸä¿æŒ</strong>ï¼šå‡å°‘ä¾µèš€3.8äº¿å¨/å¹´</div>
                        </div>
                    </div>
                    
                    <!-- ä¿æŠ¤æªæ–½ -->
                    <div class="bg-white/80 rounded-lg p-5 shadow-sm border-l-4 border-primary backdrop-blur-sm">
                        <h3 class="font-semibold text-lg mb-3 text-secondary">
                            <i class="fa fa-shield mr-2"></i>ä¿æŠ¤æªæ–½ä¸æˆæ•ˆ
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div>âœ… <strong>ç”Ÿæ€ä¿®å¤</strong>ï¼šæ²»ç†é»‘åœŸæ»©2.5ä¸‡kmÂ² â€¢ æ¢å¤æ¹¿åœ°1.6ä¸‡kmÂ²</div>
                            <div>âœ… <strong>é€€ç‰§è¿˜è‰</strong>ï¼šç¦ç‰§0.93äº¿äº© â€¢ ä¼‘ç‰§1.58äº¿äº©</div>
                            <div>âœ… <strong>ç¤¾åŒºå…±ç®¡</strong>ï¼šè®¾ç«‹ç”Ÿæ€ç®¡æŠ¤å‘˜17,211ä¸ª</div>
                            <div>ğŸ“ˆ <strong>ä¿æŠ¤æˆæ•ˆ</strong>ï¼šè‰åœ°ç›–åº¦æé«˜11% â€¢ æ°´æºæ¶µå…»é‡å¢6%/å¹´</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- æ™ºèƒ½é—®ç­”åŒº -->
        <section id="qa" class="py-10 bg-gradient-to-b from-blue-50/50 to-transparent">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">æ™ºèƒ½é—®ç­”</h2>
                <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden backdrop-blur-sm">
                    <div class="bg-primary text-white p-3 flex justify-between items-center">
                        <div class="flex items-center">
                            <span>å…³äºä¸‰æ±Ÿæºï¼Œéšæ—¶æé—®</span>
                        </div>
                    </div>
                    
                    <div id="chatBox" class="p-4 h-[50vh] overflow-y-auto space-y-4">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fa fa-comment-o text-3xl mb-2"></i>
                            <p>è¾“å…¥é—®é¢˜ï¼Œè·å–ä¸“ä¸šå›ç­”</p>
                            <p class="text-xs mt-2">ä¸“æ³¨äºä¸‰æ±Ÿæºç”Ÿæ€ä¿æŠ¤ç›¸å…³é—®é¢˜</p>
                        </div>
                    </div>
                    <div class="p-3 border-t flex">
                        <input type="text" id="questionInput" placeholder="è¾“å…¥å…³äºä¸‰æ±Ÿæºç”Ÿæ€ä¿æŠ¤çš„é—®é¢˜ï¼ˆæœ€å¤š100å­—ï¼‰" maxlength="100"
                               class="flex-1 px-3 py-2 rounded-l-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        <button onclick="askQuestion()" class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary/90 transition-colors touchable">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- é—®é¢˜å»ºè®® -->
                <div class="mt-6 max-w-2xl mx-auto">
                    <h3 class="text-sm font-medium text-gray-600 mb-2">æ‚¨å¯ä»¥æé—®ï¼š</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºæœ‰å“ªäº›çç¨€ç‰©ç§ï¼Ÿ')">çç¨€ç‰©ç§</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('å¦‚ä½•ä¿æŠ¤ä¸‰æ±Ÿæºç”Ÿæ€ç¯å¢ƒï¼Ÿ')">ä¿æŠ¤æªæ–½</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºä¸ºä»€ä¹ˆå«ä¸­åæ°´å¡”ï¼Ÿ')">ä¸­åæ°´å¡”</button>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 transition-colors" onclick="fillQuestion('ä¸‰æ±Ÿæºçš„æ°”å€™ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ')">æ°”å€™ç‰¹ç‚¹</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- æˆ‘çš„æ”¶è— -->
        <section id="collection" class="py-10 bg-gradient-to-b from-green-50/50 to-transparent">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">æˆ‘çš„æ”¶è—</h2>
                <div id="collectionBox" class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-5 min-h-[200px] backdrop-blur-sm">
                    <div class="text-center text-gray-400 py-8" id="emptyCollection">
                        <i class="fa fa-star-o text-3xl mb-2"></i>
                        <p>æš‚æ— æ”¶è—ï¼Œç‚¹å‡»å›ç­”æ—â­æ”¶è—</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç”Ÿæ€æ•°æ®åŒº -->
        <section id="data" class="py-10 bg-white/90 backdrop-blur-sm">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl font-bold text-center mb-8 text-primary">ç”Ÿæ€ç›‘æµ‹æ•°æ®</h2>
                
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 max-w-4xl mx-auto">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-tree text-blue-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">ç”Ÿæ€ç›‘æµ‹ç‚¹</p>
                                <p id="statsEcological" class="text-2xl font-bold text-blue-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">å®æ—¶ç›‘æµ‹ç‚¹ä½</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-green-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-paw text-green-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">ç‰©ç§è®°å½•</p>
                                <p id="statsSpecies" class="text-2xl font-bold text-green-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">å·²è®°å½•ç‰©ç§æ•°é‡</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="bg-purple-500/20 p-3 rounded-lg mr-4">
                                <i class="fa fa-comments text-purple-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">ç”¨æˆ·é—®ç­”</p>
                                <p id="statsQA" class="text-2xl font-bold text-purple-600">0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">å†å²é—®ç­”æ€»æ•°</p>
                    </div>
                </div>

                <!-- æ•°æ®å¯è§†åŒ– -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6 max-w-4xl mx-auto">
                    <h3 class="text-lg font-medium mb-4 text-primary flex items-center">
                        <i class="fa fa-chart-line mr-2"></i>ç”Ÿæ€æ•°æ®è¶‹åŠ¿
                    </h3>
                    <canvas id="ecologicalChart" width="400" height="200"></canvas>
                </div>

                <!-- æ•°æ®é¢æ¿ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-4xl mx-auto">
                    <!-- ç”Ÿæ€æ•°æ® -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-medium mb-4 text-primary flex items-center">
                            <i class="fa fa-tree mr-2"></i>ç”Ÿæ€ç›‘æµ‹æ•°æ®
                        </h3>
                        <div id="ecologicalDataList" class="space-y-4"></div>
                    </div>

                    <!-- ç‰©ç§è®°å½• -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-medium mb-4 text-primary flex items-center">
                            <i class="fa fa-paw mr-2"></i>ç‰©ç§è®°å½•
                        </h3>
                        <div id="speciesDataList" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- åº•éƒ¨ -->
        <footer class="bg-dark text-white py-6 mt-auto">
            <div class="container mx-auto px-4 text-center text-sm">
                <p>ä¸‰æ±Ÿæºç”Ÿæ€æ™ºèƒ½é—®ç­”å¹³å° | ä»…ä¾›å­¦ä¹ æ¼”ç¤º</p>
                <p class="text-gray-400 mt-1">ä¿æŠ¤ä¸­åæ°´å¡”ï¼Œäººäººæœ‰è´£</p>
            </div>
        </footer>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast" class="toast"></div>

    <script>
        // ========== Supabaseé…ç½® ==========
        const SUPABASE_URL = 'https://pnakeholshmrtwctzqcb.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_tVf76wqdUIvhiNUymxKHEA_FAMmDvf3';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========== ç®¡ç†å‘˜é…ç½® ==========
        const ADMIN_PHONE = '18597123311';
        const ADMIN_PASSWORD = 'Hm123321';
        
        // ========== å…¨å±€å˜é‡ ==========
        let currentUser = null;
        let ecologicalChart = null;
        let dataCache = { ecological: null, species: null, collections: null };
        
        // ========== DOMç¼“å­˜ ==========
        const DOM = {
            authPage: document.getElementById('authPage'),
            mainPage: document.getElementById('mainPage'),
            loginTab: document.getElementById('loginTab'),
            registerTab: document.getElementById('registerTab'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            loginBtn: document.getElementById('loginBtn'),
            regBtn: document.getElementById('regBtn'),
            userName: document.getElementById('userName'),
            chatBox: document.getElementById('chatBox'),
            questionInput: document.getElementById('questionInput'),
            collectionBox: document.getElementById('collectionBox'),
            toast: document.getElementById('toast')
        };

        // ========== å·¥å…·å‡½æ•° ==========
        function showToast(txt, type = 'success') {
            if (!DOM.toast) return;
            
            DOM.toast.textContent = txt;
            DOM.toast.className = 'toast show';
            if (type === 'error') DOM.toast.classList.add('error');
            setTimeout(() => {
                DOM.toast.classList.remove('show');
                DOM.toast.classList.remove('error');
            }, 2000);
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ========== ç™»å½•æ³¨å†Œç›¸å…³ ==========
        function switchTab(tab) {
            if (tab === 'login') {
                DOM.loginForm.classList.remove('hidden');
                DOM.registerForm.classList.add('hidden');
                DOM.loginTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                DOM.loginTab.classList.remove('text-gray-500');
                DOM.registerTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                DOM.registerTab.classList.add('text-gray-500');
            } else {
                DOM.registerForm.classList.remove('hidden');
                DOM.loginForm.classList.add('hidden');
                DOM.registerTab.classList.add('text-primary', 'border-b-2', 'border-primary');
                DOM.registerTab.classList.remove('text-gray-500');
                DOM.loginTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
                DOM.loginTab.classList.add('text-gray-500');
            }
        }

        async function login() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPwd').value.trim();
            
            if (!phone || !password) {
                showToast('è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ', 'error');
                return;
            }
            
            // ç®¡ç†å‘˜ç™»å½•
            if (phone === ADMIN_PHONE && password === ADMIN_PASSWORD) {
                currentUser = { id: 'admin', phone: ADMIN_PHONE, name: 'ç®¡ç†å‘˜', is_admin: true };
                showMainApp();
                showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                return;
            }
            
            // æ™®é€šç”¨æˆ·ç™»å½•
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .eq('password_hash', password)
                    .single();
                
                if (error || !data) {
                    document.getElementById('loginError').classList.remove('hidden');
                    showToast('æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯', 'error');
                    return;
                }
                
                currentUser = data;
                showMainApp();
                showToast('ç™»å½•æˆåŠŸ');
                
            } catch (err) {
                showToast(`ç™»å½•å¤±è´¥: ${err.message}`, 'error');
            }
        }

        async function register() {
            const phone = document.getElementById('regPhone').value.trim();
            const name = document.getElementById('regName').value.trim();
            const password = document.getElementById('regPwd').value.trim();
            const confirm = document.getElementById('regConfirmPwd').value.trim();
            
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·', 'error');
                return;
            }
            
            if (password !== confirm) {
                showToast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            try {
                const { data: existing } = await supabase
                    .from('users')
                    .select('phone')
                    .eq('phone', phone);
                
                if (existing && existing.length > 0) {
                    showToast('è¯¥æ‰‹æœºå·å·²æ³¨å†Œ', 'error');
                    return;
                }
                
                const { data } = await supabase
                    .from('users')
                    .insert({
                        phone: phone,
                        name: name,
                        password_hash: password,
                        is_admin: false,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                document.getElementById('regSuccess').classList.remove('hidden');
                showToast('æ³¨å†ŒæˆåŠŸï¼');
                
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('regPhone').value = '';
                    document.getElementById('regName').value = '';
                    document.getElementById('regPwd').value = '';
                    document.getElementById('regConfirmPwd').value = '';
                    document.getElementById('regSuccess').classList.add('hidden');
                }, 1500);
                
            } catch (err) {
                showToast(`æ³¨å†Œå¤±è´¥: ${err.message}`, 'error');
            }
        }

        function logout() {
            currentUser = null;
            dataCache = { ecological: null, species: null, collections: null };
            DOM.authPage.classList.remove('hidden');
            DOM.mainPage.classList.add('hidden');
            showToast('å·²é€€å‡ºç™»å½•');
        }

        // ========== ä¸»åº”ç”¨æ˜¾ç¤º ==========
        async function showMainApp() {
            DOM.authPage.classList.add('hidden');
            DOM.mainPage.classList.remove('hidden');
            DOM.userName.textContent = `æ¬¢è¿ï¼Œ${currentUser.name}`;
            
            // ç®¡ç†å‘˜ä¸æ˜¾ç¤ºæ”¶è—åŠŸèƒ½
            if (currentUser.is_admin) {
                document.getElementById('collection').classList.add('hidden');
            } else {
                document.getElementById('collection').classList.remove('hidden');
            }
            
            // åŠ è½½æ‰€æœ‰æ•°æ®
            await Promise.all([
                loadStats(),
                loadEcologicalData(),
                loadSpeciesData(),
                currentUser.is_admin ? Promise.resolve() : loadCollections(),
                loadChartData(),
                loadQAHistory()
            ]);
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
        }

        // ========== åŠ è½½ç»Ÿè®¡æ•°æ® ==========
        async function loadStats() {
            try {
                const { count: ecoCount } = await supabase.from('ecological_data').select('*', { count: 'exact', head: true });
                const { count: speciesCount } = await supabase.from('species_records').select('*', { count: 'exact', head: true });
                const { count: qaCount } = await supabase.from('qa_logs').select('*', { count: 'exact', head: true });
                
                document.getElementById('statsEcological').textContent = ecoCount;
                document.getElementById('statsSpecies').textContent = speciesCount;
                document.getElementById('statsQA').textContent = qaCount;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // ========== å›¾è¡¨ç›¸å…³ ==========
        function initChart() {
            const ctx = document.getElementById('ecologicalChart').getContext('2d');
            ecologicalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ¤è¢«è¦†ç›–åº¦ (%)',
                        data: [],
                        borderColor: '#0E7C7B',
                        backgroundColor: 'rgba(14, 124, 123, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'æ°´è´¨PHå€¼',
                        data: [],
                        borderColor: '#41C9E2',
                        backgroundColor: 'rgba(65, 201, 226, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function loadChartData() {
            try {
                const { data, error } = await supabase
                    .from('ecological_data')
                    .select('record_date, data_type, value')
                    .order('record_date', { ascending: true })
                    .limit(30);
                
                if (error) throw error;
                
                const dates = [...new Set(data.map(item => item.record_date))];
                const vegetationData = data.filter(item => item.data_type === 'æ¤è¢«è¦†ç›–åº¦').map(item => item.value);
                const phData = data.filter(item => item.data_type === 'æ°´è´¨PHå€¼').map(item => item.value);
                
                if (ecologicalChart) {
                    ecologicalChart.data.labels = dates;
                    ecologicalChart.data.datasets[0].data = vegetationData;
                    ecologicalChart.data.datasets[1].data = phData;
                    ecologicalChart.update();
                }
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // ========== åŠ è½½ç”Ÿæ€æ•°æ® ==========
        async function loadEcologicalData() {
            if (dataCache.ecological) {
                renderEcologicalData(dataCache.ecological);
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('ecological_data')
                    .select('*')
                    .order('record_date', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                dataCache.ecological = data;
                renderEcologicalData(data);
            } catch (error) {
                console.error('åŠ è½½ç”Ÿæ€æ•°æ®å¤±è´¥:', error);
                document.getElementById('ecologicalDataList').innerHTML = `<p class="text-red-500 text-center">åŠ è½½å¤±è´¥</p>`;
            }
        }
        
        function renderEcologicalData(data) {
            const div = document.getElementById('ecologicalDataList');
            if (!div) return;
            
            if (!data || data.length === 0) {
                div.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— æ•°æ®</p>';
                return;
            }
            
            div.innerHTML = data.map(item => `
                <div class="data-item border-b pb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-primary">${item.data_type}</h4>
                            <p class="text-sm text-gray-600">ä½ç½®: ${item.location}</p>
                            <p class="text-sm text-gray-600">æ•°å€¼: ${item.value} ${item.unit}</p>
                            <p class="text-xs text-gray-400">æ—¥æœŸ: ${item.record_date}</p>
                        </div>
                        ${currentUser && !currentUser.is_admin ? 
                            `<button onclick="collectItem('ç”Ÿæ€æ•°æ®', '${item.data_type}', '${item.location}')" 
                                class="text-yellow-500 hover:text-yellow-600">
                                <i class="fa fa-star"></i>
                            </button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ========== åŠ è½½ç‰©ç§æ•°æ® ==========
        async function loadSpeciesData() {
            if (dataCache.species) {
                renderSpeciesData(dataCache.species);
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('species_records')
                    .select('*')
                    .order('observation_date', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                dataCache.species = data;
                renderSpeciesData(data);
            } catch (error) {
                console.error('åŠ è½½ç‰©ç§æ•°æ®å¤±è´¥:', error);
                document.getElementById('speciesDataList').innerHTML = `<p class="text-red-500 text-center">åŠ è½½å¤±è´¥</p>`;
            }
        }
        
        function renderSpeciesData(data) {
            const div = document.getElementById('speciesDataList');
            if (!div) return;
            
            if (!data || data.length === 0) {
                div.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— æ•°æ®</p>';
                return;
            }
            
            div.innerHTML = data.map(item => `
                <div class="data-item border-b pb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-primary">${item.species_name}</h4>
                            <p class="text-sm text-gray-600">æ•°é‡: ${item.count}</p>
                            <p class="text-sm text-gray-600">ä½ç½®: ${item.location}</p>
                            <p class="text-xs text-gray-400">æ—¥æœŸ: ${item.observation_date}</p>
                        </div>
                        ${currentUser && !currentUser.is_admin ? 
                            `<button onclick="collectItem('ç‰©ç§', '${item.species_name}', 'æ•°é‡: ${item.count}')" 
                                class="text-yellow-500 hover:text-yellow-600">
                                <i class="fa fa-star"></i>
                            </button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ========== æ™ºèƒ½é—®ç­” ==========
        function fillQuestion(question) {
            if (DOM.questionInput) {
                DOM.questionInput.value = question;
                DOM.questionInput.focus();
            }
        }

        // æ¨¡æ‹ŸAIå›ç­”
        async function getAIAnswer(question) {
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const knowledgeBase = {
                'çç¨€ç‰©ç§': 'ä¸‰æ±Ÿæºå›½å®¶å…¬å›­å†…åˆ†å¸ƒæœ‰é›ªè±¹ã€è—ç¾šç¾Šã€é‡ç‰¦ç‰›ã€é»‘é¢ˆé¹¤ç­‰å›½å®¶ä¸€çº§ä¿æŠ¤åŠ¨ç‰©16ç§ï¼Œå›½å®¶äºŒçº§ä¿æŠ¤åŠ¨ç‰©41ç§ã€‚',
                'ä¿æŠ¤æªæ–½': 'ä¸‰æ±Ÿæºå®æ–½ç”Ÿæ€ä¿®å¤ã€é€€ç‰§è¿˜è‰ã€ç”Ÿæ€ç§»æ°‘ã€ç¤¾åŒºå…±ç®¡ã€è‡ªç„¶æ•™è‚²ç­‰ä¿æŠ¤æªæ–½ï¼Œç´¯è®¡æŠ•å…¥è¶…è¿‡200äº¿å…ƒã€‚',
                'ä¸­åæ°´å¡”': 'ä¸‰æ±Ÿæºæ˜¯é•¿æ±Ÿã€é»„æ²³ã€æ¾œæ²§æ±Ÿçš„å‘æºåœ°ï¼Œå¹´å‡å‘ä¸‹æ¸¸ä¾›æ°´600äº¿ç«‹æ–¹ç±³ï¼Œè¢«èª‰ä¸º"ä¸­åæ°´å¡”"ã€‚',
                'æ¤è¢«è¦†ç›–': 'ä¸‰æ±Ÿæºæ¤è¢«è¦†ç›–ç‡è¾¾68.5%ï¼Œå…¶ä¸­é«˜è¦†ç›–åº¦è‰åœ°å 42.3%ï¼Œæ˜¯äºšæ´²æœ€é‡è¦çš„æ°´æºæ¶µå…»åŒºã€‚',
                'æ°”å€™å˜åŒ–': 'è¿‘20å¹´ä¸‰æ±Ÿæºæ°”æ¸©ä¸Šå‡1.2â„ƒï¼Œå¹´é™æ°´å¢åŠ 50mmï¼Œéœ€åŠ å¼ºæ°”å€™é€‚åº”æ€§ç®¡ç†ã€‚',
                'åœ°ç†ä½ç½®': 'ä¸‰æ±Ÿæºä½äºé’æµ·çœå—éƒ¨ï¼Œé’è—é«˜åŸè…¹åœ°ï¼Œåœ°ç†åæ ‡ä¸ºä¸œç»89Â°45â€²â€”102Â°23â€²ï¼ŒåŒ—çº¬31Â°39â€²â€”36Â°12â€²ã€‚',
                'ç”Ÿæ€ä»·å€¼': 'ä¸‰æ±Ÿæºçš„ç”Ÿæ€ä»·å€¼åŒ…æ‹¬æ°´æºæ¶µå…»ã€ç”Ÿç‰©å¤šæ ·æ€§ä¿æŠ¤ã€ç¢³æ±‡åŠŸèƒ½ã€æ°”å€™è°ƒèŠ‚å’Œç”Ÿæ€å®‰å…¨å±éšœä½œç”¨ã€‚'
            };
            
            const questionLower = question.toLowerCase();
            
            // å…³é”®è¯åŒ¹é…
            for (const [key, answer] of Object.entries(knowledgeBase)) {
                if (questionLower.includes(key.toLowerCase())) {
                    return answer;
                }
            }
            
            // é»˜è®¤å›ç­”
            return 'ä¸‰æ±Ÿæºä½äºé’æµ·çœå—éƒ¨ï¼Œæ˜¯é•¿æ±Ÿã€é»„æ²³ã€æ¾œæ²§æ±Ÿçš„å‘æºåœ°ï¼Œè¢«ç§°ä¸º"ä¸­åæ°´å¡”"ï¼Œæ˜¯ä¸­å›½é‡è¦çš„ç”Ÿæ€å®‰å…¨å±éšœã€‚';
        }

        async function askQuestion() {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const question = DOM.questionInput.value.trim();
            if (!question || question.length > 100) {
                showToast('è¯·è¾“å…¥1-100å­—çš„é—®é¢˜', 'error');
                return;
            }
            
            DOM.questionInput.value = '';
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            // æ·»åŠ ç”¨æˆ·é—®é¢˜
            const userHtml = `<div class="qa-item-user"><div class="qa-content-user"><div class="text-sm text-gray-500">æˆ‘ ${time}</div><div class="mt-1">${question}</div></div></div>`;
            DOM.chatBox.insertAdjacentHTML('beforeend', userHtml);
            
            // æ·»åŠ åŠ è½½åŠ¨ç”»
            const loadingHtml = `<div class="qa-item-bot" id="loading"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1 flex items-center"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span><span class="ml-2">æ€è€ƒä¸­...</span></div></div></div>`;
            DOM.chatBox.insertAdjacentHTML('beforeend', loadingHtml);
            DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
            
            try {
                const answer = await getAIAnswer(question);
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.remove();
                
                // æ·»åŠ AIå›ç­”
                const safeQuestion = question.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeAnswer = answer.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                const answerHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1">${answer}</div><i class="fa fa-star collect-btn" onclick="toggleCollect(this,'${safeQuestion}','${safeAnswer}')"></i></div></div>`;
                DOM.chatBox.insertAdjacentHTML('beforeend', answerHtml);
                DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
                
                // ä¿å­˜é—®ç­”è®°å½•
                if (!currentUser.is_admin) {
                    await supabase.from('qa_logs').insert({
                        user_id: currentUser.id,
                        question: question,
                        answer: answer,
                        created_at: new Date().toISOString()
                    });
                }
                
                // æ›´æ–°ç»Ÿè®¡
                loadStats();
                
            } catch (error) {
                console.error('è·å–ç­”æ¡ˆå¤±è´¥:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.remove();
                
                const errorHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1 text-red-500">æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚</div></div></div>`;
                DOM.chatBox.insertAdjacentHTML('beforeend', errorHtml);
                DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
            }
        }

        // ========== æ”¶è—åŠŸèƒ½ ==========
        async function collectItem(type, title, content) {
            if (!currentUser || currentUser.is_admin) {
                showToast('ç®¡ç†å‘˜æ— æ”¶è—åŠŸèƒ½', 'error');
                return;
            }
            
            try {
                await supabase.from('collections').insert({
                    user_id: currentUser.id,
                    type: type,
                    title: title,
                    content: content,
                    created_at: new Date().toISOString()
                });
                
                showToast('æ”¶è—æˆåŠŸï¼');
                loadCollections();
                dataCache.collections = null;
            } catch (err) {
                showToast('æ”¶è—å¤±è´¥: ' + err.message, 'error');
            }
        }

        async function toggleCollect(el, question, answer) {
            if (!currentUser || currentUser.is_admin) {
                showToast('ç®¡ç†å‘˜æ— æ”¶è—åŠŸèƒ½', 'error');
                return;
            }
            
            const decodedQuestion = question.replace(/\\'/g, "'").replace(/&quot;/g, '"');
            const decodedAnswer = answer.replace(/\\'/g, "'").replace(/&quot;/g, '"');
            
            // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
            const { data: existing } = await supabase
                .from('collections')
                .select('id')
                .eq('user_id', currentUser.id)
                .eq('title', decodedQuestion.substring(0, 50))
                .single();
            
            if (existing) {
                // å–æ¶ˆæ”¶è—
                await supabase.from('collections').delete().eq('id', existing.id);
                el.classList.remove('active');
                showToast('å–æ¶ˆæ”¶è—');
            } else {
                // æ·»åŠ æ”¶è—
                await supabase.from('collections').insert({
                    user_id: currentUser.id,
                    type: 'é—®ç­”',
                    title: decodedQuestion.substring(0, 50),
                    content: decodedAnswer,
                    created_at: new Date().toISOString()
                });
                el.classList.add('active');
                showToast('æ”¶è—æˆåŠŸï¼');
            }
            
            loadCollections();
            dataCache.collections = null;
        }

        async function loadCollections() {
            if (!currentUser || currentUser.is_admin) return;
            
            if (dataCache.collections) {
                renderCollections(dataCache.collections);
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('collections')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                dataCache.collections = data;
                renderCollections(data);
            } catch (error) {
                console.error('åŠ è½½æ”¶è—å¤±è´¥:', error);
            }
        }

        function renderCollections(data) {
            const div = document.getElementById('collectionBox');
            if (!div) return;
            
            if (!data || data.length === 0) {
                div.innerHTML = `<div class="text-center text-gray-400 py-8" id="emptyCollection"><i class="fa fa-star-o text-3xl mb-2"></i><p>æš‚æ— æ”¶è—ï¼Œç‚¹å‡»å›ç­”æ—â­æ”¶è—</p></div>`;
                return;
            }
            
            div.innerHTML = data.map(item => `
                <div class="p-3 border-b border-gray-100 last:border-0">
                    <div class="font-medium text-primary">${item.title}</div>
                    <div class="mt-1 text-gray-600 text-sm">${item.content}</div>
                    <button class="mt-2 text-xs text-red-500" onclick="deleteCollect('${item.id}')">åˆ é™¤</button>
                </div>
            `).join('');
        }

        async function deleteCollect(id) {
            try {
                await supabase.from('collections').delete().eq('id', id);
                showToast('å·²åˆ é™¤æ”¶è—');
                loadCollections();
                dataCache.collections = null;
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== åŠ è½½é—®ç­”å†å² ==========
        async function loadQAHistory() {
            if (!currentUser || currentUser.is_admin) return;
            
            try {
                const { data, error } = await supabase
                    .from('qa_logs')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                DOM.chatBox.innerHTML = '';
                
                if (!data || data.length === 0) {
                    DOM.chatBox.innerHTML = `<div class="text-center text-gray-400 py-8"><i class="fa fa-comment-o text-3xl mb-2"></i><p>è¾“å…¥é—®é¢˜ï¼Œè·å–ä¸“ä¸šå›ç­”</p><p class="text-xs mt-2">ä¸“æ³¨äºä¸‰æ±Ÿæºç”Ÿæ€ä¿æŠ¤ç›¸å…³é—®é¢˜</p></div>`;
                    return;
                }
                
                data.reverse().forEach(item => {
                    const time = new Date(item.created_at).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    
                    const userHtml = `<div class="qa-item-user"><div class="qa-content-user"><div class="text-sm text-gray-500">æˆ‘ ${time}</div><div class="mt-1">${item.question}</div></div></div>`;
                    DOM.chatBox.insertAdjacentHTML('beforeend', userHtml);
                    
                    // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
                    const { data: existing } = supabase
                        .from('collections')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('title', item.question.substring(0, 50))
                        .single();
                    
                    const collectClass = existing ? 'collect-btn active' : 'collect-btn';
                    const safeQuestion = item.question.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeAnswer = item.answer.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    const answerHtml = `<div class="qa-item-bot"><div class="qa-content-bot"><div class="text-sm text-gray-500">æ™ºèƒ½åŠ©æ‰‹ ${time}</div><div class="mt-1">${item.answer}</div><i class="fa fa-star ${collectClass}" onclick="toggleCollect(this,'${safeQuestion}','${safeAnswer}')"></i></div></div>`;
                    DOM.chatBox.insertAdjacentHTML('beforeend', answerHtml);
                });
                
                DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
                
            } catch (error) {
                console.error('åŠ è½½é—®ç­”å†å²å¤±è´¥:', error);
            }
        }

        // ========== åˆå§‹åŒ– ==========
        async function initApp() {
            // ç»‘å®šäº‹ä»¶
            DOM.loginTab?.addEventListener('click', () => switchTab('login'));
            DOM.registerTab?.addEventListener('click', () => switchTab('register'));
            DOM.loginBtn?.addEventListener('click', login);
            DOM.regBtn?.addEventListener('click', register);
            
            // ä¸ºè¾“å…¥æ¡†æ·»åŠ Enteré”®æ”¯æŒ
            document.getElementById('loginPwd')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('regConfirmPwd')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
            
            DOM.questionInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') askQuestion();
            });
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆå¯ä»¥ä»localStorageæ¢å¤ï¼‰
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    await showMainApp();
                } catch (error) {
                    console.error('æ¢å¤ç”¨æˆ·ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                    localStorage.removeItem('currentUser');
                }
            }
            
            // é¡µé¢å¸è½½æ—¶ä¿å­˜ç™»å½•çŠ¶æ€
            window.addEventListener('beforeunload', function() {
                if (currentUser) {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
